<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººç”Ÿè„šæœ¬ v2 - å‰§æœ¬æ—¶é—´ç®¡ç†</title>
    <style>
        :root {
            --bg: #F9FBFB;
            --text: #333;
            --sub: #999;
            --accent: #6C5CE7;
            --health: #AECBFA;
            --family: #FDE293;
            --work: #CCF0DF;
            --growth: #D4BBFF;
            --success: #D4F4DD;
            --danger: #F8D7DA;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #eee;
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent);
            margin: 0 0 5px 0;
        }
        .header-tagline {
            font-size: 12px;
            color: var(--sub);
            margin: 0 0 10px 0;
        }
        .week-info {
            font-size: 12px;
            color: var(--text);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #eee;
            overflow-x: auto;
        }
        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--sub);
            border-bottom: 3px solid transparent;
            transition: 0.2s;
            white-space: nowrap;
            font-size: 13px;
        }
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .tab-btn.tools {
            margin-left: auto;
            flex: 0 0 auto;
            color: #666;
        }
        .tab-btn.tools:hover {
            color: var(--accent);
        }

        .container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .view { display: none; }
        .view.active { display: block; }

        /* ===== å‘¨è®¡åˆ’è§†å›¾ ===== */
        .week-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            font-size: 11px;
        }
        .week-table th, .week-table td {
            border: 1px solid #eee;
            padding: 6px;
            text-align: center;
            height: 30px;
        }
        .week-table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        .week-cell {
            cursor: pointer;
            transition: 0.2s;
        }
        .week-cell:hover {
            opacity: 0.8;
        }
        .task-health { background: var(--health); }
        .task-family { background: var(--family); }
        .task-work { background: var(--work); }
        .task-growth { background: var(--growth); }

        /* ===== ä»Šæ—¥æ‰“å¡ ===== */
        .today-grid {
            display: grid;
            gap: 10px;
        }
        .time-slot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 10px;
            border: 1px solid #eee;
            cursor: pointer;
        }
        .time-slot:hover {
            border-color: var(--accent);
        }
        .slot-info { flex: 1; }
        .slot-time {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .slot-tag {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #f0f0f0;
        }
        .slot-status {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }
        .slot-status.done { background: var(--success); border-color: #4caf50; }
        .slot-status.fail { background: var(--danger); border-color: #dc3545; }

        /* ===== å‘¨å®¡è§† ===== */
        .stats-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
        }
        .stats-box h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
        }
        .category-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        .category-stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .category-stat-value {
            font-weight: 600;
            font-size: 16px;
        }
        .completion-rate {
            font-size: 12px;
            color: var(--sub);
        }
        .insight-text {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            margin-top: 15px;
            font-size: 13px;
        }

        /* ===== å‘¨å®¡è§†è¡¨æ ¼ ===== */
        .review-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            font-size: 11px;
            margin-bottom: 20px;
        }
        .review-table th, .review-table td {
            border: 1px solid #eee;
            padding: 6px;
            text-align: center;
            height: 30px;
        }
        .review-table th {
            background: #f5f5f5;
        }
        .review-cell {
            background: #f0f0f0;
        }
        .review-cell.done {
            background: var(--success);
        }
        .review-cell.fail {
            background: var(--danger);
        }

        /* ===== å¤ç›˜æ€è€ƒ ===== */
        .review-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }
        .review-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .review-section textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
        }
        .review-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-analyze, .btn-save {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-analyze {
            background: var(--accent);
            color: white;
        }
        .btn-save {
            background: #eee;
        }
        .analysis-result {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--work);
            line-height: 1.6;
            white-space: pre-wrap;
            display: none;
            font-size: 13px;
        }

        /* ===== æ¨¡æ€æ¡† ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-box h3 {
            margin: 0 0 15px 0;
        }
        .category-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .cat-btn {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 12px;
        }
        .cat-btn.selected {
            border-color: var(--accent);
            background: rgba(108, 92, 231, 0.1);
        }
        .category-hint {
            font-size: 11px;
            color: var(--sub);
            margin-bottom: 10px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 6px;
        }
        .tag-history {
            margin-bottom: 10px;
            display: none;
        }
        .tag-history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .tag-history-btn {
            padding: 4px 10px;
            background: #eee;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }
        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-confirm {
            background: var(--accent);
            color: white;
        }
        .btn-cancel {
            background: #eee;
        }

        /* ===== å¯¼å…¥å¯¼å‡º ===== */
        .io-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .io-btn {
            padding: 10px 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }
        .io-btn:hover {
            background: #f5f5f5;
        }
        #import-file {
            display: none;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-title">äººç”Ÿè„šæœ¬ v2</div>
    <div class="header-tagline">ä½ æ˜¯ä½ äººç”Ÿçš„å¯¼æ¼” Â· æ¯ä¸€å¤©éƒ½è¦ç²¾å½©çš„æ´»</div>
    <div class="week-info" id="week-info">
        <span>2026å¹´ç¬¬2å‘¨ Â· 1æœˆ6æ—¥ ~ 1æœˆ12æ—¥</span>
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('plan')">ğŸ“… å‘¨è®¡åˆ’</button>
        <button class="tab-btn" onclick="switchTab('today')">âœ… ä»Šæ—¥æ‰“å¡</button>
        <button class="tab-btn" onclick="switchTab('review')">ğŸ“Š å‘¨å®¡è§†</button>
        <button class="tab-btn" onclick="switchTab('reflect')">ğŸ“ å¤ç›˜æ€è€ƒ</button>
        <button class="tab-btn tools" onclick="showTools()">âš™ï¸ å·¥å…·</button>
    </div>
</div>

<div class="container">
    <!-- å‘¨è®¡åˆ’ -->
    <div class="view active" id="plan-view">
        <div style="margin-bottom: 15px; display: none;" id="quick-fill-bar">
            <div style="background: white; padding: 12px; border-radius: 10px; border-left: 4px solid var(--accent);">
                <div style="font-size: 12px; color: var(--sub); margin-bottom: 8px;">âœ¨ å¿«é€Ÿæ’ç­æ¨¡å¼</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="quick-fill-tag" style="font-weight: 600;">å·²é€‰æ‹©ï¼š</span>
                    <button style="padding: 6px 12px; background: #eee; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px;" onclick="exitQuickFill()">âœ• é€€å‡ºå¿«é€Ÿæ¨¡å¼</button>
                    <button style="padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: auto;" onclick="confirmQuickFill()">âœ“ ç¡®è®¤å¡«å……</button>
                </div>
            </div>
        </div>
        <table class="week-table" id="week-table">
            <tr>
                <th>æ—¶é—´</th>
                <th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th><th>å‘¨æ—¥</th>
            </tr>
        </table>
    </div>

    <!-- ä»Šæ—¥æ‰“å¡ -->
    <div class="view" id="today-view">
        <div style="margin-bottom: 15px; background: white; padding: 12px; border-radius: 10px;">
            <div style="font-size: 12px; color: var(--sub); margin-bottom: 8px;">ğŸ“… é€‰æ‹©æ—¥æœŸ</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="date-btn active" onclick="switchCheckinDay(-1)" style="padding: 8px 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px;">ğŸ“ ä»Šæ—¥</button>
                <button class="date-btn" onclick="switchCheckinDay(0)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨ä¸€</button>
                <button class="date-btn" onclick="switchCheckinDay(1)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨äºŒ</button>
                <button class="date-btn" onclick="switchCheckinDay(2)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨ä¸‰</button>
                <button class="date-btn" onclick="switchCheckinDay(3)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨å››</button>
                <button class="date-btn" onclick="switchCheckinDay(4)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨äº”</button>
                <button class="date-btn" onclick="switchCheckinDay(5)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨å…­</button>
                <button class="date-btn" onclick="switchCheckinDay(6)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨æ—¥</button>
            </div>
        </div>
        <div class="today-grid" id="today-grid"></div>
    </div>

    <!-- å‘¨å®¡è§† -->
    <div class="view" id="review-view">
        <table class="review-table" id="review-table">
            <tr>
                <th>æ—¶é—´</th>
                <th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th><th>å‘¨æ—¥</th>
            </tr>
        </table>

        <div class="stats-box">
            <h3>ğŸ“Š æœ¬å‘¨æ•°æ®åˆ†æ</h3>
            <div id="stats-content"></div>
        </div>

        <div class="stats-box">
            <h3>ğŸ’¡ AIæ´å¯Ÿ</h3>
            <div id="ai-insight" class="insight-text">å®Œæˆä¸€äº›ä»»åŠ¡åä¼šæ˜¾ç¤º</div>
        </div>
    </div>

    <!-- å¤ç›˜æ€è€ƒ -->
    <div class="view" id="reflect-view">
        <div class="review-section">
            <h3>âœ… æœ¬å‘¨åšå¾—å¾ˆå¥½çš„äº‹</h3>
            <textarea id="review-good" placeholder="ä¾‹å¦‚ï¼šåšæŒæ™¨è·‘..."></textarea>
        </div>
        <div class="review-section">
            <h3>âŒ æœ¬å‘¨æ²¡åšå¥½çš„åœ°æ–¹</h3>
            <textarea id="review-bad" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«æ²¡æœ‰é™ªä¼´å®¶äºº..."></textarea>
        </div>
        <div class="review-section">
            <h3>ğŸ’¡ ä¸‹å‘¨çš„æ”¹è¿›è®¡åˆ’</h3>
            <textarea id="review-next" placeholder="ä¾‹å¦‚ï¼šè°ƒæ•´æ—¶é—´å®‰æ’..."></textarea>
        </div>
        <div class="review-buttons">
            <button class="btn-analyze" onclick="generateAnalysis()">âœ¨ ç”Ÿæˆå®Œæ•´åˆ†æ</button>
        </div>
        <div class="analysis-result" id="analysis-result"></div>
    </div>

    <!-- å·¥å…·é¢æ¿ -->
    <div class="view" id="tools-view">
        <div class="io-buttons">
            <button class="io-btn" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
            <button class="io-btn" onclick="document.getElementById('import-file').click()">ğŸ“¤ å¯¼å…¥æ•°æ®</button>
            <button class="io-btn" onclick="clearAllData()" style="color: #dc3545;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
        </div>
        <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
            <h3 style="margin-top: 0;">ä½¿ç”¨è¯´æ˜</h3>
            <p>âœ… <strong>å‘¨è®¡åˆ’</strong> - åˆ¶å®šæœ¬å‘¨çš„è®¡åˆ’ï¼Œç‚¹å‡»æ ¼å­æ·»åŠ ä»»åŠ¡</p>
            <p>âœ… <strong>ä»Šæ—¥æ‰“å¡</strong> - æ ‡è®°ä»Šå¤©çš„å®Œæˆæƒ…å†µï¼ˆâ­•è®¡åˆ’ä¸­ â†’ âœ…å·²å®Œæˆ â†’ âŒæœªå®Œæˆï¼‰</p>
            <p>âœ… <strong>å‘¨å®¡è§†</strong> - æŸ¥çœ‹æœ¬å‘¨çš„æ‰§è¡Œæƒ…å†µã€æ•°æ®åˆ†æå’ŒAIæ´å¯Ÿ</p>
            <p>âœ… <strong>å¤ç›˜æ€è€ƒ</strong> - åæ€ä¸æ€»ç»“ï¼Œç”Ÿæˆå®Œæ•´çš„å‘¨æŠ¥å‘Š</p>
            <p>âœ… <strong>å¯¼å…¥å¯¼å‡º</strong> - å¤‡ä»½å’Œæ¢å¤æ•°æ®ï¼Œæ”¯æŒå¤šè®¾å¤‡åŒæ­¥</p>
        </div>
    </div>
</div>

<!-- ä»»åŠ¡ç¼–è¾‘æ¨¡æ€ -->
<div class="modal" id="task-modal">
    <div class="modal-box">
        <h3>ç¼–è¾‘ä»»åŠ¡</h3>
        <h4 id="modal-time" style="color: var(--sub); margin: 0 0 15px 0;">å‘¨ä¸€ 7:00</h4>
        <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; display: block; margin-bottom: 8px;">é€‰æ‹©ç±»åˆ«</label>
            <div class="category-selector">
                <button class="cat-btn" onclick="selectCategory('health')">ğŸ”µ å¥åº·ä¹ æƒ¯</button>
                <button class="cat-btn" onclick="selectCategory('family')">ğŸŸ¡ å®¶åº­æ—¶é—´</button>
                <button class="cat-btn" onclick="selectCategory('work')">ğŸ’š å·¥ä½œæ—¶é—´</button>
                <button class="cat-btn" onclick="selectCategory('growth')">ğŸ’œ è‡ªæˆ‘æˆé•¿</button>
            </div>
        </div>
        <div class="category-hint" id="category-hint"></div>
        <div class="tag-history" id="tag-history">
            <div style="font-size: 11px; color: var(--sub); margin-bottom: 6px;">ğŸ“š ä½ ä¹‹å‰ç”¨è¿‡çš„æ ‡ç­¾</div>
            <div class="tag-history-list" id="tag-history-list"></div>
        </div>
        <input type="text" class="modal-input" id="task-tag" placeholder="è¾“å…¥æ´»åŠ¨æ ‡ç­¾">
        <div class="modal-buttons">
            <button class="btn-confirm" onclick="saveTask()">âœ“ ç¡®è®¤</button>
            <button style="flex: 1; padding: 10px; background: var(--work); color: white; border: none; border-radius: 8px; cursor: pointer;" onclick="enterQuickFill()">âš¡ å¿«é€Ÿæ’ç­</button>
            <button class="btn-cancel" onclick="closeModal()">âœ• å–æ¶ˆ</button>
        </div>
    </div>
</div>

<input type="file" id="import-file" accept=".json" onchange="importData(event)">

<script>
const HOURS = Array.from({length: 17}, (_, i) => i + 7);
const DAYS = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
const CATEGORIES = {
    health: { name: 'å¥åº·ä¹ æƒ¯', emoji: 'ğŸ”µ', hint: 'ğŸ­ æ‡’è™« | è·‘æ­¥ç‹‚ | ç‘œä¼½ä»™å¥³ | å†¥æƒ³è€… | ç¡çœ å«å£«' },
    family: { name: 'å®¶åº­æ—¶é—´', emoji: 'ğŸŸ¡', hint: 'ğŸ­ é™ªä¼´ä¾  | å®¶åŠ¡å«å£« | å¥¶çˆ¸å¥¶å¦ˆ | åšé¥­å¤§å¨ | æ•…äº‹è®²è¿°è€…' },
    work: { name: 'å·¥ä½œæ—¶é—´', emoji: 'ğŸ’š', hint: 'ğŸ­ æ‰“å·¥ç‹— | å†™ä½œå®¶ | ä»£ç ä¾  | ä¼šè®®è¾¾äºº | é¡¹ç›®ç»ç†' },
    growth: { name: 'è‡ªæˆ‘æˆé•¿', emoji: 'ğŸ’œ', hint: 'ğŸ­ é˜…è¯»è™« | æ€è€ƒè€… | å­¦ä¹ è€… | æ—¥è®°ä½œå®¶ | çŸ¥è¯†çŒäºº' }
};

let weekData = { tasks: {}, review: { good: '', bad: '', next: '' } };
let tagCategoryMap = {}; // è®°å½•æ ‡ç­¾å¯¹åº”çš„ç±»åˆ«
let tagHistory = { health: [], family: [], work: [], growth: [] };
let selectedCategory = null;
let selectedSlot = null;
let quickFillMode = false;
let quickFillData = null;
let checkinDay = -1; // -1 è¡¨ç¤ºä»Šæ—¥ï¼Œ0-6 è¡¨ç¤ºå‘¨ä¸€åˆ°å‘¨æ—¥

// åˆå§‹åŒ–
function init() {
    loadData();
    updateWeekInfo();
    renderWeekPlan();
    renderTodayView();
    renderWeekReview();
    loadReviewData();
}

function loadData() {
    const stored = localStorage.getItem('life-script-data');
    if (stored) {
        const data = JSON.parse(stored);
        weekData = data.weekData || weekData;
        tagCategoryMap = data.tagCategoryMap || tagCategoryMap;
        tagHistory = data.tagHistory || tagHistory;
    }
}

function saveData() {
    const data = { weekData, tagCategoryMap, tagHistory };
    localStorage.setItem('life-script-data', JSON.stringify(data));
}

function updateWeekInfo() {
    const now = new Date();
    const year = now.getFullYear();
    const firstDay = new Date(year, 0, 1);
    const pastDaysOfYear = (now - firstDay) / 86400000;
    const week = Math.ceil((pastDaysOfYear + firstDay.getDay() + 1) / 7);
    
    const dayOfWeek = now.getDay() || 7;
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - dayOfWeek + 1);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);

    const startMonth = weekStart.getMonth() + 1;
    const startDate = weekStart.getDate();
    const endMonth = weekEnd.getMonth() + 1;
    const endDate = weekEnd.getDate();

    document.getElementById('week-info').textContent = 
        `${year}å¹´ç¬¬${week}å‘¨ Â· ${startMonth}æœˆ${startDate}æ—¥ ~ ${endMonth}æœˆ${endDate}æ—¥`;
}

function switchTab(tab) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    const viewMap = {
        plan: 'plan-view',
        today: 'today-view',
        review: 'review-view',
        reflect: 'reflect-view',
        tools: 'tools-view'
    };
    
    if (viewMap[tab]) {
        document.getElementById(viewMap[tab]).classList.add('active');
        document.querySelector(`.tab-btn[onclick*="'${tab}'"]`).classList.add('active');
    }
}

function showTools() {
    switchTab('tools');
}

function renderWeekPlan() {
    let html = '<tr><th>æ—¶é—´</th>';
    DAYS.forEach(d => html += `<th>${d}</th>`);
    html += '</tr>';
    
    HOURS.forEach(hour => {
        html += `<tr><td style="background: #f5f5f5; font-weight: 500;">${hour}:00</td>`;
        for (let day = 0; day < 7; day++) {
            const key = `${day}-${hour}`;
            const task = weekData.tasks[key];
            if (task) {
                html += `<td class="week-cell task-${task.category}" onclick="handleWeekCellClick(${day}, ${hour})">${task.tag}</td>`;
            } else {
                html += `<td class="week-cell" onclick="handleWeekCellClick(${day}, ${hour})"></td>`;
            }
        }
        html += '</tr>';
    });
    document.getElementById('week-table').innerHTML = html;
}

function handleWeekCellClick(day, hour) {
    if (quickFillMode) {
        // å¿«é€Ÿæ’ç­æ¨¡å¼ï¼šç‚¹å‡»å¡«å……
        const key = `${day}-${hour}`;
        weekData.tasks[key] = { 
            category: quickFillData.category, 
            tag: quickFillData.tag, 
            status: 'plan' 
        };
        renderWeekPlan();
    } else {
        // æ™®é€šæ¨¡å¼ï¼šæ‰“å¼€ç¼–è¾‘æ¡†
        openEditModal(day, hour);
    }
}

function renderWeekReview() {
    let html = '<tr><th>æ—¶é—´</th>';
    DAYS.forEach(d => html += `<th>${d}</th>`);
    html += '</tr>';
    
    HOURS.forEach(hour => {
        html += `<tr><td style="background: #f5f5f5;">${hour}:00</td>`;
        for (let day = 0; day < 7; day++) {
            const key = `${day}-${hour}`;
            const task = weekData.tasks[key];
            let cellClass = 'review-cell';
            let content = '';
            
            if (task) {
                if (task.status === 'done') {
                    cellClass = 'review-cell done';
                    content = 'âœ…';
                } else if (task.status === 'fail') {
                    cellClass = 'review-cell fail';
                    content = 'âŒ';
                } else {
                    cellClass = 'review-cell';
                    content = 'â­•';
                }
            }
            html += `<td class="${cellClass}">${content}</td>`;
        }
        html += '</tr>';
    });
    document.getElementById('review-table').innerHTML = html;
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    updateStats();
}

function updateStats() {
    const stats = {
        health: { total: 0, done: 0 },
        family: { total: 0, done: 0 },
        work: { total: 0, done: 0 },
        growth: { total: 0, done: 0 }
    };

    Object.entries(weekData.tasks).forEach(([key, task]) => {
        if (stats[task.category]) {
            stats[task.category].total++;
            if (task.status === 'done') {
                stats[task.category].done++;
            }
        }
    });

    let html = '';
    let totalTasks = 0;
    let totalDone = 0;

    Object.entries(stats).forEach(([cat, data]) => {
        totalTasks += data.total;
        totalDone += data.done;
        const percentage = data.total > 0 ? Math.round((data.done / data.total) * 100) : 0;
        html += `
            <div class="category-stat">
                <div class="category-stat-label">
                    <span>${CATEGORIES[cat].emoji}</span>
                    <span>${CATEGORIES[cat].name}</span>
                </div>
                <div style="text-align: right;">
                    <div class="category-stat-value">${percentage}%</div>
                    <div class="completion-rate">${data.done}/${data.total}</div>
                </div>
            </div>
        `;
    });

    document.getElementById('stats-content').innerHTML = html;

    // ç”ŸæˆAIæ´å¯Ÿ
    generateInsight(stats, totalTasks, totalDone);
}

function generateInsight(stats, totalTasks, totalDone) {
    if (totalTasks === 0) {
        document.getElementById('ai-insight').textContent = 'è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œèµ¶å¿«è§„åˆ’ä½ çš„ä¸€å‘¨å§ï¼';
        return;
    }

    const overallRate = Math.round((totalDone / totalTasks) * 100);
    const categories = Object.entries(stats).sort((a, b) => {
        const rateA = a[1].total > 0 ? (a[1].done / a[1].total) * 100 : 0;
        const rateB = b[1].total > 0 ? (b[1].done / b[1].total) * 100 : 0;
        return rateB - rateA;
    });

    let insight = `ğŸ“Š ä½ çš„æœ¬å‘¨æˆç»©ï¼š${overallRate}%\n\n`;

    // æœ€é«˜åˆ†ç±»åˆ«
    const top = categories[0];
    if (top[1].total > 0) {
        const topRate = Math.round((top[1].done / top[1].total) * 100);
        if (topRate === 100) {
            insight += `âœ¨ å®Œç¾ï¼${CATEGORIES[top[0]].name}å®Œæˆç‡100%ï¼Œä½ çœŸæ˜¯ä¸ªè¡ŒåŠ¨åŠ›æ»¡æ»¡çš„äººï¼\n\n`;
        } else if (topRate >= 80) {
            insight += `ğŸŒŸ ${CATEGORIES[top[0]].name}çš„æ‰§è¡Œç‡æœ€é«˜ï¼ˆ${topRate}%ï¼‰ï¼Œä¿æŒè¿™ä¸ªåŠ¿å¤´ï¼\n\n`;
        }
    }

    // æ—¶é—´å æ¯”åˆ†æ
    const totalHours = Object.values(stats).reduce((sum, s) => sum + s.total, 0);
    insight += 'â° æœ¬å‘¨æ—¶é—´åˆ†é…ï¼š\n';
    Object.entries(stats).forEach(([cat, data]) => {
        if (data.total > 0) {
            const percent = Math.round((data.total / totalHours) * 100);
            insight += `  â€¢ ${CATEGORIES[cat].name}ï¼š${percent}%\n`;
        }
    });

    // ä¸ªæ€§è¯„ä»·
    const workPercent = stats.work.total > 0 ? Math.round((stats.work.total / totalHours) * 100) : 0;
    const healthPercent = stats.health.total > 0 ? Math.round((stats.health.total / totalHours) * 100) : 0;
    const growthPercent = stats.growth.total > 0 ? Math.round((stats.growth.total / totalHours) * 100) : 0;

    insight += '\nğŸ’¡ å¯¼æ¼”çš„è¯„è¯­ï¼š\n';
    if (workPercent > 50) {
        insight += `ä½ å¯çœŸæ˜¯ä¸ª"åŠ ç­ç‹‚"ï¼Œå·¥ä½œå æ¯”${workPercent}%ï¼è®°å¾—ä¹Ÿè¦å…³ç…§èº«ä½“å’Œå®¶åº­å“¦ã€‚`;
    } else if (healthPercent > 40) {
        insight += `ä½ æ˜¯ä¸ª"å¥èº«è¾¾äºº"ï¼Œå¯¹èº«ä½“å¾ˆç”¨å¿ƒï¼ç»§ç»­ä¿æŒï¼Œä½†ä¹Ÿè¦æ³¨é‡å·¥ä½œæˆé•¿ã€‚`;
    } else if (growthPercent > 40) {
        insight += `ä½ æ˜¯ä¸ª"å­¦ä¹ ç‹‚é­”"ï¼Œè‡ªæˆ‘æå‡å¾ˆç§¯æï¼æ£’æäº†ï¼Œè¿™å°±æ˜¯æˆé•¿çš„æ ·å­ã€‚`;
    } else {
        insight += `æ—¶é—´åˆ†é…å¾ˆå‡è¡¡ï¼Œä½ çœŸæ˜¯ä¸ªæœ‰"å‰§æœ¬æ„è¯†"çš„å¯¼æ¼”ï¼`;
    }

    document.getElementById('ai-insight').textContent = insight;
}

function renderTodayView() {
    const now = new Date();
    let dayIndex = checkinDay === -1 ? (now.getDay() || 7) - 1 : checkinDay;
    
    let html = '';
    
    HOURS.forEach(hour => {
        const key = `${dayIndex}-${hour}`;
        const task = weekData.tasks[key];
        if (task) {
            const statusClass = task.status === 'done' ? 'done' : task.status === 'fail' ? 'fail' : '';
            const status = task.status === 'done' ? 'âœ…' : task.status === 'fail' ? 'âŒ' : 'â­•';
            html += `
                <div class="time-slot">
                    <div class="slot-info">
                        <div class="slot-time">${hour}:00</div>
                        <div>${CATEGORIES[task.category].emoji} <span class="slot-tag">${task.tag}</span></div>
                    </div>
                    <div class="slot-status ${statusClass}" onclick="toggleStatus('${key}')">${status}</div>
                </div>
            `;
        } else {
            html += `
                <div class="time-slot" onclick="openEditModal(${dayIndex}, ${hour})">
                    <div class="slot-info">
                        <div class="slot-time">${hour}:00</div>
                        <div style="color: #ccc;">æœªå®‰æ’</div>
                    </div>
                    <div style="color: #999;">+</div>
                </div>
            `;
        }
    });
    document.getElementById('today-grid').innerHTML = html;
}

function toggleStatus(key) {
    const task = weekData.tasks[key];
    const statuses = ['plan', 'done', 'fail'];
    const idx = statuses.indexOf(task.status || 'plan');
    task.status = statuses[(idx + 1) % 3];
    saveData();
    renderWeekPlan();
    renderTodayView();
    renderWeekReview();
}

function openEditModal(day, hour) {
    selectedSlot = { day, hour };
    const key = `${day}-${hour}`;
    const task = weekData.tasks[key];
    
    document.getElementById('modal-time').textContent = `${DAYS[day]} ${hour}:00`;
    document.getElementById('task-tag').value = task ? task.tag : '';
    
    selectedCategory = task ? task.category : null;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
    
    if (selectedCategory) {
        const buttons = Array.from(document.querySelectorAll('.cat-btn'));
        const catKeys = Object.keys(CATEGORIES);
        const idx = catKeys.indexOf(selectedCategory);
        if (idx >= 0 && buttons[idx]) {
            buttons[idx].classList.add('selected');
            updateCategoryHint(selectedCategory);
        }
    }
    document.getElementById('task-modal').classList.add('show');
}

function selectCategory(cat) {
    selectedCategory = cat;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
    
    const buttons = Array.from(document.querySelectorAll('.cat-btn'));
    const catKeys = Object.keys(CATEGORIES);
    const idx = catKeys.indexOf(cat);
    if (idx >= 0 && buttons[idx]) {
        buttons[idx].classList.add('selected');
    }
    
    updateCategoryHint(cat);
    updateTagHistory(cat);
}

function selectKnownTag(tag) {
    // è‡ªåŠ¨æ£€æµ‹æ ‡ç­¾å¯¹åº”çš„ç±»åˆ«
    if (tagCategoryMap[tag]) {
        selectedCategory = tagCategoryMap[tag];
        // è‡ªåŠ¨é€‰ä¸­å¯¹åº”çš„ç±»åˆ«æŒ‰é’®
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
        const buttons = Array.from(document.querySelectorAll('.cat-btn'));
        const catKeys = Object.keys(CATEGORIES);
        const idx = catKeys.indexOf(selectedCategory);
        if (idx >= 0 && buttons[idx]) {
            buttons[idx].classList.add('selected');
        }
        updateCategoryHint(selectedCategory);
    }
    // å¡«å……æ ‡ç­¾å€¼
    document.getElementById('task-tag').value = tag;
    document.getElementById('task-tag').focus();
}

function updateCategoryHint(cat) {
    document.getElementById('category-hint').textContent = CATEGORIES[cat].hint;
}

function updateTagHistory(cat) {
    const history = tagHistory[cat] || [];
    const historyDiv = document.getElementById('tag-history');
    if (history.length > 0) {
        historyDiv.style.display = 'block';
        let html = '';
        history.slice(-5).reverse().forEach(tag => {
            html += `<button class="tag-history-btn" onclick="selectKnownTag('${tag.replace(/'/g, "\\'")}')">${tag}</button>`;
        });
        document.getElementById('tag-history-list').innerHTML = html;
    } else {
        historyDiv.style.display = 'none';
    }
}

function saveTask() {
    const tag = document.getElementById('task-tag').value.trim();
    if (!tag) {
        alert('è¯·è¾“å…¥æ´»åŠ¨æ ‡ç­¾');
        return;
    }
    
    // å¦‚æœæ ‡ç­¾å·²çŸ¥ï¼Œè‡ªåŠ¨è¯†åˆ«ç±»åˆ«
    let category = selectedCategory;
    if (!category && tagCategoryMap[tag]) {
        category = tagCategoryMap[tag];
    }
    
    if (!category) {
        alert('è¯·é€‰æ‹©ç±»åˆ«');
        return;
    }
    
    // è®°å½•æ ‡ç­¾-ç±»åˆ«å¯¹åº”
    tagCategoryMap[tag] = category;
    
    // æ›´æ–°æ ‡ç­¾å†å²
    if (!tagHistory[category]) tagHistory[category] = [];
    tagHistory[category] = tagHistory[category].filter(t => t !== tag);
    tagHistory[category].push(tag);
    if (tagHistory[category].length > 20) tagHistory[category].shift();
    
    const key = `${selectedSlot.day}-${selectedSlot.hour}`;
    weekData.tasks[key] = { category: category, tag, status: 'plan' };
    saveData();
    renderWeekPlan();
    renderTodayView();
    renderWeekReview();
    closeModal();
}

function closeModal() {
    document.getElementById('task-modal').classList.remove('show');
}

function enterQuickFill() {
    const tag = document.getElementById('task-tag').value.trim();
    if (!tag) {
        alert('è¯·è¾“å…¥æ´»åŠ¨æ ‡ç­¾');
        return;
    }
    
    let category = selectedCategory;
    if (!category && tagCategoryMap[tag]) {
        category = tagCategoryMap[tag];
    }
    
    if (!category) {
        alert('è¯·é€‰æ‹©ç±»åˆ«');
        return;
    }
    
    quickFillMode = true;
    quickFillData = { tag, category };
    
    // è®°å½•æ ‡ç­¾-ç±»åˆ«å¯¹åº”
    tagCategoryMap[tag] = category;
    
    // æ›´æ–°æ ‡ç­¾å†å²
    if (!tagHistory[category]) tagHistory[category] = [];
    tagHistory[category] = tagHistory[category].filter(t => t !== tag);
    tagHistory[category].push(tag);
    if (tagHistory[category].length > 20) tagHistory[category].shift();
    
    // æ˜¾ç¤ºå¿«é€Ÿæ’ç­æ¡
    document.getElementById('quick-fill-bar').style.display = 'block';
    document.getElementById('quick-fill-tag').textContent = `âœ¨ å¿«é€Ÿæ’ç­ï¼š${CATEGORIES[category].emoji} ${tag}`;
    
    // å…³é—­æ¨¡æ€æ¡†
    closeModal();
    
    // åˆ‡æ¢åˆ°å‘¨è®¡åˆ’è§†å›¾
    switchTab('plan');
}

function confirmQuickFill() {
    quickFillMode = false;
    saveData();
    renderWeekPlan();
    document.getElementById('quick-fill-bar').style.display = 'none';
}

function exitQuickFill() {
    quickFillMode = false;
    document.getElementById('quick-fill-bar').style.display = 'none';
    renderWeekPlan();
}

function switchCheckinDay(day) {
    checkinDay = day;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.date-btn').forEach((btn, idx) => {
        if ((day === -1 && idx === 0) || (day === idx - 1)) {
            btn.style.background = 'var(--accent)';
            btn.style.color = 'white';
        } else {
            btn.style.background = 'white';
            btn.style.color = 'var(--text)';
        }
    });
    
    renderTodayView();
}

function loadReviewData() {
    document.getElementById('review-good').value = weekData.review.good || '';
    document.getElementById('review-bad').value = weekData.review.bad || '';
    document.getElementById('review-next').value = weekData.review.next || '';
}

function generateAnalysis() {
    weekData.review.good = document.getElementById('review-good').value;
    weekData.review.bad = document.getElementById('review-bad').value;
    weekData.review.next = document.getElementById('review-next').value;
    saveData();
    
    const result = document.getElementById('analysis-result');
    result.textContent = 'âœ¨ ç”Ÿæˆåˆ†æä¸­...\n\näº²çˆ±çš„å¯¼æ¼”ï¼Œè¿™æ˜¯ä½ è¿™å‘¨çš„å®Œæ•´æ€»ç»“ï¼š\n\nğŸ“Š æ‰§è¡Œæ•°æ®ï¼š\n' + document.getElementById('ai-insight').textContent + '\n\nğŸ“ ä½ çš„åæ€ï¼š\nâœ… åšå¾—å¥½çš„ï¼š' + (weekData.review.good || '(æœªå¡«å†™)') + '\nâŒ ä¸è¶³ä¹‹å¤„ï¼š' + (weekData.review.bad || '(æœªå¡«å†™)') + '\nğŸ’¡ æ”¹è¿›è®¡åˆ’ï¼š' + (weekData.review.next || '(æœªå¡«å†™)') + '\n\nğŸ¬ å¯¼æ¼”çš„å»ºè®®ï¼š\nç»§ç»­ä¼˜åŒ–ä½ çš„äººç”Ÿè„šæœ¬ï¼Œæ¯å‘¨éƒ½æ˜¯æ–°çš„å¼€å§‹ã€‚ä¿æŒå¤ç›˜ä¹ æƒ¯ï¼ŒæŒç»­è¿­ä»£ï¼Œä½ ä¼šçœ‹åˆ°æ˜¾è‘—çš„æˆé•¿ï¼';
    result.style.display = 'block';
}

function exportData() {
    const data = { weekData, tagCategoryMap, tagHistory };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `life-script-${new Date().getTime()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            weekData = data.weekData || weekData;
            tagCategoryMap = data.tagCategoryMap || tagCategoryMap;
            tagHistory = data.tagHistory || tagHistory;
            saveData();
            
            renderWeekPlan();
            renderTodayView();
            renderWeekReview();
            loadReviewData();
            
            alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼');
        } catch (error) {
            alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + error.message);
        }
    };
    reader.readAsText(file);
}

function clearAllData() {
    if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™ä¸ªæ“ä½œæ— æ³•æ’¤é”€ï¼')) {
        weekData = { tasks: {}, review: { good: '', bad: '', next: '' } };
        tagCategoryMap = {};
        tagHistory = { health: [], family: [], work: [], growth: [] };
        localStorage.removeItem('life-script-data');
        
        renderWeekPlan();
        renderTodayView();
        renderWeekReview();
        loadReviewData();
        
        alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
    }
}

init();
</script>

</body>
</html>
