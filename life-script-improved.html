<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#6C5CE7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="äººç”Ÿè„šæœ¬">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/your-repo/icon.png">
    <title>äººç”Ÿè„šæœ¬ v2 - å‰§æœ¬æ—¶é—´ç®¡ç†</title>
    <style>
        :root {
            --bg: #F9FBFB;
            --text: #333;
            --sub: #999;
            --accent: #6C5CE7;
            --health: #AECBFA;
            --family: #FDE293;
            --work: #CCF0DF;
            --growth: #D4BBFF;
            --success: #D4F4DD;
            --danger: #F8D7DA;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #eee;
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent);
            margin: 0 0 5px 0;
        }
        .header-tagline {
            font-size: 12px;
            color: var(--sub);
            margin: 0 0 10px 0;
        }
        .week-info {
            font-size: 12px;
            color: var(--text);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #eee;
            overflow-x: auto;
        }
        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--sub);
            border-bottom: 3px solid transparent;
            transition: 0.2s;
            white-space: nowrap;
            font-size: 13px;
        }
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .tab-btn.tools {
            margin-left: auto;
            flex: 0 0 auto;
            color: #666;
        }
        .tab-btn.tools:hover {
            color: var(--accent);
        }

        .container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .view { display: none; }
        .view.active { display: block; }

        /* ===== å‘¨è®¡åˆ’è§†å›¾ ===== */
        .week-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            font-size: 11px;
        }
        .week-table th, .week-table td {
            border: 1px solid #eee;
            padding: 6px;
            text-align: center;
            height: 30px;
        }
        .week-table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        .week-cell {
            cursor: pointer;
            transition: 0.2s;
        }
        .week-cell:hover {
            opacity: 0.8;
        }
        .task-health { background: var(--health); }
        .task-family { background: var(--family); }
        .task-work { background: var(--work); }
        .task-growth { background: var(--growth); }

        /* ===== ä»Šæ—¥æ‰“å¡ ===== */
        .today-grid {
            display: grid;
            gap: 10px;
        }
        .time-slot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 10px;
            border: 1px solid #eee;
            cursor: pointer;
        }
        .time-slot:hover {
            border-color: var(--accent);
        }
        .slot-info { flex: 1; }
        .slot-time {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .slot-tag {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #f0f0f0;
        }
        .slot-status {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }
        .slot-status.done { background: var(--success); border-color: #4caf50; }
        .slot-status.fail { background: var(--danger); border-color: #dc3545; }

        /* ===== å‘¨å®¡è§† ===== */
        .stats-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
        }
        .stats-box h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
        }
        .category-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        .category-stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .category-stat-value {
            font-weight: 600;
            font-size: 16px;
        }
        .completion-rate {
            font-size: 12px;
            color: var(--sub);
        }
        .insight-text {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            margin-top: 15px;
            font-size: 13px;
        }

        /* ===== å‘¨å®¡è§†è¡¨æ ¼ ===== */
        .review-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            font-size: 11px;
            margin-bottom: 20px;
        }
        .review-table th, .review-table td {
            border: 1px solid #eee;
            padding: 6px;
            text-align: center;
            height: 30px;
        }
        .review-table th {
            background: #f5f5f5;
        }
        .review-cell {
            background: #f0f0f0;
        }
        .review-cell.done {
            background: var(--success);
        }
        .review-cell.fail {
            background: var(--danger);
        }

        /* ===== å¤ç›˜æ€è€ƒ ===== */
        .review-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }
        .review-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .review-section textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
        }
        .review-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-analyze, .btn-save {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-analyze {
            background: var(--accent);
            color: white;
        }
        .btn-save {
            background: #eee;
        }
        .analysis-result {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--work);
            line-height: 1.6;
            white-space: pre-wrap;
            display: none;
            font-size: 13px;
        }

        /* ===== æ¨¡æ€æ¡† ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-box h3 {
            margin: 0 0 15px 0;
        }
        .category-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .cat-btn {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 12px;
        }
        .cat-btn.selected {
            border-color: var(--accent);
            background: rgba(108, 92, 231, 0.1);
        }
        .category-hint {
            font-size: 11px;
            color: var(--sub);
            margin-bottom: 10px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 6px;
        }
        .tag-history {
            margin-bottom: 10px;
            display: none;
        }
        .tag-history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .tag-history-btn {
            padding: 4px 10px;
            background: #eee;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }
        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-confirm {
            background: var(--accent);
            color: white;
        }
        .btn-cancel {
            background: #eee;
        }

        /* ===== å¯¼å…¥å¯¼å‡º ===== */
        .io-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .io-btn {
            padding: 10px 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }
        .io-btn:hover {
            background: #f5f5f5;
        }
        #import-file {
            display: none;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-title">äººç”Ÿè„šæœ¬ v2</div>
    <div class="header-tagline">ä½ æ˜¯ä½ äººç”Ÿçš„å¯¼æ¼” Â· æ¯ä¸€å¤©éƒ½è¦ç²¾å½©çš„æ´»</div>
    <div class="week-info" id="week-info">
        <span>2026å¹´ç¬¬2å‘¨ Â· 1æœˆ6æ—¥ ~ 1æœˆ12æ—¥</span>
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('plan')">ğŸ“… å‘¨è®¡åˆ’</button>
        <button class="tab-btn" onclick="switchTab('today')">âœ… ä»Šæ—¥æ‰“å¡</button>
        <button class="tab-btn" onclick="switchTab('review')">ğŸ“Š å‘¨å¤ç›˜</button>
        <button class="tab-btn tools" onclick="showTools()">âš™ï¸ å·¥å…·</button>
    </div>
</div>

<div class="container">
    <!-- å‘¨è®¡åˆ’ -->
    <div class="view active" id="plan-view">
        <div style="margin-bottom: 15px; display: none;" id="quick-fill-bar">
            <div style="background: white; padding: 12px; border-radius: 10px; border-left: 4px solid var(--accent);">
                <div style="font-size: 12px; color: var(--sub); margin-bottom: 8px;">âœ¨ å¿«é€Ÿæ’ç­æ¨¡å¼</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="quick-fill-tag" style="font-weight: 600;">å·²é€‰æ‹©ï¼š</span>
                    <button style="padding: 6px 12px; background: #eee; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px;" onclick="exitQuickFill()">âœ• é€€å‡ºå¿«é€Ÿæ¨¡å¼</button>
                    <button style="padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: auto;" onclick="confirmQuickFill()">âœ“ ç¡®è®¤å¡«å……</button>
                </div>
            </div>
        </div>
        <table class="week-table" id="week-table">
            <tr>
                <th>æ—¶é—´</th>
                <th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th><th>å‘¨æ—¥</th>
            </tr>
        </table>
    </div>

    <!-- ä»Šæ—¥æ‰“å¡ -->
    <div class="view" id="today-view">
        <div style="margin-bottom: 15px; background: white; padding: 12px; border-radius: 10px;">
            <div style="font-size: 12px; color: var(--sub); margin-bottom: 8px;">ğŸ“… é€‰æ‹©æ—¥æœŸ</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="date-btn active" onclick="switchCheckinDay(-1)" style="padding: 8px 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px;">ğŸ“ ä»Šæ—¥</button>
                <button class="date-btn" onclick="switchCheckinDay(0)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨ä¸€</button>
                <button class="date-btn" onclick="switchCheckinDay(1)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨äºŒ</button>
                <button class="date-btn" onclick="switchCheckinDay(2)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨ä¸‰</button>
                <button class="date-btn" onclick="switchCheckinDay(3)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨å››</button>
                <button class="date-btn" onclick="switchCheckinDay(4)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨äº”</button>
                <button class="date-btn" onclick="switchCheckinDay(5)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨å…­</button>
                <button class="date-btn" onclick="switchCheckinDay(6)" style="padding: 8px 15px; background: white; color: var(--text); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;">å‘¨æ—¥</button>
            </div>
        </div>
        <div class="today-grid" id="today-grid"></div>
    </div>

    <!-- å‘¨å®¡è§† -->
    <!-- å‘¨å¤ç›˜ï¼ˆç»Ÿä¸€è§†å›¾ï¼‰ -->
    <div class="view" id="review-view">
        <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šå‘¨è®¡åˆ’è¡¨ -->
        <div style="margin-bottom: 30px;">
            <h2 style="margin: 0 0 15px 0; color: var(--accent); font-size: 16px;">ğŸ“‹ æœ¬å‘¨æ‰§è¡Œæƒ…å†µ</h2>
            <table class="review-table" id="review-table">
                <tr>
                    <th>æ—¶é—´</th>
                    <th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th><th>å‘¨æ—¥</th>
                </tr>
            </table>
            <button class="io-btn" style="margin-top: 10px; width: 100%; background: #FF6B6B; color: white;" onclick="generateShareCard('weekplan')">ğŸ“¸ åˆ†äº«æœ¬å‘¨è®¡åˆ’</button>
        </div>

        <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®åˆ†æ -->
        <div class="stats-box">
            <h3>ğŸ“Š æœ¬å‘¨æ•°æ®åˆ†æ</h3>
            <div id="stats-content"></div>
            <button class="io-btn" style="margin-top: 10px; width: 100%; background: #FF6B6B; color: white;" onclick="generateShareCard('analysis')">ğŸ“¸ åˆ†äº«æ•°æ®åˆ†æ</button>
        </div>

        <!-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šAIæ´å¯Ÿ -->
        <div class="stats-box">
            <h3>ğŸ’¡ AIæ´å¯Ÿ</h3>
            <div id="ai-insight" class="insight-text">å®Œæˆä¸€äº›ä»»åŠ¡åä¼šæ˜¾ç¤º</div>
            <button id="deep-analyze-btn" onclick="requestDeepAnalysis()" style="width: 100%; margin-top: 15px; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ¤– ç”Ÿæ´»æ´å¯Ÿæ·±åº¦åˆ†æ</button>
            <div id="ai-deep-insight" style="margin-top: 15px; display: none; background: white; padding: 15px; border-radius: 8px; border-left: 4px solid var(--growth); line-height: 1.6; white-space: pre-wrap; font-size: 13px; color: #333;"></div>
            <button class="io-btn" style="margin-top: 10px; width: 100%; background: #FF6B6B; color: white;" onclick="generateShareCard('aiinsight')">ğŸ“¸ åˆ†äº«AIåˆ†æ</button>
        </div>

        <!-- ç¬¬å››éƒ¨åˆ†ï¼šå¤ç›˜æ€è€ƒ -->
        <div style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 30px;">
            <h2 style="margin: 0 0 20px 0; color: var(--accent); font-size: 16px;">âœï¸ å‘¨å¤ç›˜æ€è€ƒ</h2>
            
            <div class="review-section">
                <h3>âœ… æœ¬å‘¨åšå¾—å¾ˆå¥½çš„äº‹</h3>
                <textarea id="review-good" placeholder="ä¾‹å¦‚ï¼šåšæŒæ™¨è·‘..."></textarea>
            </div>
            <div class="review-section">
                <h3>âŒ æœ¬å‘¨æ²¡åšå¥½çš„åœ°æ–¹</h3>
                <textarea id="review-bad" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«æ²¡æœ‰é™ªä¼´å®¶äºº..."></textarea>
            </div>
            <div class="review-section">
                <h3>ğŸ’¡ ä¸‹å‘¨çš„æ”¹è¿›è®¡åˆ’</h3>
                <textarea id="review-next" placeholder="ä¾‹å¦‚ï¼šè°ƒæ•´æ—¶é—´å®‰æ’..."></textarea>
            </div>
            <div class="review-buttons">
                <button class="btn-analyze" onclick="generateAnalysis()">âœ¨ ç”Ÿæˆå®Œæ•´åˆ†æ</button>
                <button class="io-btn" style="background: #FF6B6B; color: white;" onclick="generateShareCard('reflection')">ğŸ“¸ åˆ†äº«å¤ç›˜æ€è€ƒ</button>
            </div>
            <div class="analysis-result" id="analysis-result"></div>
        </div>

        <!-- ç¬¬äº”éƒ¨åˆ†ï¼šåˆ†äº«é€‰é¡¹ -->
        <div style="margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 10px; text-align: center;">
            <h3 style="margin-top: 0;">ğŸ¯ ä¸€é”®åˆ†äº«å®Œæ•´å‘¨æŠ¥</h3>
            <button class="io-btn" style="width: 100%; background: var(--accent); color: white; font-weight: 600; font-size: 14px;" onclick="showShareOptions()">ğŸš€ é€‰æ‹©åˆ†äº«å†…å®¹</button>
        </div>
    </div>

    <!-- ç§»é™¤æ—§çš„åæ€ view -->
    <!-- å·¥å…·é¢æ¿ -->
    <div class="view" id="tools-view">
        <div class="io-buttons">
            <button class="io-btn" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
            <button class="io-btn" onclick="document.getElementById('import-file').click()">ğŸ“¤ å¯¼å…¥æ•°æ®</button>
            <button class="io-btn" style="background: #FF6B6B; color: white;" onclick="generateShareCard()">ğŸ“¸ ç”Ÿæˆåˆ†äº«å¡ç‰‡</button>
            <button class="io-btn" onclick="clearAllData()" style="color: #dc3545;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
        </div>
        <div id="share-card-preview" style="display: none; background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
            <div id="card-canvas-container" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 20px; color: white; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                <div style="font-size: 28px; font-weight: 700; margin-bottom: 15px;">ğŸ“Š æˆ‘çš„å‘¨æŠ¥</div>
                <div id="card-stats" style="text-align: left; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 14px;"></div>
                <div style="font-size: 12px; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">âœ¨ ç”¨ã€Œäººç”Ÿè„šæœ¬ã€è®°å½•ä½ çš„æˆé•¿</div>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="downloadShareCard()" style="flex: 1; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
                <button onclick="closeShareCardPreview()" style="flex: 1; padding: 12px; background: #eee; border: none; border-radius: 8px; cursor: pointer;">å…³é—­</button>
            </div>
        </div>
        <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
            <h3 style="margin-top: 0;">ä½¿ç”¨è¯´æ˜</h3>
            <p>âœ… <strong>å‘¨è®¡åˆ’</strong> - åˆ¶å®šæœ¬å‘¨çš„è®¡åˆ’ï¼Œç‚¹å‡»æ ¼å­æ·»åŠ ä»»åŠ¡</p>
            <p>âœ… <strong>ä»Šæ—¥æ‰“å¡</strong> - æ ‡è®°ä»Šå¤©çš„å®Œæˆæƒ…å†µï¼ˆâ­•è®¡åˆ’ä¸­ â†’ âœ…å·²å®Œæˆ â†’ âŒæœªå®Œæˆï¼‰</p>
            <p>âœ… <strong>å‘¨å®¡è§†</strong> - æŸ¥çœ‹æœ¬å‘¨çš„æ‰§è¡Œæƒ…å†µã€æ•°æ®åˆ†æå’ŒAIæ´å¯Ÿ</p>
            <p>âœ… <strong>å¤ç›˜æ€è€ƒ</strong> - åæ€ä¸æ€»ç»“ï¼Œç”Ÿæˆå®Œæ•´çš„å‘¨æŠ¥å‘Š</p>
            <p>âœ… <strong>å¯¼å…¥å¯¼å‡º</strong> - å¤‡ä»½å’Œæ¢å¤æ•°æ®ï¼Œæ”¯æŒå¤šè®¾å¤‡åŒæ­¥</p>
        </div>
    </div>
</div>

<!-- ä»»åŠ¡ç¼–è¾‘æ¨¡æ€ -->
<div class="modal" id="task-modal">
    <div class="modal-box">
        <h3>ç¼–è¾‘ä»»åŠ¡</h3>
        <h4 id="modal-time" style="color: var(--sub); margin: 0 0 15px 0;">å‘¨ä¸€ 7:00</h4>
        <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; display: block; margin-bottom: 8px;">é€‰æ‹©ç±»åˆ«</label>
            <div class="category-selector">
                <button class="cat-btn" onclick="selectCategory('health')">ğŸ”µ å¥åº·ä¹ æƒ¯</button>
                <button class="cat-btn" onclick="selectCategory('family')">ğŸŸ¡ å®¶åº­æ—¶é—´</button>
                <button class="cat-btn" onclick="selectCategory('work')">ğŸ’š å·¥ä½œæ—¶é—´</button>
                <button class="cat-btn" onclick="selectCategory('growth')">ğŸ’œ è‡ªæˆ‘æˆé•¿</button>
            </div>
        </div>
        <div class="category-hint" id="category-hint"></div>
        <div class="tag-history" id="tag-history">
            <div style="font-size: 11px; color: var(--sub); margin-bottom: 6px;">ğŸ“š ä½ ä¹‹å‰ç”¨è¿‡çš„æ ‡ç­¾</div>
            <div class="tag-history-list" id="tag-history-list"></div>
        </div>
        <input type="text" class="modal-input" id="task-tag" placeholder="è¾“å…¥æ´»åŠ¨æ ‡ç­¾">
        <div class="modal-buttons">
            <button class="btn-confirm" onclick="saveTask()">âœ“ ç¡®è®¤</button>
            <button style="flex: 1; padding: 10px; background: var(--work); color: white; border: none; border-radius: 8px; cursor: pointer;" onclick="enterQuickFill()">âš¡ å¿«é€Ÿæ’ç­</button>
            <button class="btn-cancel" onclick="closeModal()">âœ• å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- è·³è¿‡åŸå› é€‰æ‹©æ¨¡æ€ -->
<div class="modal" id="skip-reason-modal">
    <div class="modal-box">
        <h3>â­ï¸ æ ‡è®°åŸå› </h3>
        <h4 id="skip-task-info" style="color: var(--sub); margin: 0 0 15px 0;">å‘¨ä¸€ 7:00</h4>
        <div style="margin-bottom: 15px;">
            <p style="font-size: 12px; color: var(--text); margin: 0 0 12px 0;">è¿™é¡¹ä»»åŠ¡æ²¡æœ‰å®Œæˆæ˜¯å› ä¸º...</p>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="skip-btn" onclick="saveSkipReason('overtime', 'åŠ ç­/å·¥ä½œåŠ é‡')" style="padding: 12px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; text-align: left;">
                    <div style="font-weight: 600;">â° åŠ ç­/å·¥ä½œåŠ é‡</div>
                    <div style="font-size: 11px; color: var(--sub);">å› ä¸ºå·¥ä½œé‡çªç„¶å¢åŠ </div>
                </button>
                <button class="skip-btn" onclick="saveSkipReason('rest', 'éœ€è¦ä¼‘æ¯')" style="padding: 12px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; text-align: left;">
                    <div style="font-weight: 600;">ğŸ˜´ éœ€è¦ä¼‘æ¯</div>
                    <div style="font-size: 11px; color: var(--sub);">èº«ä½“ç–²åŠ³ï¼Œä¼˜å…ˆç¡çœ </div>
                </button>
                <button class="skip-btn" onclick="saveSkipReason('emergency', 'ä¸´æ—¶çªå‘')" style="padding: 12px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; text-align: left;">
                    <div style="font-weight: 600;">ğŸš¨ ä¸´æ—¶çªå‘äº‹ä»¶</div>
                    <div style="font-size: 11px; color: var(--sub);">çªå‘çš„ç´§æ€¥æƒ…å†µ</div>
                </button>
                <button class="skip-btn" onclick="saveSkipReason('other', 'å…¶ä»–åŸå› ')" style="padding: 12px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; text-align: left;">
                    <div style="font-weight: 600;">â“ å…¶ä»–åŸå› </div>
                    <div style="font-size: 11px; color: var(--sub);">è¯·åœ¨ä¸‹é¢è¯´æ˜</div>
                </button>
            </div>
        </div>
        <input type="text" class="modal-input" id="skip-reason-detail" placeholder="(å¯é€‰) è¯¦ç»†è¯´æ˜åŸå› " style="display: none;">
        <div class="modal-buttons">
            <button class="btn-confirm" id="skip-confirm-btn" onclick="confirmSkipReason()" style="display: none;">âœ“ ç¡®è®¤</button>
            <button class="btn-cancel" onclick="closeSkipReasonModal()">âœ• å…³é—­</button>
        </div>
    </div>
</div>

<!-- åˆ†äº«é€‰é¡¹æ¨¡æ€ -->
<div class="modal" id="share-options-modal">
    <div class="modal-box" style="max-width: 500px;">
        <h3>ğŸš€ åˆ†äº«ä½ çš„å‘¨æŠ¥</h3>
        <p style="color: var(--sub); margin: 0 0 15px 0; font-size: 13px;">é€‰æ‹©è¦åˆ†äº«çš„å†…å®¹ç±»å‹</p>
        
        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="share-type" value="table" checked style="margin-right: 10px;"> 
                <div>
                    <div style="font-weight: 600;">ğŸ“Š æœ¬å‘¨æ‰§è¡Œæƒ…å†µè¡¨</div>
                    <div style="font-size: 11px; color: var(--sub);">ä½ è¿™å‘¨è¯¦ç»†çš„ä»»åŠ¡å®Œæˆæƒ…å†µ</div>
                </div>
            </label>
            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="share-type" value="combined" style="margin-right: 10px;"> 
                <div>
                    <div style="font-weight: 600;">ğŸ“‹ å®Œæ•´å‘¨æŠ¥ï¼ˆåˆå¹¶ï¼‰</div>
                    <div style="font-size: 11px; color: var(--sub);">è¡¨æ ¼ + æ•°æ®åˆ†æ + å¤ç›˜æ€è€ƒï¼ˆä¸€å¼ é•¿å›¾ï¼‰</div>
                </div>
            </label>
            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="share-type" value="analysis" style="margin-right: 10px;"> 
                <div>
                    <div style="font-weight: 600;">ğŸ“ˆ æ•°æ®åˆ†æå¡ç‰‡</div>
                    <div style="font-size: 11px; color: var(--sub);">æœ¬å‘¨å„ç±»åˆ«çš„å®Œæˆåº¦ç»Ÿè®¡</div>
                </div>
            </label>
            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <input type="radio" name="share-type" value="reflection" style="margin-right: 10px;"> 
                <div>
                    <div style="font-weight: 600;">âœï¸ å‘¨å¤ç›˜æ€è€ƒ</div>
                    <div style="font-size: 11px; color: var(--sub);">ä½ çš„åæ€ä¸æ”¹è¿›è®¡åˆ’</div>
                </div>
            </label>
        </div>

        <div class="modal-buttons">
            <button class="btn-confirm" onclick="previewShareCard()">ğŸ‘ï¸ é¢„è§ˆ</button>
            <button class="btn-cancel" onclick="closeShareOptions()">âœ• å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- åˆ†äº«é¢„è§ˆæ¨¡æ€ -->
<div class="modal" id="share-preview-modal">
    <div class="modal-box" style="max-width: 600px;">
        <h3>ğŸ“± åˆ†äº«é¢„è§ˆ</h3>
        <div id="share-preview-content" style="margin: 20px 0; text-align: center;">
            <img id="share-preview-image" src="" style="max-width: 100%; max-height: 600px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        </div>
        <div class="modal-buttons">
            <button class="btn-confirm" onclick="downloadPreviewCard()">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
            <button class="btn-cancel" onclick="closeSharePreview()">âœ• å…³é—­</button>
        </div>
    </div>
</div>

<!-- åˆ†ç±»ç¼–è¾‘æ¨¡æ€ -->
<div class="modal" id="edit-categories-modal">
    <div class="modal-box" style="max-width: 600px;">
        <h3>âœï¸ ç¼–è¾‘åˆ†ç±»</h3>
        <p style="color: var(--sub); margin: 0 0 20px 0; font-size: 13px;">è‡ªå®šä¹‰ä½ çš„æ—¶é—´åˆ†ç±»ï¼ˆå‰4ä¸ªå¿…å¡«ï¼Œå¯ä»¥æ·»åŠ ç¬¬5ä¸ªï¼‰</p>
        <div id="edit-categories-content" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
        </div>
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="io-btn" onclick="addCategoryField()" style="background: #4CAF50; color: white; width: 100%;">â• æ·»åŠ æ–°åˆ†ç±»</button>
        </div>
        <div class="modal-buttons">
            <button class="btn-confirm" onclick="saveCategories()">âœ“ ä¿å­˜</button>
            <button class="btn-cancel" onclick="closeEditCategoriesModal()">âœ• å–æ¶ˆ</button>
        </div>
    </div>
</div>

<input type="file" id="import-file" accept=".json" onchange="importData(event)">

<script>
const HOURS = Array.from({length: 17}, (_, i) => i + 7);
const DAYS = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
const CATEGORIES = {
    health: { name: 'å¥åº·ä¹ æƒ¯', emoji: 'ğŸ”µ', hint: 'ğŸ­ æ‡’è™« | è·‘æ­¥ç‹‚ | ç‘œä¼½ä»™å¥³ | å†¥æƒ³è€… | ç¡çœ å«å£«' },
    family: { name: 'å®¶åº­æ—¶é—´', emoji: 'ğŸŸ¡', hint: 'ğŸ­ é™ªä¼´ä¾  | å®¶åŠ¡å«å£« | å¥¶çˆ¸å¥¶å¦ˆ | åšé¥­å¤§å¨ | æ•…äº‹è®²è¿°è€…' },
    work: { name: 'å·¥ä½œæ—¶é—´', emoji: 'ğŸ’š', hint: 'ğŸ­ æ‰“å·¥ç‹— | å†™ä½œå®¶ | ä»£ç ä¾  | ä¼šè®®è¾¾äºº | é¡¹ç›®ç»ç†' },
    growth: { name: 'è‡ªæˆ‘æˆé•¿', emoji: 'ğŸ’œ', hint: 'ğŸ­ é˜…è¯»è™« | æ€è€ƒè€… | å­¦ä¹ è€… | æ—¥è®°ä½œå®¶ | çŸ¥è¯†çŒäºº' }
};

let weekData = { tasks: {}, review: { good: '', bad: '', next: '' }, skipReasons: {} };
let tagCategoryMap = {}; // è®°å½•æ ‡ç­¾å¯¹åº”çš„ç±»åˆ«
let tagHistory = { health: [], family: [], work: [], growth: [] };
let selectedCategory = null;
let selectedSlot = null;
let quickFillMode = false;
let quickFillData = null;
let checkinDay = -1; // -1 è¡¨ç¤ºä»Šæ—¥ï¼Œ0-6 è¡¨ç¤ºå‘¨ä¸€åˆ°å‘¨æ—¥
let pendingSkipKey = null; // ç­‰å¾…ä¿å­˜è·³è¿‡åŸå› çš„ä»»åŠ¡ key
let selectedSkipReason = null; // é€‰æ‹©çš„è·³è¿‡åŸå› 
let currentShareType = null; // å½“å‰åˆ†äº«çš„å¡ç‰‡ç±»å‹
let editingCategoriesTemp = null; // ç¼–è¾‘åˆ†ç±»æ—¶çš„ä¸´æ—¶å˜é‡
let appConfigCategories = null; // åŠ¨æ€åˆ†ç±»é…ç½®ï¼ˆæ”¯æŒä»»æ„æ•°é‡ï¼‰
let isFirstTime = false; // æ˜¯å¦ç¬¬ä¸€æ¬¡ä½¿ç”¨

// åˆå§‹åŒ–
function init() {
    loadData();
    
    // å¦‚æœç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œæ˜¾ç¤ºåˆ†ç±»è®¾ç½®å¯¹è¯æ¡†
    if (isFirstTime || !appConfigCategories || appConfigCategories.length === 0) {
        showInitialCategorySetup();
    } else {
        updateWeekInfo();
        renderWeekPlan();
        renderTodayView();
        renderWeekReview();
        loadReviewData();
    }
}

function showInitialCategorySetup() {
    // æ˜¾ç¤ºé¦–æ¬¡è®¾ç½®æ¨¡æ€æ¡†
    document.getElementById('edit-categories-modal').classList.add('show');
    document.getElementById('edit-categories-modal').innerHTML = `
        <div class="modal-box" style="max-width: 600px;">
            <h3>ğŸ‘‹ æ¬¢è¿ï¼è¯·å…ˆè®¾ç½®ä½ çš„æ—¶é—´åˆ†ç±»</h3>
            <p style="color: var(--sub); margin: 0 0 20px 0; font-size: 13px;">è‡ªå®šä¹‰ä½ çš„æ—¶é—´åˆ†ç±»ï¼ˆå‰4ä¸ªå¿…å¡«ï¼Œå¯ä»¥æ·»åŠ æ›´å¤šï¼‰</p>
            <div id="edit-categories-content" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="io-btn" onclick="addCategoryField()" style="background: #4CAF50; color: white; width: 100%;">â• æ·»åŠ æ–°åˆ†ç±»</button>
            </div>
            <div class="modal-buttons">
                <button class="btn-confirm" onclick="saveCategories()">âœ“ å¼€å§‹ä½¿ç”¨</button>
            </div>
        </div>
    `;
    
    // åˆå§‹åŒ– appConfigCategoriesï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
    if (!appConfigCategories || appConfigCategories.length === 0) {
        appConfigCategories = [
            { name: 'å¥åº·ä¹ æƒ¯', emoji: 'ğŸ”µ', color: '#AECBFA' },
            { name: 'å®¶åº­æ—¶é—´', emoji: 'ğŸŸ¡', color: '#FDE293' },
            { name: 'å·¥ä½œæ—¶é—´', emoji: 'ğŸ’š', color: '#CCF0DF' },
            { name: 'è‡ªæˆ‘æˆé•¿', emoji: 'ğŸ’œ', color: '#D4BBFF' }
        ];
    }
    
    renderCategoryEditors();
}

function renderCategoryEditors() {
    let html = '';
    appConfigCategories.forEach((cat, idx) => {
        html += `
            <div class="category-input-group" style="margin-bottom: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <label class="category-input-label" style="display: block; margin-bottom: 10px; font-weight: 600;">åˆ†ç±» ${idx + 1} ${idx < 4 ? '(å¿…å¡«)' : '(å¯é€‰)'}</label>
                <div style="display: grid; grid-template-columns: 60px 1fr 80px; gap: 10px;">
                    <input type="text" id="edit-emoji-${idx}" placeholder="ğŸ”µ" value="${cat.emoji}" maxlength="2" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 20px; text-align: center;">
                    <input type="text" id="edit-name-${idx}" placeholder="åˆ†ç±»åç§°" value="${cat.name}" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    <input type="color" id="edit-color-${idx}" value="${cat.color}" style="padding: 4px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                </div>
                ${idx >= 4 ? `<button onclick="removeCategoryField(${idx})" style="margin-top: 8px; padding: 6px 12px; background: #FF6B6B; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">åˆ é™¤</button>` : ''}
            </div>
        `;
    });
    document.getElementById('edit-categories-content').innerHTML = html;
}

function addCategoryField() {
    if (!appConfigCategories) appConfigCategories = [];
    appConfigCategories.push({ 
        name: `åˆ†ç±»${appConfigCategories.length + 1}`, 
        emoji: 'â­•', 
        color: '#E8E8E8' 
    });
    renderCategoryEditors();
}

function removeCategoryField(idx) {
    if (idx >= 4) {
        appConfigCategories.splice(idx, 1);
        renderCategoryEditors();
    }
}

function loadData() {
    const stored = localStorage.getItem('life-script-data');
    if (stored) {
        try {
            const data = JSON.parse(stored);
            weekData = data.weekData || weekData;
            tagCategoryMap = data.tagCategoryMap || tagCategoryMap;
            tagHistory = data.tagHistory || tagHistory;
            appConfigCategories = data.appConfigCategories || null;
        } catch (e) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
        }
    }
    
    // å¦‚æœæ²¡æœ‰ä¿å­˜è¿‡åˆ†ç±»é…ç½®ï¼Œåˆ™æ ‡è®°ä¸ºé¦–æ¬¡ä½¿ç”¨
    if (!appConfigCategories) {
        isFirstTime = true;
    }
}

function saveData() {
    const data = { weekData, tagCategoryMap, tagHistory, appConfigCategories };
    localStorage.setItem('life-script-data', JSON.stringify(data));
}

function getWeekNumber(date) {
    const year = date.getFullYear();
    const firstDay = new Date(year, 0, 1);
    const pastDaysOfYear = (date - firstDay) / 86400000;
    return Math.ceil((pastDaysOfYear + firstDay.getDay() + 1) / 7);
}

function getWeekDateRange() {
    const now = new Date();
    const dayOfWeek = now.getDay() || 7;
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - dayOfWeek + 1);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    
    const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
    return `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
}

function updateWeekInfo() {
    const now = new Date();
    const year = now.getFullYear();
    const firstDay = new Date(year, 0, 1);
    const pastDaysOfYear = (now - firstDay) / 86400000;
    const week = Math.ceil((pastDaysOfYear + firstDay.getDay() + 1) / 7);
    
    const dayOfWeek = now.getDay() || 7;
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - dayOfWeek + 1);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);

    const startMonth = weekStart.getMonth() + 1;
    const startDate = weekStart.getDate();
    const endMonth = weekEnd.getMonth() + 1;
    const endDate = weekEnd.getDate();

    document.getElementById('week-info').textContent = 
        `${year}å¹´ç¬¬${week}å‘¨ Â· ${startMonth}æœˆ${startDate}æ—¥ ~ ${endMonth}æœˆ${endDate}æ—¥`;
}

function switchTab(tab) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    const viewMap = {
        plan: 'plan-view',
        today: 'today-view',
        review: 'review-view',
        tools: 'tools-view'
    };
    
    if (viewMap[tab]) {
        document.getElementById(viewMap[tab]).classList.add('active');
        document.querySelector(`.tab-btn[onclick*="'${tab}'"]`).classList.add('active');
    }
}

function showTools() {
    switchTab('tools');
}

function renderWeekPlan() {
    let html = '<tr><th>æ—¶é—´</th>';
    DAYS.forEach(d => html += `<th>${d}</th>`);
    html += '</tr>';
    
    HOURS.forEach(hour => {
        html += `<tr><td style="background: #f5f5f5; font-weight: 500;">${hour}:00</td>`;
        for (let day = 0; day < 7; day++) {
            const key = `${day}-${hour}`;
            const task = weekData.tasks[key];
            if (task) {
                html += `<td class="week-cell task-${task.category}" onclick="handleWeekCellClick(${day}, ${hour})">${task.tag}</td>`;
            } else {
                html += `<td class="week-cell" onclick="handleWeekCellClick(${day}, ${hour})"></td>`;
            }
        }
        html += '</tr>';
    });
    document.getElementById('week-table').innerHTML = html;
}

function handleWeekCellClick(day, hour) {
    if (quickFillMode) {
        // å¿«é€Ÿæ’ç­æ¨¡å¼ï¼šç‚¹å‡»å¡«å……
        const key = `${day}-${hour}`;
        weekData.tasks[key] = { 
            category: quickFillData.category, 
            tag: quickFillData.tag, 
            status: 'plan' 
        };
        renderWeekPlan();
    } else {
        // æ™®é€šæ¨¡å¼ï¼šæ‰“å¼€ç¼–è¾‘æ¡†
        openEditModal(day, hour);
    }
}

function renderWeekReview() {
    let html = '<tr><th>æ—¶é—´</th>';
    DAYS.forEach(d => html += `<th>${d}</th>`);
    html += '</tr>';
    
    HOURS.forEach(hour => {
        html += `<tr><td style="background: #f5f5f5;">${hour}:00</td>`;
        for (let day = 0; day < 7; day++) {
            const key = `${day}-${hour}`;
            const task = weekData.tasks[key];
            let cellClass = 'review-cell';
            let content = '';
            
            if (task) {
                if (task.status === 'done') {
                    cellClass = 'review-cell done';
                    content = 'âœ…';
                } else if (task.status === 'fail') {
                    // æ£€æŸ¥æ˜¯å¦æœ‰è·³è¿‡åŸå› ï¼ˆç‰¹æ®Šæƒ…å†µï¼Œä¸ç®—çœŸæ­£çš„å¤±è´¥ï¼‰
                    const hasReason = weekData.skipReasons && weekData.skipReasons[key];
                    if (hasReason) {
                        cellClass = 'review-cell skip';
                        content = 'â­ï¸'; // æ˜¾ç¤º"è·³è¿‡"è€Œä¸æ˜¯"å¤±è´¥"
                        cellClass += ' skip-reason'; // æ·»åŠ ç‰¹æ®Šæ ·å¼
                    } else {
                        cellClass = 'review-cell fail';
                        content = 'âŒ';
                    }
                } else {
                    cellClass = 'review-cell';
                    content = 'â­•';
                }
            }
            html += `<td class="${cellClass}" title="${weekData.skipReasons && weekData.skipReasons[key] ? weekData.skipReasons[key].label : ''}">${content}</td>`;
        }
        html += '</tr>';
    });
    document.getElementById('review-table').innerHTML = html;
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    updateStats();
}

function updateStats() {
    const stats = {
        health: { total: 0, done: 0, skip: 0 },
        family: { total: 0, done: 0, skip: 0 },
        work: { total: 0, done: 0, skip: 0 },
        growth: { total: 0, done: 0, skip: 0 }
    };

    Object.entries(weekData.tasks).forEach(([key, task]) => {
        if (stats[task.category]) {
            // æœ‰è·³è¿‡åŸå› çš„å¤±è´¥ä»»åŠ¡ä¸ç®—åœ¨æ€»æ•°é‡Œ
            const hasSkipReason = weekData.skipReasons && weekData.skipReasons[key];
            if (!hasSkipReason) {
                stats[task.category].total++;
            }
            
            if (task.status === 'done') {
                stats[task.category].done++;
            } else if (hasSkipReason) {
                stats[task.category].skip++;
            }
        }
    });

    let html = '';
    let totalTasks = 0;
    let totalDone = 0;
    let totalSkip = 0;

    Object.entries(stats).forEach(([cat, data]) => {
        totalTasks += data.total;
        totalDone += data.done;
        totalSkip += data.skip;
        const percentage = data.total > 0 ? Math.round((data.done / data.total) * 100) : 0;
        html += `
            <div class="category-stat">
                <div class="category-stat-label">
                    <span>${CATEGORIES[cat].emoji}</span>
                    <span>${CATEGORIES[cat].name}</span>
                </div>
                <div style="text-align: right;">
                    <div class="category-stat-value">${percentage}%</div>
                    <div class="completion-rate">${data.done}/${data.total}${data.skip > 0 ? ` (è·³è¿‡${data.skip})` : ''}</div>
                </div>
            </div>
        `;
    });

    document.getElementById('stats-content').innerHTML = html;

    // ç”ŸæˆAIæ´å¯Ÿ
    generateInsight(stats, totalTasks, totalDone, totalSkip);
}

function generateInsight(stats, totalTasks, totalDone, totalSkip = 0) {
    if (totalTasks === 0) {
        document.getElementById('ai-insight').textContent = 'è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œèµ¶å¿«è§„åˆ’ä½ çš„ä¸€å‘¨å§ï¼';
        return;
    }

    const overallRate = Math.round((totalDone / totalTasks) * 100);
    const categories = Object.entries(stats).sort((a, b) => {
        const rateA = a[1].total > 0 ? (a[1].done / a[1].total) * 100 : 0;
        const rateB = b[1].total > 0 ? (b[1].done / b[1].total) * 100 : 0;
        return rateB - rateA;
    });

    let insight = `ğŸ“Š ä½ çš„æœ¬å‘¨æˆç»©ï¼š${overallRate}%\n\n`;

    // æœ€é«˜åˆ†ç±»åˆ«
    const top = categories[0];
    if (top[1].total > 0) {
        const topRate = Math.round((top[1].done / top[1].total) * 100);
        if (topRate === 100) {
            insight += `âœ¨ å®Œç¾ï¼${CATEGORIES[top[0]].name}å®Œæˆç‡100%ï¼Œä½ çœŸæ˜¯ä¸ªè¡ŒåŠ¨åŠ›æ»¡æ»¡çš„äººï¼\n\n`;
        } else if (topRate >= 80) {
            insight += `ğŸŒŸ ${CATEGORIES[top[0]].name}çš„æ‰§è¡Œç‡æœ€é«˜ï¼ˆ${topRate}%ï¼‰ï¼Œä¿æŒè¿™ä¸ªåŠ¿å¤´ï¼\n\n`;
        }
    }

    // æ—¶é—´å æ¯”åˆ†æ
    const totalHours = Object.values(stats).reduce((sum, s) => sum + s.total, 0);
    insight += 'â° æœ¬å‘¨æ—¶é—´åˆ†é…ï¼š\n';
    Object.entries(stats).forEach(([cat, data]) => {
        if (data.total > 0) {
            const percent = Math.round((data.total / totalHours) * 100);
            insight += `  â€¢ ${CATEGORIES[cat].name}ï¼š${percent}%\n`;
        }
    });

    // ä¸ªæ€§è¯„ä»·
    const workPercent = stats.work.total > 0 ? Math.round((stats.work.total / totalHours) * 100) : 0;
    const healthPercent = stats.health.total > 0 ? Math.round((stats.health.total / totalHours) * 100) : 0;
    const growthPercent = stats.growth.total > 0 ? Math.round((stats.growth.total / totalHours) * 100) : 0;

    insight += '\nğŸ’¡ å¯¼æ¼”çš„è¯„è¯­ï¼š\n';
    if (workPercent > 50) {
        insight += `ä½ å¯çœŸæ˜¯ä¸ª"åŠ ç­ç‹‚"ï¼Œå·¥ä½œå æ¯”${workPercent}%ï¼è®°å¾—ä¹Ÿè¦å…³ç…§èº«ä½“å’Œå®¶åº­å“¦ã€‚`;
    } else if (healthPercent > 40) {
        insight += `ä½ æ˜¯ä¸ª"å¥èº«è¾¾äºº"ï¼Œå¯¹èº«ä½“å¾ˆç”¨å¿ƒï¼ç»§ç»­ä¿æŒï¼Œä½†ä¹Ÿè¦æ³¨é‡å·¥ä½œæˆé•¿ã€‚`;
    } else if (growthPercent > 40) {
        insight += `ä½ æ˜¯ä¸ª"å­¦ä¹ ç‹‚é­”"ï¼Œè‡ªæˆ‘æå‡å¾ˆç§¯æï¼æ£’æäº†ï¼Œè¿™å°±æ˜¯æˆé•¿çš„æ ·å­ã€‚`;
    } else {
        insight += `æ—¶é—´åˆ†é…å¾ˆå‡è¡¡ï¼Œä½ çœŸæ˜¯ä¸ªæœ‰"å‰§æœ¬æ„è¯†"çš„å¯¼æ¼”ï¼`;
    }

    document.getElementById('ai-insight').textContent = insight;
}

function renderTodayView() {
    const now = new Date();
    let dayIndex = checkinDay === -1 ? (now.getDay() || 7) - 1 : checkinDay;
    
    let html = '';
    
    HOURS.forEach(hour => {
        const key = `${dayIndex}-${hour}`;
        const task = weekData.tasks[key];
        if (task) {
            const statusClass = task.status === 'done' ? 'done' : task.status === 'fail' ? 'fail' : '';
            const status = task.status === 'done' ? 'âœ…' : task.status === 'fail' ? 'âŒ' : 'â­•';
            html += `
                <div class="time-slot">
                    <div class="slot-info">
                        <div class="slot-time">${hour}:00</div>
                        <div>${CATEGORIES[task.category].emoji} <span class="slot-tag">${task.tag}</span></div>
                    </div>
                    <div class="slot-status ${statusClass}" onclick="toggleStatus('${key}')">${status}</div>
                </div>
            `;
        } else {
            html += `
                <div class="time-slot" onclick="openEditModal(${dayIndex}, ${hour})">
                    <div class="slot-info">
                        <div class="slot-time">${hour}:00</div>
                        <div style="color: #ccc;">æœªå®‰æ’</div>
                    </div>
                    <div style="color: #999;">+</div>
                </div>
            `;
        }
    });
    document.getElementById('today-grid').innerHTML = html;
}

function toggleStatus(key) {
    const task = weekData.tasks[key];
    const statuses = ['plan', 'done', 'fail'];
    const idx = statuses.indexOf(task.status || 'plan');
    const nextStatus = statuses[(idx + 1) % 3];
    
    // å¦‚æœè¦æ ‡è®°ä¸ºå¤±è´¥ï¼Œå…ˆæ˜¾ç¤ºåŸå› é€‰æ‹©çª—å£
    if (nextStatus === 'fail') {
        task.status = 'fail';
        pendingSkipKey = key;
        const [day, hour] = key.split('-').map(Number);
        document.getElementById('skip-task-info').textContent = `${DAYS[day]} ${hour}:00 - ${task.tag}`;
        document.getElementById('skip-reason-modal').classList.add('show');
    } else {
        task.status = nextStatus;
        saveData();
        renderWeekPlan();
        renderTodayView();
        renderWeekReview();
    }
}

function saveSkipReason(reason, label) {
    selectedSkipReason = reason;
    document.querySelectorAll('.skip-btn').forEach(btn => btn.style.borderColor = '#ddd');
    event.target.closest('button').style.borderColor = 'var(--accent)';
    event.target.closest('button').style.backgroundColor = 'rgba(108, 92, 231, 0.05)';
    
    if (reason === 'other') {
        document.getElementById('skip-reason-detail').style.display = 'block';
        document.getElementById('skip-confirm-btn').style.display = 'block';
    } else {
        document.getElementById('skip-reason-detail').style.display = 'none';
        document.getElementById('skip-confirm-btn').style.display = 'none';
        confirmSkipReason();
    }
}

function confirmSkipReason() {
    if (!pendingSkipKey || !selectedSkipReason) return;
    
    const detail = document.getElementById('skip-reason-detail').value.trim();
    if (selectedSkipReason === 'other' && !detail) {
        alert('è¯·è¯´æ˜å…¶ä»–åŸå› ');
        return;
    }
    
    const reasonLabels = {
        'overtime': 'åŠ ç­/å·¥ä½œåŠ é‡',
        'rest': 'éœ€è¦ä¼‘æ¯',
        'emergency': 'ä¸´æ—¶çªå‘äº‹ä»¶',
        'other': detail
    };
    
    if (!weekData.skipReasons) {
        weekData.skipReasons = {};
    }
    weekData.skipReasons[pendingSkipKey] = {
        type: selectedSkipReason,
        label: reasonLabels[selectedSkipReason],
        timestamp: new Date().toISOString()
    };
    
    saveData();
    closeSkipReasonModal();
    renderWeekPlan();
    renderTodayView();
    renderWeekReview();
}

function closeSkipReasonModal() {
    document.getElementById('skip-reason-modal').classList.remove('show');
    document.getElementById('skip-reason-detail').value = '';
    document.getElementById('skip-reason-detail').style.display = 'none';
    document.getElementById('skip-confirm-btn').style.display = 'none';
    pendingSkipKey = null;
    selectedSkipReason = null;
}

function openEditModal(day, hour) {
    selectedSlot = { day, hour };
    const key = `${day}-${hour}`;
    const task = weekData.tasks[key];
    
    document.getElementById('modal-time').textContent = `${DAYS[day]} ${hour}:00`;
    document.getElementById('task-tag').value = task ? task.tag : '';
    
    selectedCategory = task ? task.category : null;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
    
    if (selectedCategory) {
        const buttons = Array.from(document.querySelectorAll('.cat-btn'));
        const catKeys = Object.keys(CATEGORIES);
        const idx = catKeys.indexOf(selectedCategory);
        if (idx >= 0 && buttons[idx]) {
            buttons[idx].classList.add('selected');
            updateCategoryHint(selectedCategory);
        }
    }
    document.getElementById('task-modal').classList.add('show');
}

function selectCategory(cat) {
    selectedCategory = cat;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
    
    const buttons = Array.from(document.querySelectorAll('.cat-btn'));
    const catKeys = Object.keys(CATEGORIES);
    const idx = catKeys.indexOf(cat);
    if (idx >= 0 && buttons[idx]) {
        buttons[idx].classList.add('selected');
    }
    
    updateCategoryHint(cat);
    updateTagHistory(cat);
}

function selectKnownTag(tag) {
    // è‡ªåŠ¨æ£€æµ‹æ ‡ç­¾å¯¹åº”çš„ç±»åˆ«
    if (tagCategoryMap[tag]) {
        selectedCategory = tagCategoryMap[tag];
        // è‡ªåŠ¨é€‰ä¸­å¯¹åº”çš„ç±»åˆ«æŒ‰é’®
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
        const buttons = Array.from(document.querySelectorAll('.cat-btn'));
        const catKeys = Object.keys(CATEGORIES);
        const idx = catKeys.indexOf(selectedCategory);
        if (idx >= 0 && buttons[idx]) {
            buttons[idx].classList.add('selected');
        }
        updateCategoryHint(selectedCategory);
    }
    // å¡«å……æ ‡ç­¾å€¼
    document.getElementById('task-tag').value = tag;
    document.getElementById('task-tag').focus();
}

function updateCategoryHint(cat) {
    document.getElementById('category-hint').textContent = CATEGORIES[cat].hint;
}

function updateTagHistory(cat) {
    const history = tagHistory[cat] || [];
    const historyDiv = document.getElementById('tag-history');
    if (history.length > 0) {
        historyDiv.style.display = 'block';
        let html = '';
        history.slice(-5).reverse().forEach(tag => {
            html += `<button class="tag-history-btn" onclick="selectKnownTag('${tag.replace(/'/g, "\\'")}')">${tag}</button>`;
        });
        document.getElementById('tag-history-list').innerHTML = html;
    } else {
        historyDiv.style.display = 'none';
    }
}

function saveTask() {
    const tag = document.getElementById('task-tag').value.trim();
    if (!tag) {
        alert('è¯·è¾“å…¥æ´»åŠ¨æ ‡ç­¾');
        return;
    }
    
    // å¦‚æœæ ‡ç­¾å·²çŸ¥ï¼Œè‡ªåŠ¨è¯†åˆ«ç±»åˆ«
    let category = selectedCategory;
    if (!category && tagCategoryMap[tag]) {
        category = tagCategoryMap[tag];
    }
    
    if (!category) {
        alert('è¯·é€‰æ‹©ç±»åˆ«');
        return;
    }
    
    // è®°å½•æ ‡ç­¾-ç±»åˆ«å¯¹åº”
    tagCategoryMap[tag] = category;
    
    // æ›´æ–°æ ‡ç­¾å†å²
    if (!tagHistory[category]) tagHistory[category] = [];
    tagHistory[category] = tagHistory[category].filter(t => t !== tag);
    tagHistory[category].push(tag);
    if (tagHistory[category].length > 20) tagHistory[category].shift();
    
    const key = `${selectedSlot.day}-${selectedSlot.hour}`;
    weekData.tasks[key] = { category: category, tag, status: 'plan' };
    saveData();
    renderWeekPlan();
    renderTodayView();
    renderWeekReview();
    closeModal();
}

function closeModal() {
    document.getElementById('task-modal').classList.remove('show');
}

function enterQuickFill() {
    const tag = document.getElementById('task-tag').value.trim();
    if (!tag) {
        alert('è¯·è¾“å…¥æ´»åŠ¨æ ‡ç­¾');
        return;
    }
    
    let category = selectedCategory;
    if (!category && tagCategoryMap[tag]) {
        category = tagCategoryMap[tag];
    }
    
    if (!category) {
        alert('è¯·é€‰æ‹©ç±»åˆ«');
        return;
    }
    
    quickFillMode = true;
    quickFillData = { tag, category };
    
    // è®°å½•æ ‡ç­¾-ç±»åˆ«å¯¹åº”
    tagCategoryMap[tag] = category;
    
    // æ›´æ–°æ ‡ç­¾å†å²
    if (!tagHistory[category]) tagHistory[category] = [];
    tagHistory[category] = tagHistory[category].filter(t => t !== tag);
    tagHistory[category].push(tag);
    if (tagHistory[category].length > 20) tagHistory[category].shift();
    
    // æ˜¾ç¤ºå¿«é€Ÿæ’ç­æ¡
    document.getElementById('quick-fill-bar').style.display = 'block';
    document.getElementById('quick-fill-tag').textContent = `âœ¨ å¿«é€Ÿæ’ç­ï¼š${CATEGORIES[category].emoji} ${tag}`;
    
    // å…³é—­æ¨¡æ€æ¡†
    closeModal();
    
    // åˆ‡æ¢åˆ°å‘¨è®¡åˆ’è§†å›¾
    switchTab('plan');
}

function confirmQuickFill() {
    quickFillMode = false;
    saveData();
    renderWeekPlan();
    document.getElementById('quick-fill-bar').style.display = 'none';
}

function exitQuickFill() {
    quickFillMode = false;
    document.getElementById('quick-fill-bar').style.display = 'none';
    renderWeekPlan();
}

function switchCheckinDay(day) {
    checkinDay = day;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.date-btn').forEach((btn, idx) => {
        if ((day === -1 && idx === 0) || (day === idx - 1)) {
            btn.style.background = 'var(--accent)';
            btn.style.color = 'white';
        } else {
            btn.style.background = 'white';
            btn.style.color = 'var(--text)';
        }
    });
    
    renderTodayView();
}

function loadReviewData() {
    document.getElementById('review-good').value = weekData.review.good || '';
    document.getElementById('review-bad').value = weekData.review.bad || '';
    document.getElementById('review-next').value = weekData.review.next || '';
}

function generateAnalysis() {
    weekData.review.good = document.getElementById('review-good').value;
    weekData.review.bad = document.getElementById('review-bad').value;
    weekData.review.next = document.getElementById('review-next').value;
    saveData();
    
    const result = document.getElementById('analysis-result');
    result.textContent = 'âœ¨ ç”Ÿæˆåˆ†æä¸­...\n\näº²çˆ±çš„å¯¼æ¼”ï¼Œè¿™æ˜¯ä½ è¿™å‘¨çš„å®Œæ•´æ€»ç»“ï¼š\n\nğŸ“Š æ‰§è¡Œæ•°æ®ï¼š\n' + document.getElementById('ai-insight').textContent + '\n\nğŸ“ ä½ çš„åæ€ï¼š\nâœ… åšå¾—å¥½çš„ï¼š' + (weekData.review.good || '(æœªå¡«å†™)') + '\nâŒ ä¸è¶³ä¹‹å¤„ï¼š' + (weekData.review.bad || '(æœªå¡«å†™)') + '\nğŸ’¡ æ”¹è¿›è®¡åˆ’ï¼š' + (weekData.review.next || '(æœªå¡«å†™)') + '\n\nğŸ¬ å¯¼æ¼”çš„å»ºè®®ï¼š\nç»§ç»­ä¼˜åŒ–ä½ çš„äººç”Ÿè„šæœ¬ï¼Œæ¯å‘¨éƒ½æ˜¯æ–°çš„å¼€å§‹ã€‚ä¿æŒå¤ç›˜ä¹ æƒ¯ï¼ŒæŒç»­è¿­ä»£ï¼Œä½ ä¼šçœ‹åˆ°æ˜¾è‘—çš„æˆé•¿ï¼';
    result.style.display = 'block';
}

function exportData() {
    const data = { weekData, tagCategoryMap, tagHistory };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `life-script-${new Date().getTime()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            weekData = data.weekData || weekData;
            tagCategoryMap = data.tagCategoryMap || tagCategoryMap;
            tagHistory = data.tagHistory || tagHistory;
            saveData();
            
            renderWeekPlan();
            renderTodayView();
            renderWeekReview();
            loadReviewData();
            
            alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼');
        } catch (error) {
            alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + error.message);
        }
    };
    reader.readAsText(file);
}

function clearAllData() {
    if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™ä¸ªæ“ä½œæ— æ³•æ’¤é”€ï¼')) {
        weekData = { tasks: {}, review: { good: '', bad: '', next: '' } };
        tagCategoryMap = {};
        tagHistory = { health: [], family: [], work: [], growth: [] };
        localStorage.removeItem('life-script-data');
        
        renderWeekPlan();
        renderTodayView();
        renderWeekReview();
        loadReviewData();
        
        alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
    }
}

// ===== åˆ†ç±»ç®¡ç†å‡½æ•° =====
function showEditCategories() {
    editingCategoriesTemp = JSON.parse(JSON.stringify(appConfigCategories));
    renderCategoryEditors();
    document.getElementById('edit-categories-modal').classList.add('show');
}

function closeEditCategoriesModal() {
    document.getElementById('edit-categories-modal').classList.remove('show');
}

function saveCategories() {
    const categories = [];
    let idx = 0;
    while (document.getElementById(`edit-name-${idx}`)) {
        const name = document.getElementById(`edit-name-${idx}`).value.trim();
        const emoji = document.getElementById(`edit-emoji-${idx}`).value.trim();
        const color = document.getElementById(`edit-color-${idx}`).value;
        
        // å‰4ä¸ªå¿…å¡«
        if (idx < 4 && !name) {
            alert('å‰4ä¸ªåˆ†ç±»åç§°å¿…é¡»å¡«å†™');
            return;
        }
        
        if (name) {
            categories.push({ name, emoji: emoji || 'â­•', color });
        }
        idx++;
    }
    
    if (categories.length < 4) {
        alert('è‡³å°‘éœ€è¦4ä¸ªåˆ†ç±»');
        return;
    }
    
    appConfigCategories = categories;
    
    // æ›´æ–° tagHistory ä»¥åŒ…å«æ–°åˆ†ç±»çš„æ ‡ç­¾å†å²
    const newTagHistory = {};
    categories.forEach(cat => {
        newTagHistory[cat.name] = tagHistory[cat.name] || [];
    });
    tagHistory = newTagHistory;
    
    saveData();
    closeEditCategoriesModal();
    
    // å¦‚æœæ˜¯é¦–æ¬¡è®¾ç½®ï¼Œåˆ™ç»§ç»­åˆå§‹åŒ–
    if (isFirstTime) {
        isFirstTime = false;
        updateWeekInfo();
        renderWeekPlan();
        renderTodayView();
        renderWeekReview();
        loadReviewData();
        alert('âœ… åˆ†ç±»è®¾ç½®å®Œæˆï¼');
    } else {
        alert('âœ… åˆ†ç±»å·²ä¿å­˜ï¼');
        // é‡æ–°æ¸²æŸ“ç•Œé¢ä»¥æ˜¾ç¤ºæ–°åˆ†ç±»
        renderWeekPlan();
        renderTodayView();
    }
}

async function requestDeepAnalysis() {
    const btn = document.getElementById('deep-analyze-btn');
    const resultDiv = document.getElementById('ai-deep-insight');
    
    btn.disabled = true;
    btn.textContent = 'ğŸ¤– åˆ†æä¸­...';
    resultDiv.style.display = 'block';
    resultDiv.textContent = 'æ­£åœ¨è°ƒç”¨ DeepSeek è¿›è¡Œæ·±åº¦åˆ†æ...';
    
    try {
        // å‡†å¤‡åˆ†ææ•°æ®
        const stats = {};
        const categories = ['health', 'family', 'work', 'growth'];
        categories.forEach(cat => {
            stats[cat] = { total: 0, done: 0, skip: 0 };
        });

        Object.entries(weekData.tasks).forEach(([key, task]) => {
            if (stats[task.category]) {
                const hasSkipReason = weekData.skipReasons && weekData.skipReasons[key];
                if (!hasSkipReason) {
                    stats[task.category].total++;
                }
                if (task.status === 'done') {
                    stats[task.category].done++;
                } else if (hasSkipReason) {
                    stats[task.category].skip++;
                }
            }
        });

        const prompt = `è¯·ä½œä¸ºä¸€ä¸ªç”Ÿæ´»è§„åˆ’å¸ˆï¼Œå¯¹ä»¥ä¸‹å‘¨è®¡åˆ’æ•°æ®è¿›è¡Œæ·±åº¦åˆ†æå’Œå»ºè®®ï¼š

ğŸ“Š æœ¬å‘¨å®Œæˆæƒ…å†µï¼š
- å¥åº·ä¹ æƒ¯ï¼š${stats.health.done}/${stats.health.total}å®Œæˆï¼Œ${stats.health.skip}ä¸ªå› ç‰¹æ®ŠåŸå› è·³è¿‡
- å®¶åº­æ—¶é—´ï¼š${stats.family.done}/${stats.family.total}å®Œæˆï¼Œ${stats.family.skip}ä¸ªå› ç‰¹æ®ŠåŸå› è·³è¿‡
- å·¥ä½œæ—¶é—´ï¼š${stats.work.done}/${stats.work.total}å®Œæˆï¼Œ${stats.work.skip}ä¸ªå› ç‰¹æ®ŠåŸå› è·³è¿‡
- è‡ªæˆ‘æˆé•¿ï¼š${stats.growth.done}/${stats.growth.total}å®Œæˆï¼Œ${stats.growth.skip}ä¸ªå› ç‰¹æ®ŠåŸå› è·³è¿‡

ğŸ“ ç”¨æˆ·æœ¬å‘¨åæ€ï¼š
âœ… åšå¾—å¥½çš„ï¼š${weekData.review.good || 'æœªå¡«å†™'}
âŒ ä¸è¶³ä¹‹å¤„ï¼š${weekData.review.bad || 'æœªå¡«å†™'}
ğŸ’¡ ä¸‹å‘¨è®¡åˆ’ï¼š${weekData.review.next || 'æœªå¡«å†™'}

è¯·æä¾›ï¼š
1. å¯¹æ•´å‘¨æ‰§è¡Œæƒ…å†µçš„æ·±åº¦åˆ†æ
2. æ—¶é—´åˆ†é…æ˜¯å¦åˆç†çš„å»ºè®®
3. å¯¹ä¸‹ä¸€å‘¨çš„å…·ä½“æ”¹è¿›å»ºè®®
4. é’ˆå¯¹ä¸è¶³ä¹‹å¤„çš„è§£å†³æ–¹æ¡ˆ
5. é¼“åŠ±å’Œç§¯æåé¦ˆ

å›å¤è¯·ç®€æ´ã€actionableï¼Œç”¨ä¸­æ–‡ã€‚`;

        const response = await fetch('http://localhost:3000/api/analyze/default', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ prompt })
        });

        if (!response.ok) {
            throw new Error(`æœåŠ¡å™¨è¿”å› ${response.status}`);
        }

        const data = await response.json();
        const analysis = data.analysis || data.message || 'æ— æ³•è·å¾—åˆ†æç»“æœ';
        
        resultDiv.textContent = analysis;
        resultDiv.style.display = 'block';
    } catch (error) {
        console.error('DeepSeek åˆ†æå¤±è´¥:', error);
        resultDiv.textContent = `âŒ åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š\n1. Node.js æœåŠ¡å™¨æ˜¯å¦è¿è¡Œï¼ˆç«¯å£ 3000ï¼‰\n2. ç½‘ç»œè¿æ¥\n3. DeepSeek API key æ˜¯å¦é…ç½®\n\né”™è¯¯ä¿¡æ¯ï¼š${error.message}`;
        resultDiv.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ¤– ç”Ÿæ´»æ´å¯Ÿæ·±åº¦åˆ†æ';
    }
}

function showShareOptions() {
    document.getElementById('share-options-modal').classList.add('show');
}

function closeShareOptions() {
    document.getElementById('share-options-modal').classList.remove('show');
}

function closeSharePreview() {
    document.getElementById('share-preview-modal').classList.remove('show');
}

function previewShareCard() {
    const selectedType = document.querySelector('input[name="share-type"]:checked').value;
    
    if (!selectedType) {
        alert('è¯·é€‰æ‹©åˆ†äº«å†…å®¹');
        return;
    }

    // å…³é—­é€‰é¡¹æ¨¡æ€ï¼Œæ‰“å¼€é¢„è§ˆæ¨¡æ€
    closeShareOptions();
    
    // ç”Ÿæˆåˆ†äº«å¡ç‰‡å¹¶æ˜¾ç¤ºé¢„è§ˆ
    setTimeout(() => {
        const canvas = createShareCard(selectedType);
        const imgDataUrl = canvas.toDataURL('image/png');
        document.getElementById('share-preview-image').src = imgDataUrl;
        document.getElementById('share-preview-modal').classList.add('show');
        
        // ä¿å­˜å½“å‰ç±»å‹ä¾›ä¸‹è½½ä½¿ç”¨
        window.currentShareType = selectedType;
    }, 100);
}

function downloadPreviewCard() {
    const canvas = createShareCard(window.currentShareType);
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    const now = new Date();
    const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    const typeNames = {
        'table': 'æ‰§è¡Œè¡¨',
        'combined': 'å®Œæ•´å‘¨æŠ¥',
        'analysis': 'æ•°æ®åˆ†æ',
        'reflection': 'å‘¨å¤ç›˜'
    };
    link.download = `life-script-${typeNames[window.currentShareType] || 'åˆ†äº«'}-${dateStr}.png`;
    link.click();
    
    closeSharePreview();
    alert('âœ… åˆ†äº«å›¾ç‰‡å·²ä¸‹è½½ï¼');
}

function createShareCard(type) {
    const width = 1200;
    let canvas = document.createElement('canvas');
    canvas.width = width;
    
    let ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    
    let y = 0;
    let contentHeight = 0;
    
    // æ ¹æ®ç±»å‹æ¸²æŸ“ä¸åŒå†…å®¹
    if (type === 'table') {
        // æœ¬å‘¨æ‰§è¡Œæƒ…å†µè¡¨ - é‡ç‚¹å±•ç¤º
        contentHeight = renderTableShareCard(ctx, width, y);
    } else if (type === 'combined') {
        // å®Œæ•´å‘¨æŠ¥ - è¡¨æ ¼ + åˆ†æ + å¤ç›˜ï¼ˆåˆå¹¶ï¼‰
        let currentY = 0;
        currentY += renderTableShareCard(ctx, width, currentY);
        currentY += 40; // é—´éš”
        currentY += renderAnalysisShareCard(ctx, width, currentY);
        currentY += 40; // é—´éš”
        currentY += renderReflectionShareCard(ctx, width, currentY);
        contentHeight = currentY;
    } else if (type === 'analysis') {
        // æ•°æ®åˆ†æå¡ç‰‡
        contentHeight = renderAnalysisShareCard(ctx, width, y);
    } else if (type === 'reflection') {
        // å¤ç›˜æ€è€ƒå¡ç‰‡
        contentHeight = renderReflectionShareCard(ctx, width, y);
    }
    
    // é‡æ–°è®¾ç½®ç”»å¸ƒé«˜åº¦ï¼ˆæ·»åŠ åº•éƒ¨å“ç‰Œï¼‰
    let totalHeight = contentHeight + 100;
    canvas.height = totalHeight;
    ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    
    // é‡æ–°ç»˜åˆ¶å†…å®¹
    y = 0;
    if (type === 'table') {
        renderTableShareCard(ctx, width, y);
    } else if (type === 'combined') {
        let currentY = 0;
        currentY += renderTableShareCard(ctx, width, currentY);
        currentY += 40;
        currentY += renderAnalysisShareCard(ctx, width, currentY);
        currentY += 40;
        currentY += renderReflectionShareCard(ctx, width, currentY);
    } else if (type === 'analysis') {
        renderAnalysisShareCard(ctx, width, y);
    } else if (type === 'reflection') {
        renderReflectionShareCard(ctx, width, y);
    }
    
    // åº•éƒ¨å“ç‰Œä¿¡æ¯
    ctx.fillStyle = '#999';
    ctx.font = 'italic 16px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('âœ¨ ç”¨ã€Œäººç”Ÿè„šæœ¬ã€è®°å½•ä½ çš„æˆé•¿', width / 2, totalHeight - 60);
    ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.fillText(`${new Date().getFullYear()}å¹´${new Date().getMonth() + 1}æœˆ${new Date().getDate()}æ—¥`, width / 2, totalHeight - 35);
    
    return canvas;
}

// æ¸²æŸ“è¡¨æ ¼åˆ†äº«å¡ç‰‡ï¼ˆæœ¬å‘¨æ‰§è¡Œæƒ…å†µï¼‰
function renderTableShareCard(ctx, width, startY) {
    let y = startY + 30;
    
    // æ ‡é¢˜
    ctx.fillStyle = '#333';
    ctx.font = 'bold 32px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ“Š æœ¬å‘¨æ‰§è¡Œæƒ…å†µè¡¨', width / 2, y);
    y += 60;
    
    // å‘¨ä¿¡æ¯
    const weekNum = getWeekNumber(new Date());
    ctx.font = '18px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.fillStyle = '#666';
    ctx.fillText(`${weekNum} Â· ${getWeekDateRange()}`, width / 2, y);
    y += 50;
    
    // è¡¨æ ¼å†…å®¹
    const cellWidth = (width - 80) / 8;
    const cellHeight = 35;
    const padding = 5;
    const startX = 40;
    
    // è¡¨å¤´è¡Œ
    const dayNames = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥', 'ç»Ÿè®¡'];
    ctx.fillStyle = '#667eea';
    ctx.fillRect(startX, y, width - 80, cellHeight);
    ctx.fillStyle = 'white';
    ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    
    dayNames.forEach((day, idx) => {
        ctx.fillText(day, startX + idx * cellWidth + cellWidth / 2, y + padding + 8);
    });
    y += cellHeight;
    
    // æ•°æ®è¡Œ - æ˜¾ç¤ºæ¯å¤©çš„å®Œæˆæƒ…å†µ
    const hours = Array.from({length: 17}, (_, i) => i + 6);
    
    hours.forEach(hour => {
        // å°æ—¶æ ‡ç­¾
        ctx.fillStyle = '#f5f5f5';
        ctx.fillRect(startX, y, width - 80, cellHeight);
        ctx.fillStyle = '#333';
        ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        ctx.textAlign = 'center';
        
        const hourStr = `${hour}:00`;
        ctx.fillText(hourStr, startX + cellWidth / 2 - 40, y + padding + 8);
        
        // æ¯å¤©çš„ä»»åŠ¡çŠ¶æ€
        let dayDones = 0;
        for (let day = 0; day < 7; day++) {
            const dayStr = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][day];
            const key = `${dayStr}-${hour}`;
            const task = weekData.tasks[key];
            
            const cellX = startX + (day + 1) * cellWidth;
            
            if (task) {
                if (task.status === 'done') {
                    ctx.fillStyle = '#4CAF50';
                    dayDones++;
                } else if (task.status === 'fail') {
                    const hasSkipReason = weekData.skipReasons && weekData.skipReasons[key];
                    ctx.fillStyle = hasSkipReason ? '#FFB74D' : '#FF6B6B';
                } else {
                    ctx.fillStyle = '#E0E0E0';
                }
                ctx.fillRect(cellX, y, cellWidth - 2, cellHeight);
                
                // æ˜¾ç¤ºemoji
                ctx.fillStyle = 'white';
                ctx.font = '16px Arial';
                const cat = CATEGORIES[task.category];
                if (cat && cat.emoji) {
                    ctx.fillText(cat.emoji.substring(0, 1), cellX + cellWidth / 2, y + padding + 5);
                }
            } else {
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                ctx.strokeRect(cellX, y, cellWidth - 2, cellHeight);
            }
        }
        
        // ç»Ÿè®¡åˆ—
        let total = 0, done = 0;
        for (let day = 0; day < 7; day++) {
            const dayStr = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][day];
            const key = `${dayStr}-${hour}`;
            const task = weekData.tasks[key];
            if (task) {
                total++;
                if (task.status === 'done') done++;
            }
        }
        
        const rate = total > 0 ? Math.round((done / total) * 100) : 0;
        ctx.fillStyle = '#333';
        ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(total > 0 ? `${done}/${total}` : '-', startX + 7.5 * cellWidth + cellWidth / 2, y + padding + 8);
        
        y += cellHeight;
    });
    
    // ç»Ÿè®¡ä¿¡æ¯
    y += 20;
    ctx.fillStyle = '#333';
    ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.textAlign = 'left';
    
    let totalTasks = 0, doneTasks = 0;
    Object.entries(weekData.tasks).forEach(([key, task]) => {
        const hasSkipReason = weekData.skipReasons && weekData.skipReasons[key];
        if (!hasSkipReason) {
            totalTasks++;
            if (task.status === 'done') doneTasks++;
        }
    });
    
    const completionRate = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
    ctx.fillText(`æ€»ä½“å®Œæˆåº¦: ${completionRate}% (${doneTasks}/${totalTasks}ä»»åŠ¡)`, startX, y);
    
    return y - startY + 40;
}

// æ¸²æŸ“åˆ†æåˆ†äº«å¡ç‰‡
function renderAnalysisShareCard(ctx, width, startY) {
    let y = startY + 30;
    
    ctx.fillStyle = '#333';
    ctx.font = 'bold 28px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ“ˆ æ•°æ®åˆ†æ', width / 2, y);
    y += 50;
    
    const stats = {};
    const categoryNames = appConfigCategories && appConfigCategories.length > 0 
        ? appConfigCategories.map(c => c.name) 
        : Object.keys(CATEGORIES);
    
    categoryNames.forEach(name => {
        stats[name] = { total: 0, done: 0 };
    });
    
    Object.entries(weekData.tasks).forEach(([key, task]) => {
        if (stats[task.category] !== undefined) {
            const hasSkipReason = weekData.skipReasons && weekData.skipReasons[key];
            if (!hasSkipReason) {
                stats[task.category].total++;
            }
            if (task.status === 'done') {
                stats[task.category].done++;
            }
        }
    });
    
    let totalTasks = 0, totalDone = 0;
    Object.values(stats).forEach(s => {
        totalTasks += s.total;
        totalDone += s.done;
    });
    
    const overallRate = totalTasks > 0 ? Math.round((totalDone / totalTasks) * 100) : 0;
    
    // æ€»ä½“å®Œæˆåº¦
    ctx.fillStyle = '#667eea';
    ctx.font = 'bold 48px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(`${overallRate}%`, width / 2, y);
    y += 60;
    
    // åˆ†ç±»ç»Ÿè®¡
    ctx.fillStyle = '#333';
    ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.textAlign = 'left';
    
    categoryNames.forEach(name => {
        const data = stats[name];
        if (data.total > 0) {
            const rate = Math.round((data.done / data.total) * 100);
            const cat = CATEGORIES[name] || { emoji: 'â­•', name };
            ctx.fillText(`${cat.emoji} ${cat.name}: ${data.done}/${data.total} (${rate}%)`, 40, y);
            y += 40;
        }
    });
    
    return y - startY + 20;
}

// æ¸²æŸ“å¤ç›˜åˆ†äº«å¡ç‰‡
function renderReflectionShareCard(ctx, width, startY) {
    let y = startY + 30;
    
    ctx.fillStyle = '#333';
    ctx.font = 'bold 28px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('âœï¸ å‘¨å¤ç›˜æ€è€ƒ', width / 2, y);
    y += 50;
    
    // è¾…åŠ©å‡½æ•°ï¼šæ¢è¡Œæ–‡æœ¬
    function drawWrappedText(text, x, y, maxWidth, lineHeight) {
        let currentY = y;
        const words = text.split('');
        let line = '';
        
        ctx.fillStyle = '#333';
        ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        ctx.textAlign = 'left';
        
        for (let char of words) {
            const metrics = ctx.measureText(line + char);
            if (metrics.width > maxWidth && line.length > 0) {
                ctx.fillText(line, x, currentY);
                line = char;
                currentY += lineHeight;
            } else {
                line += char;
            }
        }
        
        if (line.length > 0) {
            ctx.fillText(line, x, currentY);
            currentY += lineHeight;
        }
        
        return currentY - y;
    }
    
    // âœ… åšå¾—å¥½çš„
    ctx.fillStyle = '#4CAF50';
    ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('âœ… åšå¾—å¥½çš„:', 40, y);
    y += 35;
    const goodHeight = drawWrappedText(weekData.review.good || '(æœªå¡«å†™)', 50, y, width - 100, 25);
    y += goodHeight + 25;
    
    // âŒ ä¸è¶³ä¹‹å¤„
    ctx.fillStyle = '#FF6B6B';
    ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.fillText('âŒ ä¸è¶³ä¹‹å¤„:', 40, y);
    y += 35;
    const badHeight = drawWrappedText(weekData.review.bad || '(æœªå¡«å†™)', 50, y, width - 100, 25);
    y += badHeight + 25;
    
    // ğŸ’¡ ä¸‹å‘¨è®¡åˆ’
    ctx.fillStyle = '#FFB74D';
    ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    ctx.fillText('ğŸ’¡ ä¸‹å‘¨è®¡åˆ’:', 40, y);
    y += 35;
    const nextHeight = drawWrappedText(weekData.review.next || '(æœªå¡«å†™)', 50, y, width - 100, 25);
    y += nextHeight;
    
    return y - startY + 20;
}

init();

// ===== PWA Service Worker æ³¨å†Œ =====
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
            .then(reg => {
                console.log('[PWA] Service Worker æ³¨å†ŒæˆåŠŸ:', reg.scope);
            })
            .catch(err => {
                console.log('[PWA] Service Worker æ³¨å†Œå¤±è´¥:', err);
            });
    });
}

// ===== iOS Safari å®‰è£…æç¤º =====
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    // æ˜¾ç¤ºå®‰è£…æç¤ºï¼ˆå¯é€‰ï¼‰
    const installBanner = document.createElement('div');
    installBanner.style.cssText = `
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 1000;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    `;
    installBanner.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;">ğŸ“±</span>
            <div>
                <div style="font-weight: 600; font-size: 14px;">å®‰è£…ã€Œäººç”Ÿè„šæœ¬ã€</div>
                <div style="font-size: 11px; opacity: 0.9;">æ·»åŠ åˆ°ä¸»å±å¹•ï¼ŒåƒåŸç”ŸAppä¸€æ ·ä½¿ç”¨</div>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="install-dismiss" style="padding: 8px 16px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 6px; font-size: 12px; cursor: pointer;">æš‚ä¸</button>
            <button id="install-accept" style="padding: 8px 16px; background: white; border: none; color: #667eea; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">å®‰è£…</button>
        </div>
    `;
    document.body.appendChild(installBanner);

    document.getElementById('install-dismiss').addEventListener('click', () => {
        installBanner.remove();
    });

    document.getElementById('install-accept').addEventListener('click', async () => {
        installBanner.remove();
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`[PWA] å®‰è£…ç»“æœ: ${outcome}`);
            deferredPrompt = null;
        }
    });
});
</script>

</body>
</html>
