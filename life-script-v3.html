<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººç”Ÿè„šæœ¬ v3 - å‰§æœ¬æ—¶é—´ç®¡ç†</title>
    <style>
        :root {
            --bg: #F9FBFB;
            --text: #333;
            --sub: #999;
            --accent: #6C5CE7;
            --success: #D4F4DD;
            --danger: #F8D7DA;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #eee;
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent);
            margin: 0 0 5px 0;
        }
        .header-tagline {
            font-size: 12px;
            color: var(--sub);
            margin: 0 0 10px 0;
        }
        .week-info {
            font-size: 12px;
            color: var(--text);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #eee;
            overflow-x: auto;
        }
        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--sub);
            border-bottom: 3px solid transparent;
            transition: 0.2s;
            white-space: nowrap;
            font-size: 13px;
        }
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .tab-btn.tools {
            margin-left: auto;
            flex: 0 0 auto;
            color: #666;
        }
        .tab-btn.tools:hover {
            color: var(--accent);
        }

        .container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .view { display: none; }
        .view.active { display: block; }

        /* ===== é¦–æ¬¡ä½¿ç”¨å¼•å¯¼ ===== */
        .setup-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .setup-modal.show {
            display: flex;
        }
        .setup-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .setup-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            margin: 0 0 10px 0;
        }
        .setup-subtitle {
            font-size: 14px;
            color: var(--sub);
            margin: 0 0 30px 0;
        }
        .category-input-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border-left: 4px solid var(--accent);
        }
        .category-input-label {
            font-size: 12px;
            color: var(--sub);
            margin-bottom: 8px;
            display: block;
        }
        .category-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .category-input-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
        }
        .category-input-row input:first-child {
            flex: 0 0 50px;
        }
        .setup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        .btn-primary {
            flex: 1;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }

        /* ===== å‘¨è®¡åˆ’è§†å›¾ ===== */
        .week-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            font-size: 11px;
        }
        .week-table th, .week-table td {
            border: 1px solid #eee;
            padding: 6px;
            text-align: center;
            height: 30px;
        }
        .week-table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        .week-cell {
            cursor: pointer;
            transition: 0.2s;
        }
        .week-cell:hover {
            opacity: 0.8;
        }

        /* ===== ä»Šæ—¥æ‰“å¡ ===== */
        .date-selector {
            margin-bottom: 15px;
            background: white;
            padding: 12px;
            border-radius: 10px;
        }
        .date-selector-label {
            font-size: 12px;
            color: var(--sub);
            margin-bottom: 8px;
            display: block;
        }
        .date-btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .date-btn {
            padding: 8px 15px;
            background: white;
            color: var(--text);
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .date-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .today-grid {
            display: grid;
            gap: 10px;
        }
        .time-slot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 10px;
            border: 1px solid #eee;
            cursor: pointer;
        }
        .time-slot:hover {
            border-color: var(--accent);
        }
        .slot-info { flex: 1; }
        .slot-time {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .slot-tag {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #f0f0f0;
        }
        .slot-status {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }
        .slot-status.done { background: var(--success); border-color: #4caf50; }
        .slot-status.fail { background: var(--danger); border-color: #dc3545; }

        /* ===== å‘¨å®¡è§† ===== */
        .review-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            font-size: 11px;
            margin-bottom: 20px;
        }
        .review-table th, .review-table td {
            border: 1px solid #eee;
            padding: 6px;
            text-align: center;
            height: 30px;
        }
        .review-table th {
            background: #f5f5f5;
        }
        .review-cell {
            background: #f0f0f0;
        }
        .review-cell.done {
            background: var(--success);
        }
        .review-cell.fail {
            background: var(--danger);
        }

        .stats-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent);
        }
        .stats-box h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
        }
        .category-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        .category-stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .category-stat-value {
            font-weight: 600;
            font-size: 16px;
        }
        .insight-text {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            margin-top: 15px;
            font-size: 13px;
        }

        /* ===== å¤ç›˜æ€è€ƒ ===== */
        .review-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }
        .review-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .review-section textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
        }
        .review-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-analyze {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: var(--accent);
            color: white;
        }
        .analysis-result {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--accent);
            line-height: 1.6;
            white-space: pre-wrap;
            display: none;
            font-size: 13px;
        }

        /* ===== æ¨¡æ€æ¡† ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-box h3 {
            margin: 0 0 15px 0;
        }
        .category-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .cat-btn {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 12px;
        }
        .cat-btn.selected {
            border-color: var(--accent);
            background: rgba(108, 92, 231, 0.1);
        }
        .category-hint {
            font-size: 11px;
            color: var(--sub);
            margin-bottom: 10px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 6px;
        }
        .tag-history {
            margin-bottom: 10px;
            display: none;
        }
        .tag-history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .tag-history-btn {
            padding: 4px 10px;
            background: #eee;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }
        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-confirm {
            background: var(--accent);
            color: white;
        }
        .btn-cancel {
            background: #eee;
        }

        /* ===== å·¥å…·é¡µ ===== */
        .io-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .io-btn {
            padding: 10px 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }
        .io-btn:hover {
            background: #f5f5f5;
        }
        .categories-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .categories-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
        }
        .categories-table td {
            padding: 12px;
            border-top: 1px solid #eee;
            font-size: 12px;
        }
        .categories-table input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            width: 100%;
        }
        .edit-categories-btn {
            padding: 10px 15px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }
        #import-file {
            display: none;
        }

        .quick-fill-bar {
            margin-bottom: 15px;
            background: white;
            padding: 12px;
            border-radius: 10px;
            border-left: 4px solid var(--accent);
            display: none;
        }
        .quick-fill-bar.show {
            display: block;
        }
    </style>
</head>
<body>

<!-- é¦–æ¬¡ä½¿ç”¨å¼•å¯¼ -->
<div class="setup-modal" id="setup-modal">
    <div class="setup-box">
        <div class="setup-title">ğŸ¬ å¼€å§‹ä½ çš„äººç”Ÿè„šæœ¬</div>
        <div class="setup-subtitle">å®šä¹‰ä½ çš„4ä¸ªæ—¶é—´åˆ†ç±»ï¼Œå»ºç«‹ä¸“å±çš„æ—¶é—´ç®¡ç†ä½“ç³»</div>
        
        <div id="setup-categories"></div>
        
        <div style="font-size: 12px; color: var(--sub); margin: 20px 0;">
            ğŸ’¡ æç¤ºï¼šå‰4ä¸ªæ˜¯å¿…é€‰ï¼Œç¬¬5ä¸ªå¯é€‰ï¼ˆç”¨äºä¸ç¡®å®šçš„åˆ†ç±»ï¼‰
        </div>
        
        <div class="setup-buttons">
            <button class="btn-primary" onclick="completeSetup()">âœ“ å®Œæˆè®¾ç½®</button>
        </div>
    </div>
</div>

<div class="header">
    <div class="header-title">äººç”Ÿè„šæœ¬ v3</div>
    <div class="header-tagline">ä½ æ˜¯ä½ äººç”Ÿçš„å¯¼æ¼” Â· æ¯ä¸€å¤©éƒ½è¦ç²¾å½©çš„æ´»</div>
    <div class="week-info" id="week-info">
        <span>2026å¹´ç¬¬2å‘¨ Â· 1æœˆ6æ—¥ ~ 1æœˆ12æ—¥</span>
    </div>
    <div class="tabs">
        <button class="tab-btn active" data-tab="plan" onclick="switchTab('plan')">ğŸ“… å‘¨è®¡åˆ’</button>
        <button class="tab-btn" data-tab="today" onclick="switchTab('today')">âœ… ä»Šæ—¥æ‰“å¡</button>
        <button class="tab-btn" data-tab="review" onclick="switchTab('review')">ğŸ“Š å‘¨å®¡è§† & å¤ç›˜</button>
        <button class="tab-btn tools" data-tab="tools" onclick="switchTab('tools')">âš™ï¸ å·¥å…·</button>
    </div>
</div>

<div class="container">
    <!-- å‘¨è®¡åˆ’ -->
    <div class="view active" id="plan-view">
        <div class="quick-fill-bar" id="quick-fill-bar">
            <div style="font-size: 12px; color: var(--sub); margin-bottom: 8px;">âœ¨ å¿«é€Ÿæ’ç­æ¨¡å¼</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span id="quick-fill-tag" style="font-weight: 600;">å·²é€‰æ‹©ï¼š</span>
                <button style="padding: 6px 12px; background: #eee; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 12px;" onclick="exitQuickFill()">âœ• é€€å‡ºå¿«é€Ÿæ¨¡å¼</button>
                <button style="padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: auto;" onclick="confirmQuickFill()">âœ“ ç¡®è®¤å¡«å……</button>
            </div>
        </div>
        <table class="week-table" id="week-table">
            <tr>
                <th>æ—¶é—´</th>
                <th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th><th>å‘¨æ—¥</th>
            </tr>
        </table>
    </div>

    <!-- ä»Šæ—¥æ‰“å¡ -->
    <div class="view" id="today-view">
        <div class="date-selector">
            <div class="date-selector-label">ğŸ“… é€‰æ‹©æ—¥æœŸ</div>
            <div class="date-btn-group" id="date-btn-group"></div>
        </div>
        <div class="today-grid" id="today-grid"></div>
    </div>

    <!-- å‘¨å®¡è§† & å¤ç›˜ -->
    <div class="view" id="review-view">
        <table class="review-table" id="review-table">
            <tr>
                <th>æ—¶é—´</th>
                <th>å‘¨ä¸€</th><th>å‘¨äºŒ</th><th>å‘¨ä¸‰</th><th>å‘¨å››</th><th>å‘¨äº”</th><th>å‘¨å…­</th><th>å‘¨æ—¥</th>
            </tr>
        </table>

        <div class="stats-box">
            <h3>ğŸ“Š æœ¬å‘¨æ•°æ®åˆ†æ</h3>
            <div id="stats-content"></div>
        </div>

        <div class="stats-box">
            <h3>ğŸ’¡ AIæ´å¯Ÿ</h3>
            <div id="ai-insight" class="insight-text">å®Œæˆä¸€äº›ä»»åŠ¡åä¼šæ˜¾ç¤º</div>
        </div>

        <div style="border-top: 2px solid #eee; padding-top: 20px; margin-top: 20px;">
            <div class="review-section">
                <h3>âœ… æœ¬å‘¨åšå¾—å¾ˆå¥½çš„äº‹</h3>
                <textarea id="review-good" placeholder="ä¾‹å¦‚ï¼šåšæŒæ™¨è·‘..."></textarea>
            </div>
            <div class="review-section">
                <h3>âŒ æœ¬å‘¨æ²¡åšå¥½çš„åœ°æ–¹</h3>
                <textarea id="review-bad" placeholder="ä¾‹å¦‚ï¼šå‘¨æœ«æ²¡æœ‰é™ªä¼´å®¶äºº..."></textarea>
            </div>
            <div class="review-section">
                <h3>ğŸ’¡ ä¸‹å‘¨çš„æ”¹è¿›è®¡åˆ’</h3>
                <textarea id="review-next" placeholder="ä¾‹å¦‚ï¼šè°ƒæ•´æ—¶é—´å®‰æ’..."></textarea>
            </div>
            <div class="review-buttons">
                <button class="btn-analyze" onclick="generateAnalysis()">âœ¨ ç”Ÿæˆå®Œæ•´åˆ†æ</button>
                <button class="btn-analyze" style="background: #FF6B6B;" onclick="callDeepSeekAnalysis()">ğŸ¤– DeepSeekæ·±åº¦åˆ†æ</button>
            </div>
            <div class="analysis-result" id="analysis-result"></div>
        </div>
    </div>

    <!-- å·¥å…· -->
    <div class="view" id="tools-view">
        <div class="io-buttons">
            <button class="io-btn" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
            <button class="io-btn" onclick="document.getElementById('import-file').click()">ğŸ“¤ å¯¼å…¥æ•°æ®</button>
            <button class="io-btn" onclick="showEditCategories()" style="background: var(--accent); color: white;">âœï¸ ç¼–è¾‘åˆ†ç±»</button>
            <button class="io-btn" style="background: #FF6B6B; color: white;" onclick="showShareOptions()">ğŸ“¸ ç”Ÿæˆåˆ†äº«å¡ç‰‡</button>
            <button class="io-btn" onclick="clearAllData()" style="color: #dc3545;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
        </div>

        <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
            <h3 style="margin-top: 0;">ğŸ“‹ å½“å‰åˆ†ç±»é…ç½®</h3>
            <table class="categories-table" id="categories-display-table">
                <tr>
                    <th>Emoji</th>
                    <th>åˆ†ç±»åç§°</th>
                    <th style="text-align: center;">é¢œè‰²</th>
                </tr>
            </table>
        </div>

        <div style="background: white; padding: 20px; border-radius: 10px;">
            <h3 style="margin-top: 0;">ä½¿ç”¨è¯´æ˜</h3>
            <p>âœ… <strong>å‘¨è®¡åˆ’</strong> - è§„åˆ’æœ¬å‘¨ä»»åŠ¡ï¼Œæ”¯æŒå¿«é€Ÿæ‰¹é‡æ’ç­</p>
            <p>âœ… <strong>ä»Šæ—¥æ‰“å¡</strong> - é€‰æ‹©ä»»æ„æ—¥æœŸï¼Œæ ‡è®°å®Œæˆæƒ…å†µï¼ˆâ­•â†’âœ…â†’âŒï¼‰</p>
            <p>âœ… <strong>å‘¨å®¡è§† & å¤ç›˜</strong> - ä¸€ä½“åŒ–æŸ¥çœ‹æ‰§è¡Œæƒ…å†µã€æ•°æ®åˆ†æã€åæ€æ€»ç»“</p>
            <p>âœ… <strong>ç¼–è¾‘åˆ†ç±»</strong> - éšæ—¶ä¿®æ”¹ä½ çš„4-5ä¸ªåˆ†ç±»åç§°ã€é¢œè‰²å’Œemoji</p>
        </div>
    </div>
</div>

<!-- ä»»åŠ¡ç¼–è¾‘æ¨¡æ€ -->
<div class="modal" id="task-modal">
    <div class="modal-box">
        <h3>ç¼–è¾‘ä»»åŠ¡</h3>
        <h4 id="modal-time" style="color: var(--sub); margin: 0 0 15px 0;">å‘¨ä¸€ 7:00</h4>
        <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; display: block; margin-bottom: 8px;">é€‰æ‹©ç±»åˆ«</label>
            <div class="category-selector" id="category-selector"></div>
        </div>
        <div class="category-hint" id="category-hint"></div>
        <div class="tag-history" id="tag-history">
            <div style="font-size: 11px; color: var(--sub); margin-bottom: 6px;">ğŸ“š ä½ ä¹‹å‰ç”¨è¿‡çš„æ ‡ç­¾</div>
            <div class="tag-history-list" id="tag-history-list"></div>
        </div>
        <input type="text" class="modal-input" id="task-tag" placeholder="è¾“å…¥æ´»åŠ¨æ ‡ç­¾">
        <div class="modal-buttons">
            <button class="btn-confirm" onclick="saveTask()">âœ“ ç¡®è®¤</button>
            <button style="flex: 1; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer;" onclick="enterQuickFill()">âš¡ å¿«é€Ÿæ’ç­</button>
            <button class="btn-cancel" onclick="closeModal()">âœ• å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- åˆ†ç±»ç¼–è¾‘æ¨¡æ€ -->
<div class="modal" id="edit-categories-modal">
    <div class="modal-box" style="max-width: 500px;">
        <h3>ç¼–è¾‘åˆ†ç±»</h3>
        <div id="edit-categories-content"></div>
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="btn-confirm" onclick="saveCategories()">âœ“ ä¿å­˜ä¿®æ”¹</button>
            <button class="btn-cancel" onclick="closeEditCategoriesModal()">âœ• å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- åˆ†äº«é€‰é¡¹é¢æ¿ -->
<div class="modal" id="share-options-modal">
    <div class="modal-box" style="max-width: 450px;">
        <h3>ğŸ“¸ é€‰æ‹©åˆ†äº«å†…å®¹</h3>
        <p style="color: var(--sub); font-size: 12px; margin-bottom: 20px;">é€‰æ‹©ä½ è¦åˆ†äº«çš„å¡ç‰‡ç±»å‹</p>
        
        <div style="display: grid; gap: 12px;">
            <button style="padding: 15px; background: white; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='#ddd'" onclick="generateShareCard('overview')">
                <div style="font-weight: 600; margin-bottom: 4px;">ğŸ“Š å‘¨æ€»ç»“å¡ç‰‡</div>
                <div style="font-size: 12px; color: var(--sub);">å®Œæˆç‡ + å››åˆ†ç±»å æ¯” + Logo</div>
            </button>
            
            <button style="padding: 15px; background: white; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='#ddd'" onclick="generateShareCard('plan')">
                <div style="font-weight: 600; margin-bottom: 4px;">ğŸ“… å‘¨è®¡åˆ’è¡¨</div>
                <div style="font-size: 12px; color: var(--sub);">å®Œæ•´çš„å‘¨è®¡åˆ’è¡¨æ ¼ï¼ˆ7å¤©Ã—17å°æ—¶ï¼‰</div>
            </button>
            
            <button style="padding: 15px; background: white; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='#ddd'" onclick="generateShareCard('review')">
                <div style="font-weight: 600; margin-bottom: 4px;">ğŸ“Š å‘¨å®¡è§†è¡¨</div>
                <div style="font-size: 12px; color: var(--sub);">æ‰§è¡Œæƒ…å†µä¸€è§ˆï¼ˆå®Œæˆâœ… / å¤±è´¥âŒï¼‰</div>
            </button>
            
            <button style="padding: 15px; background: white; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='#ddd'" onclick="generateShareCard('insight')">
                <div style="font-weight: 600; margin-bottom: 4px;">ğŸ’¡ AIæ´å¯Ÿå¡</div>
                <div style="font-size: 12px; color: var(--sub);">æ•°æ®åˆ†æ + çŸ¥è¡Œåˆä¸€ + ä¸ªæ€§è¯„ä»·</div>
            </button>
            
            <button style="padding: 15px; background: white; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; text-align: left; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='#ddd'" onclick="generateShareCard('reflection')">
                <div style="font-weight: 600; margin-bottom: 4px;">ğŸ“ å¤ç›˜å¡ç‰‡</div>
                <div style="font-size: 12px; color: var(--sub);">æœ¬å‘¨å¤ç›˜ + æ”¹è¿›è®¡åˆ’</div>
            </button>
        </div>
        
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="btn-cancel" onclick="closeShareOptionsModal()" style="width: 100%;">âœ• å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- FailåŸå› é€‰æ‹©æ¨¡æ€ -->
<div class="modal" id="fail-reason-modal">
    <div class="modal-box">
        <h3>è¿™ä¸ªå°æ—¶ä½ åœ¨åšä»€ä¹ˆï¼Ÿ</h3>
        <p style="color: var(--sub); font-size: 12px; margin-bottom: 20px;">å¸®æˆ‘ä»¬è¿½è¸ªçœŸå®çš„æ—¶é—´ç”¨é€”ï¼Œè¿™æ ·åˆ†ææ‰æ›´å‡†ç¡®</p>
        <div style="display: grid; gap: 10px;">
            <button style="padding: 15px; background: #FFE8E8; border: 1px solid #FFB8B8; border-radius: 8px; cursor: pointer; text-align: left;" onclick="selectFailReason('overtimeWork')">
                <div style="font-weight: 600; margin-bottom: 4px;">ğŸ’¼ åŠ ç­æˆ–å·¥ä½œ</div>
                <div style="font-size: 12px; color: var(--sub);">è®¡åˆ’çš„å…¶ä»–äº‹åŠ¡æ²¡åšï¼Œä½†å·¥ä½œè¶…æ—¶äº†</div>
            </button>
            <button style="padding: 15px; background: #E8F5E9; border: 1px solid #B8D9B8; border-radius: 8px; cursor: pointer; text-align: left;" onclick="selectFailReason('leisure')">
                <div style="font-weight: 600; margin-bottom: 4px;">ğŸ¬ ä¼‘é—²å¨±ä¹</div>
                <div style="font-size: 12px; color: var(--sub);">è¿½å‰§ã€åˆ·æ‰‹æœºã€ç©æ¸¸æˆç­‰å¨±ä¹æ´»åŠ¨</div>
            </button>
            <button style="padding: 15px; background: #FFF3E0; border: 1px solid #FFD89B; border-radius: 8px; cursor: pointer; text-align: left;" onclick="selectFailReason('other')">
                <div style="font-weight: 600; margin-bottom: 4px;">â“ å…¶ä»–</div>
                <div style="font-size: 12px; color: var(--sub);">çªå‘æƒ…å†µã€ä¼‘æ¯æˆ–å…¶ä»–æœªè®¡åˆ’çš„äº‹</div>
            </button>
        </div>
        <div style="margin-top: 20px;">
            <button class="btn-cancel" onclick="closeFailReasonModal()" style="width: 100%;">âœ• å–æ¶ˆ</button>
        </div>
    </div>
</div>

<input type="file" id="import-file" accept=".json" onchange="importData(event)">

<!-- éšè—Canvasç”¨äºç”Ÿæˆå¡ç‰‡ -->
<canvas id="share-canvas" style="display: none;"></canvas>

<script>
const HOURS = Array.from({length: 17}, (_, i) => i + 7);
const DAYS = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];

let appConfig = {
    categories: null // ä¼šä» localStorage è¯»å–æˆ–é¦–æ¬¡è®¾ç½®
};

let weekData = { tasks: {}, review: { good: '', bad: '', next: '' } };
let tagCategoryMap = {};
let tagHistory = {};
let selectedCategory = null;
let selectedSlot = null;
let quickFillMode = false;
let quickFillData = null;
let checkinDay = -1;
let editingCategoriesTemp = null;
let pendingFailKey = null; // ç”¨äºfailåŸå› é€‰æ‹©

// ===== åˆå§‹åŒ– =====
function init() {
    console.log('=== INIT START ===');

    try {
        // æ”¯æŒé€šè¿‡ URL å‚æ•°å¼ºåˆ¶é‡ç½®ï¼ˆ?reset=1ï¼‰ç”¨äºè°ƒè¯•
        const params = new URLSearchParams(window.location.search);
        const forceReset = params.get('reset') === '1';
        if (forceReset) {
            console.log('ğŸ” URL reset flag detected â€” clearing localStorage keys');
            localStorage.removeItem('life-script-v3-data');
            localStorage.removeItem('life-script-data'); // ä¹Ÿæ¸…é™¤è€ç‰ˆæœ¬çš„æ•°æ®
        }

        // 1. åŠ è½½æ•°æ®
        loadData();
        console.log('âœ… Data loaded');
        console.log('  - appConfig.categories:', appConfig?.categories?.length || 0);
        console.log('  - weekData.tasks:', Object.keys(weekData?.tasks || {}).length);

        // 2. åˆå§‹åŒ–é»˜è®¤æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
        // ç¡®ä¿ appConfig.categories æ€»æ˜¯å­˜åœ¨ä¸”æœ‰æ•ˆ
        if (!appConfig || !appConfig.categories || appConfig.categories.length === 0) {
            console.log('âš ï¸ No categories found, initializing defaults...');

            appConfig = {
                categories: [
                    { name: 'å¥åº·ä¹ æƒ¯', emoji: 'ğŸ”µ', color: '#AECBFA' },
                    { name: 'å®¶åº­æ—¶é—´', emoji: 'ğŸŸ¡', color: '#FDE293' },
                    { name: 'å·¥ä½œæ—¶é—´', emoji: 'ğŸ’š', color: '#CCF0DF' },
                    { name: 'è‡ªæˆ‘æˆé•¿', emoji: 'ğŸ’œ', color: '#D4BBFF' },
                    { name: 'å…¶ä»–', emoji: 'âšª', color: '#E8E8E8' }
                ]
            };

            tagHistory = {};
            appConfig.categories.forEach(cat => {
                tagHistory[cat.name] = [];
            });

            if (!weekData.tasks) weekData.tasks = {};
            if (Object.keys(weekData.tasks).length === 0) {
                weekData.tasks = {
                    '0-9': { category: 'å·¥ä½œæ—¶é—´', tag: 'æ™¨ä¼š', status: 'plan' },
                    '0-10': { category: 'å·¥ä½œæ—¶é—´', tag: 'ç¼–ç ', status: 'plan' },
                    '1-14': { category: 'å¥åº·ä¹ æƒ¯', tag: 'åˆä¼‘', status: 'plan' },
                    '2-19': { category: 'è‡ªæˆ‘æˆé•¿', tag: 'é˜…è¯»', status: 'plan' },
                    '5-18': { category: 'å®¶åº­æ—¶é—´', tag: 'å®¶åŠ¡', status: 'plan' }
                };
            }

            saveData();
            console.log('âœ… Default data initialized and saved');
        }

        // 3. ç¡®ä¿weekDataç»“æ„å®Œæ•´
        if (!weekData.review) {
            weekData.review = { good: '', bad: '', next: '' };
        }
        if (!weekData.tasks) {
            weekData.tasks = {};
        }

        console.log('âœ… Data structure validated');
        console.log('  - appConfig.categories:', appConfig?.categories?.length || 0);
        console.log('  - weekData.tasks:', Object.keys(weekData?.tasks || {}).length);

        // 4. æ¸²æŸ“åº”ç”¨
        console.log('ğŸ“Š Rendering app...');
        renderApp();
        console.log('âœ… renderApp() completed');
        console.log('=== INIT COMPLETE ===');

        // 5. æ·»åŠ é¡µé¢å†…è°ƒè¯•é¢æ¿ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼Œå¯ç§»é™¤ï¼‰
        addDebugPanel();

    } catch (error) {
        console.error('âŒ FATAL ERROR in init():', error);
        console.error('Stack:', error.stack);

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        const errorDiv = document.createElement('div');
        errorDiv.innerHTML = `<div style="padding: 20px; background: #ffebee; color: #c62828; border-radius: 8px; margin: 20px; font-family: monospace; white-space: pre-wrap; word-break: break-all;">âŒ åˆå§‹åŒ–å¤±è´¥:\n${error.message}\n\n${error.stack}</div>`;
        document.body.appendChild(errorDiv);
    }
}

function addDebugPanel() {
    if (document.getElementById('debug-panel')) return;
    const panel = document.createElement('div');
    panel.id = 'debug-panel';
    panel.style.cssText = 'position: fixed; right: 18px; bottom: 18px; background: rgba(255,255,255,0.95); border: 1px solid #eee; padding: 10px; border-radius: 8px; z-index:2000; font-size:12px; width:220px; box-shadow:0 6px 18px rgba(0,0,0,0.08);';
    panel.innerHTML = `
        <div style="font-weight:600; margin-bottom:6px;">è°ƒè¯•é¢æ¿</div>
        <div id="debug-summary" style="max-height:120px; overflow:auto; font-size:12px; color:#333; margin-bottom:8px;"></div>
        <div style="display:flex; gap:6px;">
            <button id="dbg-reset" style="flex:1; padding:6px; font-size:12px;">é‡ç½®æ•°æ®</button>
            <button id="dbg-render" style="flex:1; padding:6px; font-size:12px;">é‡æ¸²æŸ“</button>
        </div>
        <div style="margin-top:6px; text-align:right;"><button id="dbg-print" style="padding:4px 6px; font-size:11px;">æ‰“å°</button></div>
    `;
    document.body.appendChild(panel);

    function updateSummary() {
        const s = document.getElementById('debug-summary');
        const cats = appConfig && appConfig.categories ? appConfig.categories.map(c => c.name).join(', ') : '(æ— )';
        const tasks = weekData && weekData.tasks ? Object.keys(weekData.tasks).length : 0;
        s.textContent = `åˆ†ç±»: ${cats}\nä»»åŠ¡æ•°: ${tasks}`;
    }
    updateSummary();

    document.getElementById('dbg-reset').onclick = () => {
        if (!confirm('ç¡®è®¤æ¸…ç©ºå¹¶é‡ç½®æœ¬åœ°æ•°æ®ï¼Ÿï¼ˆæµ‹è¯•ç”¨ï¼‰')) return;
        localStorage.removeItem('life-script-v3-data');
        location.href = location.pathname + '?reset=1';
    };
    document.getElementById('dbg-render').onclick = () => {
        try { renderApp(); updateSummary(); alert('å·²é‡æ¸²æŸ“'); } catch(e) { alert('é‡æ¸²æŸ“å¤±è´¥ï¼š'+e.message); }
    };
    document.getElementById('dbg-print').onclick = () => {
        console.log('DEBUG appConfig:', appConfig);
        console.log('DEBUG weekData.tasks keys:', Object.keys(weekData.tasks || {}));
        alert('å·²æ‰“å°åˆ°æ§åˆ¶å°');
    };
}

function showSetupModal() {
    const modal = document.getElementById('setup-modal');
    let html = '';
    
    // é»˜è®¤åˆ†ç±»å»ºè®®
    const defaultCategories = [
        { name: 'å¥åº·ä¹ æƒ¯', emoji: 'ğŸ”µ', color: '#AECBFA' },
        { name: 'å®¶åº­æ—¶é—´', emoji: 'ğŸŸ¡', color: '#FDE293' },
        { name: 'å·¥ä½œæ—¶é—´', emoji: 'ğŸ’š', color: '#CCF0DF' },
        { name: 'è‡ªæˆ‘æˆé•¿', emoji: 'ğŸ’œ', color: '#D4BBFF' },
        { name: 'å…¶ä»–', emoji: 'âšª', color: '#E8E8E8' }
    ];
    
    const setupCategories = document.getElementById('setup-categories');
    defaultCategories.forEach((cat, idx) => {
        const isOptional = idx >= 4;
        html += `
            <div class="category-input-group">
                <label class="category-input-label">${isOptional ? 'ğŸ”¹ å¯é€‰' : 'â­ å¿…é€‰'} - åˆ†ç±» ${idx + 1}</label>
                <div class="category-input-row">
                    <input type="text" id="setup-emoji-${idx}" placeholder="ğŸ”µ" value="${cat.emoji}" maxlength="2">
                    <input type="text" id="setup-name-${idx}" placeholder="åˆ†ç±»åç§°" value="${cat.name}">
                    <input type="color" id="setup-color-${idx}" value="${cat.color}">
                </div>
            </div>
        `;
    });
    
    setupCategories.innerHTML = html;
    modal.classList.add('show');
}

function completeSetup() {
    const categories = [];
    for (let i = 0; i < 5; i++) {
        const name = document.getElementById(`setup-name-${i}`).value.trim();
        const emoji = document.getElementById(`setup-emoji-${i}`).value.trim();
        const color = document.getElementById(`setup-color-${i}`).value;
        
        if (i < 4 && !name) {
            alert('å‰4ä¸ªåˆ†ç±»å¿…é¡»å¡«å†™');
            return;
        }
        
        if (name) {
            categories.push({ name, emoji, color });
        }
    }
    
    appConfig.categories = categories;
    tagHistory = {};
    categories.forEach(cat => {
        tagHistory[cat.name] = [];
    });
    
    saveData();
    document.getElementById('setup-modal').classList.remove('show');
    renderApp();
}

function renderApp() {
    console.log('ğŸ“Š renderApp() called with:', {
        hasCategories: !!appConfig?.categories,
        categoryCount: appConfig?.categories?.length || 0,
        taskCount: Object.keys(weekData?.tasks || {}).length
    });
    
    // ç«‹å³æ›´æ–°å‘¨ä¿¡æ¯
    updateWeekInfo();
    
    // æ¸²æŸ“å‘¨è®¡åˆ’è¡¨
    try {
        renderWeekPlan();
    } catch(e) { console.error('âŒ renderWeekPlan:', e); }
    
    // æ¸²æŸ“ä»Šæ—¥æ‰“å¡
    try {
        renderDateSelector();
        renderTodayView();
    } catch(e) { console.error('âŒ renderTodayView:', e); }
    
    // æ¸²æŸ“å‘¨å®¡è§†
    try {
        renderWeekReview();
    } catch(e) { console.error('âŒ renderWeekReview:', e); }
    
    // æ¸²æŸ“åˆ†ç±»æ˜¾ç¤º
    try {
        renderCategoriesDisplay();
    } catch(e) { console.error('âŒ renderCategoriesDisplay:', e); }
    
    // åŠ è½½å¤ç›˜æ•°æ®
    try {
        loadReviewData();
    } catch(e) { console.error('âŒ loadReviewData:', e); }
    
    console.log('âœ… renderApp() completed');
}

function loadData() {
    // é¦–å…ˆå°è¯•è¯»å– v3 æ–°æ ¼å¼
    let stored = localStorage.getItem('life-script-v3-data');
    if (stored) {
        try {
            const data = JSON.parse(stored);
            appConfig = data.appConfig || appConfig;
            weekData = data.weekData || weekData;
            tagCategoryMap = data.tagCategoryMap || tagCategoryMap;
            tagHistory = data.tagHistory || tagHistory;
            console.log('âœ… Loaded v3 data from localStorage');
            return;
        } catch (e) {
            console.error('Failed to parse v3 localStorage data:', e);
        }
    }
    
    // å¦‚æœæ²¡æœ‰ v3 æ•°æ®ï¼Œå°è¯•è¯»å– v2 è€ç‰ˆæœ¬æ•°æ®
    stored = localStorage.getItem('life-script-data');
    if (stored) {
        try {
            const data = JSON.parse(stored);
            weekData = data.weekData || weekData;
            tagCategoryMap = data.tagCategoryMap || tagCategoryMap;
            tagHistory = data.tagHistory || tagHistory;
            console.log('âœ… Loaded v2 data from localStorage (will be migrated)');
            // v2 æ•°æ®æ²¡æœ‰ appConfigï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼
            return;
        } catch (e) {
            console.error('Failed to parse v2 localStorage data:', e);
        }
    }
    
    console.log('â„¹ï¸ No localStorage data found, will use defaults');
}

function saveData() {
    const data = { appConfig, weekData, tagCategoryMap, tagHistory };
    localStorage.setItem('life-script-v3-data', JSON.stringify(data));
}

function updateWeekInfo() {
    const now = new Date();
    const year = now.getFullYear();
    const firstDay = new Date(year, 0, 1);
    const pastDaysOfYear = (now - firstDay) / 86400000;
    const week = Math.ceil((pastDaysOfYear + firstDay.getDay() + 1) / 7);
    
    const dayOfWeek = now.getDay() || 7;
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - dayOfWeek + 1);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);

    const startMonth = weekStart.getMonth() + 1;
    const startDate = weekStart.getDate();
    const endMonth = weekEnd.getMonth() + 1;
    const endDate = weekEnd.getDate();

    document.getElementById('week-info').textContent = 
        `${year}å¹´ç¬¬${week}å‘¨ Â· ${startMonth}æœˆ${startDate}æ—¥ ~ ${endMonth}æœˆ${endDate}æ—¥`;
}

function switchTab(tab) {
    try {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        const viewMap = {
            plan: 'plan-view',
            today: 'today-view',
            review: 'review-view',
            tools: 'tools-view'
        };
        
        if (viewMap[tab]) {
            // åˆ‡æ¢åˆ°å¯¹åº”çš„view
            const viewEl = document.getElementById(viewMap[tab]);
            if (viewEl) {
                viewEl.classList.add('active');
                console.log('âœ… Switched to view:', viewMap[tab]);
            } else {
                console.warn('View not found:', viewMap[tab]);
            }
            
            // ä½¿ç”¨data-tabå±æ€§æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®
            const btn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
            if (btn) {
                btn.classList.add('active');
                console.log('âœ… Activated button for tab:', tab);
            } else {
                console.warn('Button not found for tab:', tab);
            }
        }
    } catch (e) {
        console.error('Error in switchTab:', e);
    }
}

function getCategoryByName(name) {
    if (!appConfig || !appConfig.categories) {
        return null;
    }
    return appConfig.categories.find(c => c.name === name);
}

function renderDateSelector() {
    let html = '<button class="date-btn active" onclick="switchCheckinDay(-1)" style="background: var(--accent); color: white;">ğŸ“ ä»Šæ—¥</button>';
    DAYS.forEach((day, idx) => {
        html += `<button class="date-btn" onclick="switchCheckinDay(${idx})">å‘¨${['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][idx]}</button>`;
    });
    
    document.getElementById('date-btn-group').innerHTML = html;
}

function renderWeekPlan() {
    try {
        console.log('renderWeekPlan: appConfig.categories=', appConfig?.categories?.length, 'tasks=', Object.keys(weekData?.tasks||{}).length);
        
        let html = '<tr><th>æ—¶é—´</th>';
        DAYS.forEach(d => html += `<th>${d}</th>`);
        html += '</tr>';
        
        HOURS.forEach(hour => {
            html += `<tr><td style="background: #f5f5f5; font-weight: 500;">${hour}:00</td>`;
            for (let day = 0; day < 7; day++) {
                const key = `${day}-${hour}`;
                const task = weekData.tasks[key];
                if (task) {
                    const cat = getCategoryByName(task.category);
                    const bgColor = cat && cat.color ? cat.color : '#CCCCCC';
                    const displayText = task.tag ? task.tag : '(æ— )';
                    html += `<td class="week-cell" style="background: ${bgColor}; cursor: pointer;" onclick="handleWeekCellClick(${day}, ${hour})">${displayText}</td>`;
                } else {
                    html += `<td class="week-cell" style="cursor: pointer;" onclick="handleWeekCellClick(${day}, ${hour})"></td>`;
                }
            }
            html += '</tr>';
        });
        const table = document.getElementById('week-table');
        if (table) {
            table.innerHTML = html;
            console.log('âœ… week-table updated');
        } else {
            console.error('âŒ week-table element not found');
        }
    } catch (e) {
        console.error('âŒ Error in renderWeekPlan:', e);
    }
}

function handleWeekCellClick(day, hour) {
    if (quickFillMode) {
        const key = `${day}-${hour}`;
        weekData.tasks[key] = { 
            category: quickFillData.category, 
            tag: quickFillData.tag, 
            status: 'plan' 
        };
        renderWeekPlan();
    } else {
        openEditModal(day, hour);
    }
}

function renderTodayView() {
    try {
        console.log('renderTodayView: checkinDay=', checkinDay);
        
        const now = new Date();
        let dayIndex = checkinDay === -1 ? (now.getDay() || 7) - 1 : checkinDay;
        let html = '';
        
        HOURS.forEach(hour => {
            const key = `${dayIndex}-${hour}`;
            const task = weekData.tasks[key];
            if (task) {
                const cat = getCategoryByName(task.category);
                const emoji = cat ? cat.emoji : 'â­•';
                const statusClass = task.status === 'done' ? 'done' : task.status === 'fail' ? 'fail' : '';
                const status = task.status === 'done' ? 'âœ…' : task.status === 'fail' ? 'âŒ' : 'â­•';
                html += `
                    <div class="time-slot">
                        <div class="slot-info">
                            <div class="slot-time">${hour}:00</div>
                            <div>${emoji} <span class="slot-tag">${task.tag}</span></div>
                        </div>
                        <div class="slot-status ${statusClass}" onclick="toggleStatus('${key}')">${status}</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="time-slot" onclick="openEditModal(${dayIndex}, ${hour})">
                        <div class="slot-info">
                            <div class="slot-time">${hour}:00</div>
                            <div style="color: #ccc;">æœªå®‰æ’</div>
                        </div>
                        <div style="color: #999;">+</div>
                    </div>
                `;
            }
        });
        document.getElementById('today-grid').innerHTML = html;
        console.log('âœ… today-grid updated');
    } catch (e) {
        console.error('âŒ Error in renderTodayView:', e);
    }
}

function renderWeekReview() {
    try {
        console.log('renderWeekReview');
        
        let html = '<tr><th>æ—¶é—´</th>';
        DAYS.forEach(d => html += `<th>${d}</th>`);
        html += '</tr>';
        
        HOURS.forEach(hour => {
            html += `<tr><td style="background: #f5f5f5;">${hour}:00</td>`;
            for (let day = 0; day < 7; day++) {
                const key = `${day}-${hour}`;
                const task = weekData.tasks[key];
                let cellClass = 'review-cell';
                let content = '';
                
                if (task) {
                    if (task.status === 'done') {
                        cellClass = 'review-cell done';
                        content = 'âœ…';
                    } else if (task.status === 'fail') {
                        cellClass = 'review-cell fail';
                        content = 'âŒ';
                    } else {
                        cellClass = 'review-cell';
                        content = 'â­•';
                    }
                }
                html += `<td class="${cellClass}">${content}</td>`;
            }
            html += '</tr>';
        });
        document.getElementById('review-table').innerHTML = html;
        updateStats();
        console.log('âœ… review-table updated');
    } catch (e) {
        console.error('âŒ Error in renderWeekReview:', e);
    }
}

function updateStats() {
    try {
        console.log('updateStats');
        
        const stats = {};
        appConfig.categories.forEach(cat => {
            stats[cat.name] = { total: 0, done: 0 };
        });

        Object.entries(weekData.tasks).forEach(([key, task]) => {
            if (stats[task.category]) {
                stats[task.category].total++;
                if (task.status === 'done') {
                    stats[task.category].done++;
                }
            }
        });

        let html = '';
        let totalTasks = 0;
        let totalDone = 0;

        appConfig.categories.forEach(cat => {
            const data = stats[cat.name];
            totalTasks += data.total;
            totalDone += data.done;
            const percentage = data.total > 0 ? Math.round((data.done / data.total) * 100) : 0;
            html += `
                <div class="category-stat">
                    <div class="category-stat-label">
                        <span>${cat.emoji}</span>
                        <span>${cat.name}</span>
                    </div>
                    <div style="text-align: right;">
                        <div class="category-stat-value">${percentage}%</div>
                    <div style="font-size: 11px; color: var(--sub);">${data.done}/${data.total}</div>
                </div>
            </div>
        `;
        });

        document.getElementById('stats-content').innerHTML = html;
        generateInsight(stats, totalTasks, totalDone);
        console.log('âœ… stats updated');
    } catch (e) {
        console.error('âŒ Error in updateStats:', e);
    }
}

function generateInsight(stats, totalTasks, totalDone) {
    if (totalTasks === 0) {
        document.getElementById('ai-insight').textContent = 'è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œèµ¶å¿«è§„åˆ’ä½ çš„ä¸€å‘¨å§ï¼';
        return;
    }

    const totalFailed = Object.values(weekData.tasks).filter(t => t.status === 'fail').length;
    const overallRate = Math.round((totalDone / totalTasks) * 100);
    const failRate = Math.round((totalFailed / totalTasks) * 100);
    
    let insight = `ğŸ“Š æœ¬å‘¨æˆç»©å¡\n`;
    insight += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    insight += `âœ… å®Œæˆç‡ï¼š${overallRate}%  |  ${totalDone}/${totalTasks}ä»»åŠ¡å®Œæˆ\n`;
    insight += `âŒ å¤±è´¥ç‡ï¼š${failRate}%  |  ${totalFailed}ä¸ªä»»åŠ¡æœªå®Œæˆ\n\n`;

    // çŸ¥è¡Œåˆä¸€åˆ†æ
    if (overallRate < 50) {
        insight += `âš ï¸ çŸ¥è¡Œåˆä¸€è­¦å‘Šï¼š\næ‰§è¡ŒåŠ›åä½ï¼Œè®¡åˆ’å’Œå®é™…æœ‰è¾ƒå¤§åå·®ã€‚\n${failRate > 30 ? 'å»ºè®®ï¼šé™ä½å‘¨è®¡åˆ’éš¾åº¦ï¼Œæˆ–æ£€æŸ¥æ˜¯å¦æœ‰å¤–ç•Œå¹²æ‰°å› ç´ ã€‚' : 'å»ºè®®ï¼šæå‡æ‰§è¡ŒåŠ›ï¼Œå¯å°è¯•ç•ªèŒ„å·¥ä½œæ³•ã€‚'}\n\n`;
    } else if (overallRate > 80) {
        insight += `ğŸŒŸ çŸ¥è¡Œåˆä¸€ä¼˜ç§€ï¼š\nä½ çš„è®¡åˆ’å’Œæ‰§è¡Œé«˜åº¦åŒ¹é…ï¼Œè¯´æ˜è‡ªå¾‹æ€§å¾ˆå¼ºï¼\n`;
    }

    // æ—¶é—´ç¼ºå¤±åˆ†æ
    if (totalFailed > 0) {
        const failReasons = weekData.failReasons || {};
        const overtimeCount = Object.values(failReasons).filter(r => r.reason === 'overtimeWork').length;
        const leisureCount = Object.values(failReasons).filter(r => r.reason === 'leisure').length;
        
        insight += `ğŸ” æ—¶é—´å»å‘åˆ†æï¼š\n`;
        if (overtimeCount > 0) {
            insight += `â€¢ åŠ ç­ç‹‚é­”ï¼š${overtimeCount}å°æ—¶è¶…æ—¶å·¥ä½œ\n`;
        }
        if (leisureCount > 0) {
            insight += `â€¢ ä¼‘é—²å¨±ä¹ï¼š${leisureCount}å°æ—¶è¿½å‰§/å¨±ä¹\n`;
        }
        if (totalFailed - overtimeCount - leisureCount > 0) {
            insight += `â€¢ å…¶ä»–åŸå› ï¼š${totalFailed - overtimeCount - leisureCount}å°æ—¶\n`;
        }
        insight += '\n';
    }

    // åˆ†ç±»è¡¨ç°æ’å
    const categories = appConfig.categories.slice(0, 4);
    const categoryRanking = categories.map(cat => ({
        name: cat.name,
        emoji: cat.emoji,
        total: stats[cat.name].total,
        done: stats[cat.name].done,
        rate: stats[cat.name].total > 0 ? Math.round((stats[cat.name].done / stats[cat.name].total) * 100) : 0
    })).sort((a, b) => b.rate - a.rate);

    insight += `ğŸ† åˆ†ç±»è¡¨ç°æ’è¡Œï¼š\n`;
    categoryRanking.forEach((cat, idx) => {
        if (cat.total > 0) {
            const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : '  ';
            insight += `${medal} ${cat.emoji} ${cat.name}ï¼š${cat.rate}% (${cat.done}/${cat.total})\n`;
        }
    });

    // æ—¶é—´å æ¯”åˆ†æ
    const totalHours = Object.values(stats).reduce((sum, s) => sum + s.total, 0);
    insight += `\nâ° æœ¬å‘¨æ—¶é—´åˆ†é…ï¼ˆ${totalHours}å°æ—¶ï¼‰ï¼š\n`;
    appConfig.categories.slice(0, 4).forEach(cat => {
        if (stats[cat.name].total > 0) {
            const percent = Math.round((stats[cat.name].total / totalHours) * 100);
            const bar = 'â–ˆ'.repeat(Math.floor(percent / 5)) + 'â–‘'.repeat(20 - Math.floor(percent / 5));
            insight += `${cat.emoji} ${cat.name.padEnd(6)} ${bar} ${percent}%\n`;
        }
    });

    // ä¸ªæ€§åŒ–è¯„ä»·
    const workCat = appConfig.categories.find(c => c.name.includes('å·¥ä½œ'));
    const healthCat = appConfig.categories.find(c => c.name.includes('å¥åº·'));
    
    insight += `\nğŸ’¬ å¯¼æ¼”å¯„è¯­ï¼š\n`;
    if (workCat && stats[workCat.name].total > 0) {
        const workPercent = Math.round((stats[workCat.name].total / totalHours) * 100);
        if (workPercent > 50) {
            insight += `ä½ æ˜¯ä¸ªåå‰¯å…¶å®çš„"åŠ ç­ç‹‚"ï¼Œ${workPercent}%çš„æ—¶é—´åœ¨å·¥ä½œï¼\nåˆ«å¿˜äº†ç…§é¡¾èº«ä½“å’Œå®¶åº­å‘€ã€‚`;
        } else if (workPercent > 30) {
            insight += `å·¥ä½œä¸ç”Ÿæ´»çš„å¹³è¡¡ä¸é”™ï¼Œç»§ç»­ä¿æŒè¿™ä¸ªèŠ‚å¥ï¼`;
        } else {
            insight += `å¥½å®¶ä¼™ï¼Œè¿™å‘¨çš„é—²é€‚ç”Ÿæ´»å æ¯”å¾ˆé«˜å•Šã€‚`;
        }
    }

    document.getElementById('ai-insight').textContent = insight;
}

function toggleStatus(key) {
    const task = weekData.tasks[key];
    const statuses = ['plan', 'done', 'fail'];
    const idx = statuses.indexOf(task.status || 'plan');
    const nextStatus = statuses[(idx + 1) % 3];
    
    if (nextStatus === 'fail') {
        // failæ—¶å¼¹å‡ºåŸå› é€‰æ‹©
        pendingFailKey = key;
        document.getElementById('fail-reason-modal').classList.add('show');
    } else {
        task.status = nextStatus;
        saveData();
        renderWeekPlan();
        renderTodayView();
        renderWeekReview();
    }
}

function selectFailReason(reason) {
    const task = weekData.tasks[pendingFailKey];
    task.status = 'fail';
    task.failReason = reason; // è®°å½•failåŸå› 
    
    // å¦‚æœæ˜¯åŠ ç­ï¼Œé¢å¤–åˆ›å»ºä¸€ä¸ªå·¥ä½œä»»åŠ¡è®°å½•ï¼ˆç”¨äºç»Ÿè®¡ï¼‰
    if (reason === 'overtimeWork') {
        const [day, hour] = pendingFailKey.split('-').map(Number);
        const workCat = appConfig.categories.find(c => c.name.includes('å·¥ä½œ'));
        if (workCat) {
            // åœ¨failReasonsä¸­è®°å½•è¿™ä¸ªåŠ ç­æ—¶æ®µ
            if (!weekData.failReasons) weekData.failReasons = {};
            weekData.failReasons[pendingFailKey] = {
                category: workCat.name,
                tag: 'åŠ ç­',
                reason: reason
            };
        }
    } else if (reason === 'leisure') {
        // ä¼‘é—²å¨±ä¹ - å¯»æ‰¾æˆ–åˆ›å»º"ä¼‘é—²"åˆ†ç±»
        if (!weekData.failReasons) weekData.failReasons = {};
        const leisureCat = appConfig.categories.find(c => c.name.includes('ä¼‘é—²') || c.name.includes('å¨±ä¹'));
        weekData.failReasons[pendingFailKey] = {
            category: leisureCat?.name || 'å…¶ä»–',
            tag: 'ä¼‘é—²å¨±ä¹',
            reason: reason
        };
    }
    
    saveData();
    closeFailReasonModal();
    renderWeekPlan();
    renderTodayView();
    renderWeekReview();
}

function closeFailReasonModal() {
    document.getElementById('fail-reason-modal').classList.remove('show');
    pendingFailKey = null;
}

function switchCheckinDay(day) {
    checkinDay = day;
    
    document.querySelectorAll('.date-btn').forEach((btn, idx) => {
        if ((day === -1 && idx === 0) || (day === idx - 1)) {
            btn.style.background = 'var(--accent)';
            btn.style.color = 'white';
        } else {
            btn.style.background = 'white';
            btn.style.color = 'var(--text)';
            btn.style.border = '1px solid #ddd';
        }
    });
    
    renderTodayView();
}

function openEditModal(day, hour) {
    selectedSlot = { day, hour };
    const key = `${day}-${hour}`;
    const task = weekData.tasks[key];
    
    document.getElementById('modal-time').textContent = `${DAYS[day]} ${hour}:00`;
    document.getElementById('task-tag').value = task ? task.tag : '';
    
    selectedCategory = task ? task.category : null;
    
    // æ¸²æŸ“åˆ†ç±»æŒ‰é’®
    let categoryHtml = '';
    appConfig.categories.forEach((cat, idx) => {
        const isSelected = selectedCategory === cat.name;
        categoryHtml += `
            <button class="cat-btn ${isSelected ? 'selected' : ''}" onclick="selectCategory('${cat.name}')" style="background: ${isSelected ? 'rgba(' + hexToRgb(cat.color) + ', 0.3)' : 'white'}; border-color: ${isSelected ? cat.color : '#ddd'};">
                ${cat.emoji} ${cat.name}
            </button>
        `;
    });
    document.getElementById('category-selector').innerHTML = categoryHtml;
    
    if (selectedCategory) {
        updateCategoryHint(selectedCategory);
        updateTagHistory(selectedCategory);
    }
    
    document.getElementById('task-modal').classList.add('show');
}

function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '0, 0, 0';
}

function selectCategory(catName) {
    selectedCategory = catName;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
    
    const buttons = Array.from(document.querySelectorAll('.cat-btn'));
    const idx = appConfig.categories.findIndex(c => c.name === catName);
    if (idx >= 0 && buttons[idx]) {
        buttons[idx].classList.add('selected');
        const cat = appConfig.categories[idx];
        buttons[idx].style.background = `rgba(${hexToRgb(cat.color)}, 0.3)`;
        buttons[idx].style.borderColor = cat.color;
    }
    
    updateCategoryHint(catName);
    updateTagHistory(catName);
}

function updateCategoryHint(catName) {
    const hint = `å½“å‰åˆ†ç±»ï¼š${catName}`;
    document.getElementById('category-hint').textContent = hint;
}

function updateTagHistory(catName) {
    const history = tagHistory[catName] || [];
    const historyDiv = document.getElementById('tag-history');
    if (history.length > 0) {
        historyDiv.style.display = 'block';
        let html = '';
        history.slice(-5).reverse().forEach(tag => {
            html += `<button class="tag-history-btn" onclick="selectKnownTag('${tag.replace(/'/g, "\\'")}')">${tag}</button>`;
        });
        document.getElementById('tag-history-list').innerHTML = html;
    } else {
        historyDiv.style.display = 'none';
    }
}

function selectKnownTag(tag) {
    if (tagCategoryMap[tag]) {
        selectedCategory = tagCategoryMap[tag];
        selectCategory(selectedCategory);
    }
    document.getElementById('task-tag').value = tag;
    document.getElementById('task-tag').focus();
}

function saveTask() {
    const tag = document.getElementById('task-tag').value.trim();
    if (!tag) {
        alert('è¯·è¾“å…¥æ´»åŠ¨æ ‡ç­¾');
        return;
    }
    
    let category = selectedCategory;
    if (!category && tagCategoryMap[tag]) {
        category = tagCategoryMap[tag];
    }
    
    if (!category) {
        alert('è¯·é€‰æ‹©ç±»åˆ«');
        return;
    }
    
    tagCategoryMap[tag] = category;
    
    if (!tagHistory[category]) tagHistory[category] = [];
    tagHistory[category] = tagHistory[category].filter(t => t !== tag);
    tagHistory[category].push(tag);
    if (tagHistory[category].length > 20) tagHistory[category].shift();
    
    const key = `${selectedSlot.day}-${selectedSlot.hour}`;
    weekData.tasks[key] = { category: category, tag, status: 'plan' };
    saveData();
    renderWeekPlan();
    renderTodayView();
    renderWeekReview();
    closeModal();
}

function closeModal() {
    document.getElementById('task-modal').classList.remove('show');
}

function enterQuickFill() {
    const tag = document.getElementById('task-tag').value.trim();
    if (!tag) {
        alert('è¯·è¾“å…¥æ´»åŠ¨æ ‡ç­¾');
        return;
    }
    
    let category = selectedCategory;
    if (!category && tagCategoryMap[tag]) {
        category = tagCategoryMap[tag];
    }
    
    if (!category) {
        alert('è¯·é€‰æ‹©ç±»åˆ«');
        return;
    }
    
    quickFillMode = true;
    quickFillData = { tag, category };
    
    tagCategoryMap[tag] = category;
    if (!tagHistory[category]) tagHistory[category] = [];
    tagHistory[category] = tagHistory[category].filter(t => t !== tag);
    tagHistory[category].push(tag);
    if (tagHistory[category].length > 20) tagHistory[category].shift();
    
    const cat = getCategoryByName(category);
    document.getElementById('quick-fill-bar').classList.add('show');
    document.getElementById('quick-fill-tag').textContent = `âœ¨ å¿«é€Ÿæ’ç­ï¼š${cat.emoji} ${tag}`;
    
    closeModal();
    switchTab('plan');
}

function confirmQuickFill() {
    quickFillMode = false;
    saveData();
    renderWeekPlan();
    document.getElementById('quick-fill-bar').classList.remove('show');
}

function exitQuickFill() {
    quickFillMode = false;
    document.getElementById('quick-fill-bar').classList.remove('show');
    renderWeekPlan();
}

function loadReviewData() {
    document.getElementById('review-good').value = weekData.review.good || '';
    document.getElementById('review-bad').value = weekData.review.bad || '';
    document.getElementById('review-next').value = weekData.review.next || '';
}

function generateAnalysis() {
    weekData.review.good = document.getElementById('review-good').value;
    weekData.review.bad = document.getElementById('review-bad').value;
    weekData.review.next = document.getElementById('review-next').value;
    saveData();
    
    const result = document.getElementById('analysis-result');
    result.textContent = 'âœ¨ ç”Ÿæˆåˆ†æä¸­...\n\näº²çˆ±çš„å¯¼æ¼”ï¼Œè¿™æ˜¯ä½ è¿™å‘¨çš„å®Œæ•´æ€»ç»“ï¼š\n\nğŸ“Š æ‰§è¡Œæ•°æ®ï¼š\n' + document.getElementById('ai-insight').textContent + '\n\nğŸ“ ä½ çš„åæ€ï¼š\nâœ… åšå¾—å¥½çš„ï¼š' + (weekData.review.good || '(æœªå¡«å†™)') + '\nâŒ ä¸è¶³ä¹‹å¤„ï¼š' + (weekData.review.bad || '(æœªå¡«å†™)') + '\nğŸ’¡ æ”¹è¿›è®¡åˆ’ï¼š' + (weekData.review.next || '(æœªå¡«å†™)') + '\n\nğŸ¬ å¯¼æ¼”çš„å»ºè®®ï¼š\nç»§ç»­ä¼˜åŒ–ä½ çš„äººç”Ÿè„šæœ¬ï¼Œæ¯å‘¨éƒ½æ˜¯æ–°çš„å¼€å§‹ã€‚ä¿æŒå¤ç›˜ä¹ æƒ¯ï¼ŒæŒç»­è¿­ä»£ï¼Œä½ ä¼šçœ‹åˆ°æ˜¾è‘—çš„æˆé•¿ï¼';
    result.style.display = 'block';
}

async function callDeepSeekAnalysis() {
    weekData.review.good = document.getElementById('review-good').value;
    weekData.review.bad = document.getElementById('review-bad').value;
    weekData.review.next = document.getElementById('review-next').value;
    saveData();
    
    const result = document.getElementById('analysis-result');
    result.style.display = 'block';
    result.textContent = 'ğŸ¤– æ­£åœ¨è°ƒç”¨ DeepSeek è¿›è¡Œæ·±åº¦åˆ†æ...\n\n(è¿™éœ€è¦å‡ ç§’é’Ÿ)';
    
    try {
        const response = await fetch('/api/analyze/default', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ appConfig, weekData })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        result.textContent = `ğŸ¤– DeepSeek AI æ·±åº¦åˆ†æ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${data.analysis}`;
    } catch (error) {
        result.textContent = `âŒ åˆ†æå¤±è´¥: ${error.message}\n\næç¤ºï¼šè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨ï¼ˆNode.jsï¼‰å·²å¯åŠ¨\n\nå¯åŠ¨æ–¹å¼ï¼šnpm run server`;
    }
}

function exportData() {
    const data = { appConfig, weekData, tagCategoryMap, tagHistory };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `life-script-${new Date().getTime()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            appConfig = data.appConfig || appConfig;
            weekData = data.weekData || weekData;
            tagCategoryMap = data.tagCategoryMap || tagCategoryMap;
            tagHistory = data.tagHistory || tagHistory;
            saveData();
            
            renderApp();
            alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼');
        } catch (error) {
            alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + error.message);
        }
    };
    reader.readAsText(file);
}

function renderCategoriesDisplay() {
    try {
        console.log('renderCategoriesDisplay');
        
        let html = '<tr><th>Emoji</th><th>åˆ†ç±»åç§°</th><th style="text-align: center;">é¢œè‰²</th></tr>';
        appConfig.categories.forEach(cat => {
            html += `<tr><td>${cat.emoji}</td><td>${cat.name}</td><td style="background: ${cat.color}; width: 100px;"></td></tr>`;
        });
        document.getElementById('categories-display-table').innerHTML = html;
        console.log('âœ… categories-display-table updated');
    } catch (e) {
        console.error('âŒ Error in renderCategoriesDisplay:', e);
    }
}

function showEditCategories() {
    editingCategoriesTemp = JSON.parse(JSON.stringify(appConfig.categories));
    let html = '';
    editingCategoriesTemp.forEach((cat, idx) => {
        const isOptional = idx >= 4;
        html += `
            <div class="category-input-group">
                <label class="category-input-label">åˆ†ç±» ${idx + 1} ${isOptional ? '(å¯é€‰)' : '(å¿…é€‰)'}</label>
                <div class="category-input-row">
                    <input type="text" id="edit-emoji-${idx}" placeholder="ğŸ”µ" value="${cat.emoji}" maxlength="2">
                    <input type="text" id="edit-name-${idx}" placeholder="åˆ†ç±»åç§°" value="${cat.name}">
                    <input type="color" id="edit-color-${idx}" value="${cat.color}">
                </div>
            </div>
        `;
    });
    document.getElementById('edit-categories-content').innerHTML = html;
    document.getElementById('edit-categories-modal').classList.add('show');
}

function closeEditCategoriesModal() {
    document.getElementById('edit-categories-modal').classList.remove('show');
}

function saveCategories() {
    const categories = [];
    for (let i = 0; i < editingCategoriesTemp.length; i++) {
        const name = document.getElementById(`edit-name-${i}`).value.trim();
        const emoji = document.getElementById(`edit-emoji-${i}`).value.trim();
        const color = document.getElementById(`edit-color-${i}`).value;
        
        if (i < 4 && !name) {
            alert('å‰4ä¸ªåˆ†ç±»å¿…é¡»å¡«å†™');
            return;
        }
        
        if (name) {
            categories.push({ name, emoji, color });
        }
    }
    
    appConfig.categories = categories;
    saveData();
    renderCategoriesDisplay();
    closeEditCategoriesModal();
    alert('âœ… åˆ†ç±»é…ç½®å·²ä¿å­˜ï¼');
}

function clearAllData() {
    if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™ä¸ªæ“ä½œæ— æ³•æ’¤é”€ï¼')) {
        weekData = { tasks: {}, review: { good: '', bad: '', next: '' }, failReasons: {} };
        tagCategoryMap = {};
        tagHistory = {};
        appConfig.categories.forEach(cat => {
            tagHistory[cat.name] = [];
        });
        saveData();
        
        renderApp();
        alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
    }
}

function showShareOptions() {
    document.getElementById('share-options-modal').classList.add('show');
}

function closeShareOptionsModal() {
    document.getElementById('share-options-modal').classList.remove('show');
}

function generateShareCard(type = 'overview') {
    closeShareOptionsModal();
    
    const canvas = document.getElementById('share-canvas');
    const ctx = canvas.getContext('2d');
    
    const width = 540;
    const height = 960;
    canvas.width = width;
    canvas.height = height;
    
    // èƒŒæ™¯
    const gradient = ctx.createLinearGradient(0, 0, width, height);
    gradient.addColorStop(0, '#F9FBFB');
    gradient.addColorStop(1, '#E8F0FF');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
    
    // ç»Ÿè®¡æ•°æ®
    const stats = {};
    appConfig.categories.forEach(cat => {
        stats[cat.name] = { total: 0, done: 0, emoji: cat.emoji };
    });

    Object.values(weekData.tasks).forEach(task => {
        if (stats[task.category]) {
            stats[task.category].total++;
            if (task.status === 'done') stats[task.category].done++;
        }
    });

    const totalHours = Object.values(stats).reduce((sum, s) => sum + s.total, 0);
    const totalDone = Object.values(stats).reduce((sum, s) => sum + s.done, 0);
    const overallRate = totalHours > 0 ? Math.round((totalDone / totalHours) * 100) : 0;
    
    if (type === 'overview') {
        generateOverviewCard(ctx, width, height, stats, totalHours, totalDone, overallRate);
    } else if (type === 'plan') {
        generatePlanCard(ctx, width, height);
    } else if (type === 'review') {
        generateReviewCard(ctx, width, height);
    } else if (type === 'insight') {
        generateInsightCard(ctx, width, height, stats, totalHours, totalDone, overallRate);
    } else if (type === 'reflection') {
        generateReflectionCard(ctx, width, height);
    }
    
    // ä¸‹è½½å›¾ç‰‡
    canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `life-script-${type}-${new Date().getTime()}.png`;
        a.click();
        URL.revokeObjectURL(url);
        alert('âœ… åˆ†äº«å¡ç‰‡å·²ä¸‹è½½ï¼\n\nå¯åˆ†äº«åˆ°å¾®ä¿¡ã€æœ‹å‹åœˆã€å°çº¢ä¹¦ç­‰å¹³å°');
    });
}

function generateOverviewCard(ctx, width, height, stats, totalHours, totalDone, overallRate) {
    // æ ‡é¢˜
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 40px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('äººç”Ÿè„šæœ¬', width / 2, 80);
    
    ctx.fillStyle = '#999';
    ctx.font = '14px Arial, sans-serif';
    ctx.fillText('æˆ‘æ˜¯æˆ‘äººç”Ÿçš„å¯¼æ¼”', width / 2, 115);
    
    // å®Œæˆç‡å¡ç‰‡
    ctx.fillStyle = '#fff';
    ctx.fillRect(30, 150, width - 60, 120);
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1;
    ctx.strokeRect(30, 150, width - 60, 120);
    
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 60px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(`${overallRate}%`, width / 2, 235);
    
    ctx.fillStyle = '#999';
    ctx.font = '16px Arial, sans-serif';
    ctx.fillText(`å®Œæˆç‡ï¼š${totalDone}/${totalHours}ä»»åŠ¡`, width / 2, 265);
    
    // åˆ†ç±»åˆ†å¸ƒ
    let yPos = 310;
    ctx.fillStyle = '#333';
    ctx.font = 'bold 18px Arial, sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('æœ¬å‘¨åˆ†å¸ƒ', 40, yPos);
    yPos += 40;
    
    appConfig.categories.slice(0, 4).forEach(cat => {
        const data = stats[cat.name];
        if (data.total > 0) {
            const percent = Math.round((data.total / totalHours) * 100);
            
            ctx.fillStyle = cat.color;
            ctx.fillRect(40, yPos, 30, 30);
            
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(`${cat.emoji} ${cat.name}`, 80, yPos + 22);
            
            ctx.fillStyle = '#6C5CE7';
            ctx.font = 'bold 16px Arial, sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(`${percent}%`, width - 40, yPos + 22);
            
            yPos += 45;
        }
    });
    
    // çŸ¥è¡Œåˆä¸€
    yPos += 20;
    ctx.fillStyle = '#333';
    ctx.font = 'bold 18px Arial, sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('çŸ¥è¡Œåˆä¸€', 40, yPos);
    
    yPos += 35;
    ctx.fillStyle = '#666';
    ctx.font = '14px Arial, sans-serif';
    ctx.fillText(`âœ… å®Œæˆ: ${totalDone}h`, 50, yPos);
    ctx.fillText(`âŒ å¤±è´¥: ${totalHours - totalDone}h`, 50, yPos + 28);
    
    // åº•éƒ¨Logo
    yPos = height - 100;
    ctx.fillStyle = '#E0E0E0';
    ctx.fillRect(0, yPos, width, height - yPos);
    
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 24px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ¬ äººç”Ÿè„šæœ¬', width / 2, yPos + 40);
    
    ctx.fillStyle = '#999';
    ctx.font = '12px Arial, sans-serif';
    ctx.fillText('å‰§æœ¬æ—¶é—´ç®¡ç†æ³• Â· ä½ æ˜¯ä½ äººç”Ÿçš„å¯¼æ¼”', width / 2, yPos + 70);
}

function generatePlanCard(ctx, width, height) {
    // æ ‡é¢˜
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 32px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ“… æœ¬å‘¨è®¡åˆ’', width / 2, 60);
    
    // è¡¨æ ¼
    let yPos = 100;
    const cellWidth = (width - 80) / 8;
    const cellHeight = 25;
    
    // è¡¨å¤´
    ctx.fillStyle = '#f5f5f5';
    ctx.fillRect(40, yPos, width - 80, cellHeight);
    ctx.fillStyle = '#333';
    ctx.font = 'bold 11px Arial, sans-serif';
    ctx.textAlign = 'center';
    
    ctx.fillText('æ—¶é—´', 40 + cellWidth/2, yPos + 18);
    DAYS.forEach((day, idx) => {
        ctx.fillText(day, 40 + (idx+1)*cellWidth + cellWidth/2, yPos + 18);
    });
    
    yPos += cellHeight;
    
    // æ•°æ®è¡Œ
    ctx.font = '9px Arial, sans-serif';
    let rowCount = 0;
    HOURS.forEach(hour => {
        if (rowCount++ % 2 === 0) ctx.fillStyle = '#f9f9f9';
        else ctx.fillStyle = 'white';
        
        ctx.fillRect(40, yPos, width - 80, cellHeight);
        
        ctx.fillStyle = '#999';
        ctx.textAlign = 'center';
        ctx.fillText(`${hour}:00`, 40 + cellWidth/2, yPos + 18);
        
        for (let day = 0; day < 7; day++) {
            const key = `${day}-${hour}`;
            const task = weekData.tasks[key];
            
            if (task) {
                const cat = getCategoryByName(task.category);
                ctx.fillStyle = cat ? cat.color : '#eee';
                ctx.fillRect(40 + (day+1)*cellWidth + 2, yPos + 2, cellWidth - 4, cellHeight - 4);
                
                ctx.fillStyle = '#333';
                ctx.font = 'bold 8px Arial, sans-serif';
                ctx.fillText(task.tag.substring(0, 4), 40 + (day+1)*cellWidth + cellWidth/2, yPos + 15);
            }
        }
        
        yPos += cellHeight;
        if (yPos > height - 100) break;
    });
    
    // åº•éƒ¨
    ctx.fillStyle = '#E0E0E0';
    ctx.fillRect(0, height - 60, width, 60);
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 18px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ¬ äººç”Ÿè„šæœ¬', width / 2, height - 30);
}

function generateReviewCard(ctx, width, height) {
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 32px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ“Š å‘¨å®¡è§†è¡¨', width / 2, 60);
    
    let yPos = 110;
    const cellWidth = (width - 80) / 8;
    const cellHeight = 30;
    
    // è¡¨å¤´
    ctx.fillStyle = '#f5f5f5';
    ctx.fillRect(40, yPos, width - 80, cellHeight);
    ctx.fillStyle = '#333';
    ctx.font = 'bold 12px Arial, sans-serif';
    ctx.textAlign = 'center';
    
    ctx.fillText('æ—¶é—´', 40 + cellWidth/2, yPos + 22);
    DAYS.forEach((day, idx) => {
        ctx.fillText(day, 40 + (idx+1)*cellWidth + cellWidth/2, yPos + 22);
    });
    
    yPos += cellHeight;
    
    ctx.font = '10px Arial, sans-serif';
    let rowCount = 0;
    HOURS.forEach(hour => {
        if (rowCount++ % 2 === 0) ctx.fillStyle = '#f9f9f9';
        else ctx.fillStyle = 'white';
        
        ctx.fillRect(40, yPos, width - 80, cellHeight);
        
        ctx.fillStyle = '#999';
        ctx.textAlign = 'center';
        ctx.fillText(`${hour}:00`, 40 + cellWidth/2, yPos + 22);
        
        for (let day = 0; day < 7; day++) {
            const key = `${day}-${hour}`;
            const task = weekData.tasks[key];
            
            if (task) {
                if (task.status === 'done') {
                    ctx.fillStyle = '#D4F4DD';
                    ctx.fillRect(40 + (day+1)*cellWidth + 2, yPos + 2, cellWidth - 4, cellHeight - 4);
                    ctx.fillStyle = '#333';
                    ctx.fillText('âœ…', 40 + (day+1)*cellWidth + cellWidth/2 - 8, yPos + 20);
                } else if (task.status === 'fail') {
                    ctx.fillStyle = '#F8D7DA';
                    ctx.fillRect(40 + (day+1)*cellWidth + 2, yPos + 2, cellWidth - 4, cellHeight - 4);
                    ctx.fillStyle = '#333';
                    ctx.fillText('âŒ', 40 + (day+1)*cellWidth + cellWidth/2 - 8, yPos + 20);
                }
            }
        }
        
        yPos += cellHeight;
        if (yPos > height - 100) break;
    });
    
    ctx.fillStyle = '#E0E0E0';
    ctx.fillRect(0, height - 60, width, 60);
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 18px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ¬ äººç”Ÿè„šæœ¬', width / 2, height - 30);
}

function generateInsightCard(ctx, width, height, stats, totalHours, totalDone, overallRate) {
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 32px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ’¡ AIæ´å¯Ÿ', width / 2, 60);
    
    let yPos = 120;
    
    // å®Œæˆç‡
    ctx.fillStyle = '#fff';
    ctx.fillRect(30, yPos, width - 60, 80);
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1;
    ctx.strokeRect(30, yPos, width - 60, 80);
    
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 48px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(`${overallRate}%`, width / 2, yPos + 58);
    
    yPos += 100;
    
    // çŸ¥è¡Œåˆä¸€
    ctx.fillStyle = '#333';
    ctx.font = 'bold 16px Arial, sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('çŸ¥è¡Œåˆä¸€åˆ†æ', 40, yPos);
    
    yPos += 35;
    ctx.fillStyle = '#666';
    ctx.font = '13px Arial, sans-serif';
    ctx.fillText(`âœ… å®Œæˆ: ${totalDone}å°æ—¶`, 50, yPos);
    ctx.fillText(`âŒ å¤±è´¥: ${totalHours - totalDone}å°æ—¶`, 50, yPos + 28);
    
    yPos += 80;
    
    // åˆ†ç±»æ’è¡Œ
    ctx.fillStyle = '#333';
    ctx.font = 'bold 16px Arial, sans-serif';
    ctx.fillText('åˆ†ç±»è¡¨ç°', 40, yPos);
    
    yPos += 35;
    const sorted = appConfig.categories.slice(0, 4).sort((a, b) => {
        const rateA = stats[a.name].total > 0 ? (stats[a.name].done / stats[a.name].total) : 0;
        const rateB = stats[b.name].total > 0 ? (stats[b.name].done / stats[b.name].total) : 0;
        return rateB - rateA;
    });
    
    sorted.slice(0, 3).forEach((cat, idx) => {
        const rate = stats[cat.name].total > 0 ? Math.round((stats[cat.name].done / stats[cat.name].total) * 100) : 0;
        const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
        
        ctx.fillStyle = '#666';
        ctx.font = '13px Arial, sans-serif';
        ctx.fillText(`${medal} ${cat.name}: ${rate}%`, 50, yPos);
        yPos += 28;
    });
    
    ctx.fillStyle = '#E0E0E0';
    ctx.fillRect(0, height - 60, width, 60);
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 18px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ¬ äººç”Ÿè„šæœ¬', width / 2, height - 30);
}

function generateReflectionCard(ctx, width, height) {
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 32px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ“ æœ¬å‘¨å¤ç›˜', width / 2, 60);
    
    let yPos = 120;
    const lineHeight = 25;
    const maxWidth = width - 80;
    
    // åšå¾—å¥½
    ctx.fillStyle = '#333';
    ctx.font = 'bold 14px Arial, sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('âœ… åšå¾—å¥½çš„', 40, yPos);
    
    yPos += 30;
    ctx.fillStyle = '#666';
    ctx.font = '12px Arial, sans-serif';
    const goodText = weekData.review?.good || '(æœªå¡«å†™)';
    wrapText(ctx, goodText, 40, yPos, maxWidth, 15, 3);
    yPos += 80;
    
    // éœ€è¦æ”¹è¿›
    ctx.fillStyle = '#333';
    ctx.font = 'bold 14px Arial, sans-serif';
    ctx.fillText('âŒ éœ€è¦æ”¹è¿›', 40, yPos);
    
    yPos += 30;
    ctx.fillStyle = '#666';
    ctx.font = '12px Arial, sans-serif';
    const badText = weekData.review?.bad || '(æœªå¡«å†™)';
    wrapText(ctx, badText, 40, yPos, maxWidth, 15, 3);
    yPos += 80;
    
    // ä¸‹å‘¨è®¡åˆ’
    ctx.fillStyle = '#333';
    ctx.font = 'bold 14px Arial, sans-serif';
    ctx.fillText('ğŸ’¡ ä¸‹å‘¨è®¡åˆ’', 40, yPos);
    
    yPos += 30;
    ctx.fillStyle = '#666';
    ctx.font = '12px Arial, sans-serif';
    const nextText = weekData.review?.next || '(æœªå¡«å†™)';
    wrapText(ctx, nextText, 40, yPos, maxWidth, 15, 3);
    
    ctx.fillStyle = '#E0E0E0';
    ctx.fillRect(0, height - 60, width, 60);
    ctx.fillStyle = '#6C5CE7';
    ctx.font = 'bold 18px Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ¬ äººç”Ÿè„šæœ¬', width / 2, height - 30);
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines) {
    const words = text.split('');
    let line = '';
    let lineCount = 0;
    
    for (let i = 0; i < words.length && lineCount < maxLines; i++) {
        const testLine = line + words[i];
        const metrics = ctx.measureText(testLine);
        
        if (metrics.width > maxWidth) {
            ctx.fillText(line, x, y);
            line = words[i];
            y += lineHeight;
            lineCount++;
        } else {
            line = testLine;
        }
    }
    
    if (line) ctx.fillText(line, x, y);
}

// å…¨å±€é”™è¯¯å¤„ç†
window.onerror = function(msg, url, lineNo, colNo, error) {
    console.error('JavaScript Error:', msg, 'at', url, ':', lineNo, ':', colNo, error);
};

window.addEventListener('error', (e) => {
    console.error('Error event:', e);
});

init();

// æµ‹è¯•ï¼šæ˜¾ç¤ºå½“å‰çŠ¶æ€
console.log('=== Life Script v3 å·²åˆå§‹åŒ– ===');
console.log('appConfig:', appConfig);
console.log('weekData:', weekData);
console.log('localStorage keys:', Object.keys(localStorage));

</script>

</body>
</html>
