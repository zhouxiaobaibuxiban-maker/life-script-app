<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº‘ç«¯æ•°æ®æµ‹è¯•å·¥å…·</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // å¦‚æœ unpkg å¤±è´¥ï¼Œå°è¯•å…¶ä»– CDN
    if (typeof window.supabase === 'undefined') {
      document.write('<script src="https://gcore.jsdelivr.net/npm/@supabase/supabase-js@2"><\/script>');
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #f0f2f5; }
    .container { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    h1 { margin-bottom: 20px; }
    .section { background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0; }
    .section h3 { margin-bottom: 15px; }
    input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    button { width: 100%; padding: 14px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; min-height: 100px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” äº‘ç«¯æ•°æ®è¯Šæ–­å·¥å…·</h1>

    <div class="section">
      <h3>æ­¥éª¤ 1: ç™»å½•</h3>
      <input type="email" id="email" value="oppozhoulina@126.com" placeholder="é‚®ç®±">
      <input type="password" id="password" placeholder="å¯†ç ">
      <button id="loginBtn">ç™»å½•</button>
    </div>

    <div class="section">
      <h3>æ­¥éª¤ 2: è¯Šæ–­</h3>
      <button id="diagnoseBtn" disabled>æ£€æŸ¥äº‘ç«¯æ•°æ®</button>
    </div>

    <div class="section">
      <h3>æ­¥éª¤ 3: æ“ä½œ</h3>
      <button id="resetBtn" disabled>æ¸…ç†æ— æ•ˆæ•°æ®</button>
    </div>

    <div class="section">
      <h3>æ—¥å¿—</h3>
      <div id="log">ç­‰å¾…æ“ä½œ...</div>
    </div>
  </div>

  <script>
    // ä½¿ç”¨æ¨¡å—ä½œç”¨åŸŸé¿å…å…¨å±€å˜é‡å†²çª
    (function() {
      const SUPABASE_URL = 'https://fzxdlejmubwfnraqvfeo.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_ToOJlsvadxHssbZN6UI1cQ_NrA6Z2X7';
      let client = null;
      let user = null;

      function log(msg) {
        const el = document.getElementById('log');
        const time = new Date().toLocaleTimeString();
        el.textContent = `[${time}] ${msg}\n` + el.textContent;
        el.scrollTop = el.scrollHeight;
      }

      log('âœ… å·¥å…·å·²åŠ è½½ï¼Œç­‰å¾…æ“ä½œ...');

      // ç™»å½•
      document.getElementById('loginBtn').onclick = async function() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password) {
          log('âŒ è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
          return;
        }

        this.disabled = true;
        this.textContent = 'ç™»å½•ä¸­...';

        try {
          if (!window.supabase) {
            throw new Error('Supabase SDK æœªåŠ è½½');
          }

          client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          log('âœ… å®¢æˆ·ç«¯å·²åˆ›å»º');

          const { data, error } = await client.auth.signInWithPassword({ email, password });

          if (error) throw error;
          if (!data.user) throw new Error('ç™»å½•å¤±è´¥ï¼šæœªè¿”å›ç”¨æˆ·ä¿¡æ¯');

          user = data.user;
          log('âœ… ç™»å½•æˆåŠŸ!');
          log('ç”¨æˆ·: ' + user.email);

          document.getElementById('diagnoseBtn').disabled = false;
          document.getElementById('resetBtn').disabled = false;
          this.textContent = 'âœ… å·²ç™»å½•';

        } catch (e) {
          log('âŒ ç™»å½•å¤±è´¥: ' + e.message);
          this.disabled = false;
          this.textContent = 'ç™»å½•';
        }
      };

      // è¯Šæ–­
      document.getElementById('diagnoseBtn').onclick = async function() {
        this.disabled = true;
        log('ğŸ“¡ æŸ¥è¯¢äº‘ç«¯æ•°æ®...');

        try {
          const { data, error } = await client
            .from('user_data')
            .select('*')
            .eq('user_id', user.id);

          if (error) throw error;

          if (!data || data.length === 0) {
            log('â„¹ï¸ äº‘ç«¯æ²¡æœ‰æ•°æ®');
          } else {
            log('âœ… æ‰¾åˆ° ' + data.length + ' æ¡æ•°æ®');
            data.forEach((row, i) => {
              const appState = row.app_state || {};
              log(`æ•°æ® ${i + 1}:`);
              log(`  - ID: ${row.id}`);
              log(`  - åˆ›å»ºæ—¶é—´: ${new Date(row.created_at).toLocaleString('zh-CN')}`);
              log(`  - æ›´æ–°æ—¶é—´: ${new Date(row.updated_at).toLocaleString('zh-CN')}`);
              log(`  - userName: ${appState.userName || '(æ— )'}`);
              log(`  - categories: ${appState.categories ? 'æœ‰' : 'æ— '}`);
              log(`  - weeklyData: ${appState.weeklyData ? Object.keys(appState.weeklyData).length + ' å‘¨' : 'æ— '}`);
            });
          }

        } catch (e) {
          log('âŒ æŸ¥è¯¢å¤±è´¥: ' + e.message);
        } finally {
          this.disabled = false;
        }
      };

      // æ¸…ç†
      document.getElementById('resetBtn').onclick = async function() {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰äº‘ç«¯æ•°æ®å—ï¼Ÿ')) return;

        this.disabled = true;
        log('ğŸ“¡ åˆ é™¤äº‘ç«¯æ•°æ®...');

        try {
          const { error } = await client
            .from('user_data')
            .delete()
            .eq('user_id', user.id);

          if (error) throw error;
          log('âœ… äº‘ç«¯æ•°æ®å·²åˆ é™¤');
          log('ğŸ’¡ ç°åœ¨å¯ä»¥åœ¨ä¸»åº”ç”¨ä¸­é‡æ–°ä¸Šä¼ æ•°æ®');

        } catch (e) {
          log('âŒ åˆ é™¤å¤±è´¥: ' + e.message);
        } finally {
          this.disabled = false;
        }
      };

      // é”®ç›˜æ”¯æŒ
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') document.getElementById('loginBtn').click();
      });

    })();
  </script>
</body>
</html>
