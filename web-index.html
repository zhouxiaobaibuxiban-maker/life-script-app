<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6C5CE7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="äººç”Ÿè„šæœ¬">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%236C5CE7' width='192' height='192'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='100' fill='white'>ğŸ¬</text></svg>">
    <title>äººç”Ÿè„šæœ¬ Web ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root { --bg: #F9FBFB; --text: #333; --sub: #999; --accent: #6C5CE7; }
        body {
            font-family: -apple-system, sans-serif; background: var(--bg);
            margin: 0; padding: 0; color: var(--text); -webkit-tap-highlight-color: transparent;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 0.6s;
        }
        .start-btn { margin-top: 40px; padding: 12px 35px; border: 1px solid rgba(255,255,255,0.3); border-radius: 30px; background: rgba(255,255,255,0.1); color: white; font-size: 14px; letter-spacing: 2px; }
        .header { padding: 44px 20px 15px; background: rgba(255,255,255,0.95); z-index: 50; border-bottom: 1px solid #eee; }
        .header h1 { font-size: 20px; margin: 0; display: flex; align-items: center; justify-content: space-between; }
        .header-controls { display: flex; gap: 8px; font-size: 12px; }
        .sync-btn, .export-btn { padding: 6px 12px; border: none; border-radius: 8px; cursor: pointer; background: #eee; transition: 0.2s; }
        .sync-btn:hover { background: #ddd; }
        .export-btn { background: #6C5CE7; color: white; }
        .page-container { flex: 1; position: relative; overflow: hidden; }
        .page { display: none; height: 100%; overflow-y: auto; padding: 20px; padding-bottom: 180px; box-sizing: border-box; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
        .time-row { display: flex; margin-bottom: 10px; align-items: center; }
        .time-label { width: 40px; font-size: 12px; color: var(--sub); font-family: monospace; }
        .block { flex: 1; height: 46px; background: white; border-radius: 10px; border: 1px dashed #ddd; display: flex; align-items: center; padding: 0 15px; font-size: 14px; color: var(--sub); transition: 0.2s; position: relative; cursor: pointer; }
        .block.filled { border: none; color: #333; font-weight: 500; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .week-wrapper { overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .week-table { display: grid; grid-template-columns: 40px repeat(7, 1fr); min-width: 100%; gap: 2px; }
        .th { text-align: center; font-size: 10px; color: #999; padding: 5px 0; background: #f5f5f5; border-radius: 4px; }
        .td-time { font-size: 10px; color: #ccc; text-align: center; line-height: 30px; }
        .td-cell { height: 30px; background: #fff; border-radius: 4px; border: 1px solid #f0f0f0; font-size: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .highlight-col { border: 1px solid #333 !important; background: rgba(0,0,0,0.02); }
        .section-title { font-size: 16px; font-weight: 600; margin: 25px 0 10px 0; display: flex; align-items: center; gap: 5px; }
        .review-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .review-label { font-size: 12px; color: #999; margin-bottom: 5px; font-weight: bold; }
        .review-input { width: 100%; border: none; background: #f9f9f9; padding: 10px; border-radius: 8px; font-size: 14px; box-sizing: border-box; resize: none; font-family: inherit; }
        .ai-btn { background: linear-gradient(135deg, #6C5CE7, #a363d9); color: white; width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3); margin-top: 10px; cursor: pointer; }
        .ai-result { display: none; background: #F4F4FC; border-left: 4px solid #6C5CE7; padding: 15px; margin-top: 15px; border-radius: 8px; font-size: 13px; line-height: 1.6; }
        .nav-bar { height: 60px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; width: 100%; z-index: 100; }
        .nav-item { text-align: center; font-size: 10px; color: #ccc; flex: 1; cursor: pointer; }
        .nav-item.active { color: #333; font-weight: bold; }
        .nav-icon { display: block; font-size: 20px; margin-bottom: 2px; }
        .drawer { position: fixed; bottom: 70px; left: 15px; right: 15px; background: white; border-radius: 20px; padding: 15px 10px; box-shadow: 0 5px 30px rgba(0,0,0,0.15); z-index: 90; display: none; }
        .role-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .role-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; opacity: 0.5; transition: 0.2s; cursor: pointer;}
        .role-btn.active { opacity: 1; transform: translateY(-3px); }
        .dot { width: 42px; height: 42px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal { background: white; width: 80%; border-radius: 20px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 15px 0; }
        .color-opt { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
        .user-input { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 15px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 80; display: none; }
        .user-input input { border: none; background: #f5f5f5; padding: 8px 12px; border-radius: 8px; font-size: 12px; width: 150px; }
        #screenshot-area { background: white; padding: 20px; border-radius: 12px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="intro-layer">
        <div style="font-size: 40px; margin-bottom: 20px;">ğŸ¬</div>
        <div style="font-size: 20px; letter-spacing: 2px;">LIFE SCRIPT</div>
        <div style="font-size: 12px; opacity: 0.5; margin-top: 5px;">3...2...1... Action!</div>
        <button class="start-btn" onclick="startGame()">è¿›å…¥ç‰‡åœº</button>
    </div>

    <div class="header">
        <h1>
            <span id="pageTitle">ä»Šæ—¥å‰§æœ¬</span>
            <span style="font-size:12px; font-weight:normal; background:#eee; padding:4px 8px; border-radius:10px;">ğŸ—“ï¸ 1æœˆ10æ—¥ å‘¨å…­</span>
        </h1>
        <div class="header-controls">
            <input type="text" id="userInput" placeholder="è¾“å…¥ç”¨æˆ·ID..." style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; width: 120px;">
            <button class="sync-btn" onclick="syncWithServer()">â˜ï¸ åŒæ­¥</button>
            <button class="export-btn" onclick="exportAsImage()">ğŸ“¸ å¯¼å‡ºå›¾ç‰‡</button>
        </div>
    </div>

    <div class="page-container">
        
        <div id="page-daily" class="page active">
            <div id="daily-list"></div>
        </div>

        <div id="page-weekly" class="page">
            <div class="week-wrapper">
                <div class="week-table" id="week-grid"></div>
            </div>

            <div class="section-title">ğŸ“ å¯¼æ¼”å‘¨å¤ç›˜</div>
            <div class="review-card">
                <div class="review-label">ğŸŒŸ é«˜å…‰æ—¶åˆ» (Highlight)</div>
                <textarea class="review-input" id="highlight" rows="2" placeholder="æœ¬å‘¨æœ€æ»¡æ„çš„è¡¨ç°..."></textarea>
            </div>
            <div class="review-card">
                <div class="review-label">ğŸ’£ ç©¿å¸®é•œå¤´ (NG)</div>
                <textarea class="review-input" id="ng" rows="2" placeholder="é—æ†¾æˆ–æœªå®Œæˆçš„äº‹..."></textarea>
            </div>
            <div class="review-card">
                <div class="review-label">ğŸ’¡ å¯¼æ¼”æ€è€ƒ (Thinking)</div>
                <textarea class="review-input" id="thinking" rows="2" placeholder="ä¸‹å‘¨å‰§æœ¬ä¼˜åŒ–æ–¹æ¡ˆ..."></textarea>
            </div>

            <div class="section-title">ğŸ§  AI æ´å¯Ÿ</div>
            <button class="ai-btn" onclick="callAI()">
                <span id="ai-btn-text">âœ¨ å‘¼å« DeepSeek åˆ†ææ•°æ®</span>
            </button>
            <div id="ai-output" class="ai-result"></div>
        </div>

    </div>

    <div class="drawer" id="drawer">
        <div class="role-grid" id="roleContainer"></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('daily', this)">
            <span class="nav-icon">ğŸ“</span>ä»Šæ—¥
        </div>
        <div class="nav-item" onclick="switchPage('weekly', this)">
            <span class="nav-icon">ğŸ“Š</span>å‘¨å¤ç›˜
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <h3>æ–°è§’è‰²è¯•é•œ</h3>
            <input id="newRoleName" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;" placeholder="è§’è‰²åç§°...">
            <div class="color-grid" id="colorGrid"></div>
            <div style="display:flex; gap:10px">
                <button onclick="closeModal()" style="flex:1; padding:10px; border:none; background:#eee; border-radius:8px;">å–æ¶ˆ</button>
                <button onclick="saveRole()" style="flex:1; padding:10px; border:none; background:#333; color:white; border-radius:8px;">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script>
        const weekData = Array(7).fill(null).map(() => ({}));
        const todayIndex = 5;
        let roles = [
            { name:'æ‰“å·¥äºº', color:'#AECBFA', icon:'ğŸ’»' },
            { name:'å¦ˆå¦ˆ', color:'#FDE293', icon:'ğŸ‘¶' },
            { name:'çˆ±è‡ªå·±', color:'#CCF0DF', icon:'ğŸ§˜â€â™€ï¸' }
        ];
        let curRoleIdx = 0;
        let selColor = '#FFADAD';
        let currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
        let review = { highlight: '', ng: '', thinking: '' };

        async function init() {
            const dContainer = document.getElementById('daily-list');
            for (let h = 7; h <= 23; h++) {
                dContainer.innerHTML += `
                    <div class="time-row">
                        <div class="time-label">${h}:00</div>
                        <div class="block" id="d-${h}" onclick="paintDaily(${h})">+</div>
                    </div>`;
            }
            renderRoleButtons();
            document.getElementById('userInput').value = currentUserId;
        }

        function renderRoleButtons() {
            const container = document.getElementById('roleContainer');
            container.innerHTML = '';
            roles.slice(0, 3).forEach((r, idx) => {
                container.innerHTML += `
                    <div class="role-btn ${idx===curRoleIdx?'active':''}" onclick="setRole(${idx}, this)">
                        <div class="dot" style="background:${r.color}">${r.icon}</div>
                        <span style="font-size:10px;margin-top:2px">${r.name}</span>
                    </div>`;
            });
            container.innerHTML += `
                <div class="role-btn" onclick="openAddModal()">
                    <div class="dot" style="border:2px dashed #ccc; background:transparent;">+</div>
                    <span style="font-size:10px;margin-top:2px">è‡ªå®šä¹‰</span>
                </div>`;
        }

        function startGame() { document.getElementById('intro-layer').style.opacity = 0; setTimeout(()=> document.getElementById('intro-layer').style.display = 'none', 600); document.getElementById('drawer').style.display = 'block'; }

        function setRole(idx, el) { curRoleIdx = idx; document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); }

        async function paintDaily(hour) {
            const r = roles[curRoleIdx];
            const block = document.getElementById(`d-${hour}`);
            block.style.background = r.color;
            block.innerText = r.icon + ' ' + r.name;
            block.classList.add('filled');
            weekData[todayIndex][hour] = r;
        }

        function switchPage(page, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-'+page).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            navEl.classList.add('active');
            document.getElementById('drawer').style.display = (page === 'daily') ? 'block' : 'none';
            document.getElementById('pageTitle').innerText = (page === 'daily') ? 'ä»Šæ—¥å‰§æœ¬' : 'å¯¼æ¼”å¤ç›˜';
            if (page === 'weekly') renderWeeklyView();
        }

        function renderWeeklyView() {
            const container = document.getElementById('week-grid');
            container.innerHTML = '';
            const days = ['','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
            days.forEach((d, i) => {
                const isToday = (i-1 === todayIndex);
                container.innerHTML += `<div class="th" style="${isToday?'color:#333;font-weight:bold':''}">${d}</div>`;
            });
            for (let h = 7; h <= 23; h++) {
                container.innerHTML += `<div class="td-time">${h}</div>`;
                for (let d = 0; d < 7; d++) {
                    const data = weekData[d][h];
                    let bg = '#fff'; let txt = '';
                    if (data) { bg = data.color; txt = data.icon; }
                    else if (d === todayIndex) { bg = '#fafafa'; }
                    container.innerHTML += `<div class="td-cell ${d === todayIndex ? 'highlight-col' : ''}" style="background:${bg}">${txt}</div>`;
                }
            }
        }

        function openAddModal() {
            document.getElementById('addModal').style.display = 'flex';
            const colors = ['#FFADAD','#FFD6A5','#FDFFB6','#CAFFBF','#9BF6FF','#A0C4FF','#BDB2FF','#FFC6FF'];
            const grid = document.getElementById('colorGrid');
            grid.innerHTML = '';
            colors.forEach(c => {
                let d = document.createElement('div');
                d.className = 'color-opt'; d.style.background = c;
                d.onclick = () => { selColor = c; document.querySelectorAll('.color-opt').forEach(x=>x.style.border=''); d.style.border = '2px solid #333'; };
                grid.appendChild(d);
            });
        }
        function closeModal() { document.getElementById('addModal').style.display = 'none'; }

        function saveRole() {
            const name = document.getElementById('newRoleName').value;
            if(name) {
                roles[2] = { name: name, color: selColor, icon: 'âœ¨' };
                renderRoleButtons();
                const btns = document.querySelectorAll('.role-btn');
                if (btns[2]) setRole(2, btns[2]);
                closeModal();
            }
        }

        function callAI() {
            const btn = document.getElementById('ai-btn-text');
            const output = document.getElementById('ai-output');
            btn.innerText = "â³ æ­£åœ¨åˆ†æå‰§æœ¬...";
            output.style.display = 'none';
            setTimeout(() => {
                btn.innerText = "âœ¨ åˆ†æå®Œæˆ";
                output.style.display = 'block';
                output.innerHTML = `<strong>ğŸ¤– DeepSeek æ´å¯Ÿï¼š</strong><br>æœ¬å‘¨ã€æ‰“å·¥äººã€‘è§’è‰²å æ¯”è¿‡é«˜ï¼Œå»ºè®®å‘¨æœ«å¢åŠ ã€çˆ±è‡ªå·±ã€‘çš„æ—¶é—´ã€‚`;
            }, 1500);
        }

        async function syncWithServer() {
            currentUserId = document.getElementById('userInput').value || currentUserId;
            try {
                // è¯»å–è¡¨å•æ•°æ®
                review.highlight = document.getElementById('highlight')?.value || '';
                review.ng = document.getElementById('ng')?.value || '';
                review.thinking = document.getElementById('thinking')?.value || '';

                const response = await fetch(`/api/data/${currentUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roles, weekData, curRoleIdx, review })
                });
                if (response.ok) alert('âœ… å·²åŒæ­¥åˆ°æœåŠ¡å™¨ï¼');
                else alert('âŒ åŒæ­¥å¤±è´¥');
            } catch (err) {
                alert('âŒ è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼š' + err.message);
            }
        }

        async function exportAsImage() {
            const element = document.querySelector('.page.active');
            const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#ffffff' });
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = `life-script-${new Date().toISOString().slice(0,10)}.png`;
            link.click();
        }

        init();

        // æ³¨å†Œ Service Workerï¼ˆPWA æ”¯æŒï¼‰
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/service-worker.js')
            .then(reg => console.log('[PWA] Service Worker å·²æ³¨å†Œ'))
            .catch(err => console.log('[PWA] Service Worker æ³¨å†Œå¤±è´¥:', err));
        }
    </script>
</body>
</html>
